<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>myronmars.to/n</title>
  <link href="http://myronmars.to/n/atom.xml" rel="self"/>
  <link href="http://myronmars.to/n"/>
  <updated>2012-03-20T08:38:52-07:00</updated>
  <id>http://myronmars.to/n</id>
  <author>
   <name>Myron Marston</name>
   <email>myron.marston@gmail.com</email>
  </author>

  
  <entry>
    <title>Faster Test Boot Times with Bundler Standalone</title>
    <link href="http://myronmars.to/n/dev-blog/2012/03/faster-test-boot-times-with-bundler-standalone"/>
    <updated>2012-03-20T00:00:00-07:00</updated>
    <id>http://myronmars.to/n/dev-blog/2012/03/faster-test-boot-times-with-bundler-standalone</id>
    <content type="html">&lt;h2 id='tldr'&gt;TL;DR&lt;/h2&gt;

&lt;p&gt;&lt;code&gt;bundle install --standalone&lt;/code&gt; generates a file that allows you to avoid loading bundler at runtime (while still having your load path set up) when booting your test environment. With a fast test suite, this can make a noticeable difference in how long it takes to run.&lt;/p&gt;
&lt;hr /&gt;
&lt;p&gt;I recently started a new project, and inspired by what I&amp;#8217;ve been learning from &lt;a href='https://www.destroyallsoftware.com/'&gt;Destroy All Software&lt;/a&gt;, I want the tests to run as fast as possible. Getting the wall clock times of my test runs down under a second makes me so much more productive!&lt;/p&gt;

&lt;p&gt;One of the keys to achieving this, as people like &lt;a href='http://www.confreaks.com/videos/641-gogaruco2011-fast-rails-tests'&gt;Corey Haines&lt;/a&gt; talk about, is loading as few things as possible. This has an important design benefit&amp;#8211;it forces you to think carefully everytime you couple your code-under-test to a new dependency&amp;#8211;and is essential for achieving fast tests.&lt;/p&gt;

&lt;p&gt;If you use bundler for your project (as you should; it&amp;#8217;s awesome), it&amp;#8217;s an additional thing that you may not have to load when you run your tests. On this project, the tests are fast enough that running the tests through bundler makes a significant, noticeable difference.&lt;/p&gt;

&lt;p&gt;Without &lt;code&gt;bundle exec&lt;/code&gt;:&lt;/p&gt;
&lt;div class='bogus-wrapper'&gt;&lt;notextile&gt;&lt;div class='code-wrap'&gt;&lt;figure class='code'&gt;&lt;figcaption&gt;&lt;span&gt;no_bundler.txt  &lt;/span&gt;&lt;/figcaption&gt;
 &lt;div class='highlight'&gt;&lt;table&gt;&lt;tr&gt;&lt;td class='gutter'&gt;&lt;pre class='line-numbers'&gt;&lt;span class='line-number'&gt;1&lt;/span&gt;
&lt;span class='line-number'&gt;2&lt;/span&gt;
&lt;span class='line-number'&gt;3&lt;/span&gt;
&lt;span class='line-number'&gt;4&lt;/span&gt;
&lt;span class='line-number'&gt;5&lt;/span&gt;
&lt;span class='line-number'&gt;6&lt;/span&gt;
&lt;span class='line-number'&gt;7&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;td class='code'&gt;&lt;pre&gt;&lt;code class='sh'&gt;&lt;span class='line'&gt;➜  &lt;span class='nb'&gt;time &lt;/span&gt;rspec spec/unit/models
&lt;/span&gt;&lt;span class='line'&gt;................................
&lt;/span&gt;&lt;span class='line'&gt;
&lt;/span&gt;&lt;span class='line'&gt;Finished in 0.05011 seconds
&lt;/span&gt;&lt;span class='line'&gt;32 examples, 0 failures
&lt;/span&gt;&lt;span class='line'&gt;
&lt;/span&gt;&lt;span class='line'&gt;rspec spec/unit/models  0.52s user 0.06s system 97% cpu 0.595 total
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/figure&gt;&lt;/div&gt;&lt;/notextile&gt;&lt;/div&gt;
&lt;p&gt;With &lt;code&gt;bundle exec&lt;/code&gt;:&lt;/p&gt;
&lt;div class='bogus-wrapper'&gt;&lt;notextile&gt;&lt;div class='code-wrap'&gt;&lt;figure class='code'&gt;&lt;figcaption&gt;&lt;span&gt;bundler.txt  &lt;/span&gt;&lt;/figcaption&gt;
 &lt;div class='highlight'&gt;&lt;table&gt;&lt;tr&gt;&lt;td class='gutter'&gt;&lt;pre class='line-numbers'&gt;&lt;span class='line-number'&gt;1&lt;/span&gt;
&lt;span class='line-number'&gt;2&lt;/span&gt;
&lt;span class='line-number'&gt;3&lt;/span&gt;
&lt;span class='line-number'&gt;4&lt;/span&gt;
&lt;span class='line-number'&gt;5&lt;/span&gt;
&lt;span class='line-number'&gt;6&lt;/span&gt;
&lt;span class='line-number'&gt;7&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;td class='code'&gt;&lt;pre&gt;&lt;code class='sh'&gt;&lt;span class='line'&gt;➜  &lt;span class='nb'&gt;time &lt;/span&gt;bundle &lt;span class='nb'&gt;exec &lt;/span&gt;rspec spec/unit/models
&lt;/span&gt;&lt;span class='line'&gt;................................
&lt;/span&gt;&lt;span class='line'&gt;
&lt;/span&gt;&lt;span class='line'&gt;Finished in 0.05819 seconds
&lt;/span&gt;&lt;span class='line'&gt;32 examples, 0 failures
&lt;/span&gt;&lt;span class='line'&gt;
&lt;/span&gt;&lt;span class='line'&gt;bundle &lt;span class='nb'&gt;exec &lt;/span&gt;rspec spec/unit/models  1.20s user 0.18s system 98% cpu 1.398 total
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/figure&gt;&lt;/div&gt;&lt;/notextile&gt;&lt;/div&gt;
&lt;p&gt;That&amp;#8217;s 0.6 seconds vs. 1.4 seconds&amp;#8211;more than twice as slow to run the tests through &lt;code&gt;bundle exec&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;When I noticed this, I tried running other specs without &lt;code&gt;bundle exec&lt;/code&gt;&amp;#8230;and immediately ran into a problem:&lt;/p&gt;
&lt;div class='bogus-wrapper'&gt;&lt;notextile&gt;&lt;div class='code-wrap'&gt;&lt;figure class='code'&gt;&lt;figcaption&gt;&lt;span&gt;load_error.txt  &lt;/span&gt;&lt;/figcaption&gt;
 &lt;div class='highlight'&gt;&lt;table&gt;&lt;tr&gt;&lt;td class='gutter'&gt;&lt;pre class='line-numbers'&gt;&lt;span class='line-number'&gt;1&lt;/span&gt;
&lt;span class='line-number'&gt;2&lt;/span&gt;
&lt;span class='line-number'&gt;3&lt;/span&gt;
&lt;span class='line-number'&gt;4&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;td class='code'&gt;&lt;pre&gt;&lt;code class='sh'&gt;&lt;span class='line'&gt;➜  rspec spec/unit/apps
&lt;/span&gt;&lt;span class='line'&gt;
&lt;/span&gt;&lt;span class='line'&gt;.../rubygems/custom_require.rb:36:in &lt;span class='sb'&gt;`&lt;/span&gt;require&lt;span class='err'&gt;&amp;#39;&lt;/span&gt;: cannot load such file -- shardonnay &lt;span class='o'&gt;(&lt;/span&gt;LoadError&lt;span class='o'&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;...the full backtrace here...
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/figure&gt;&lt;/div&gt;&lt;/notextile&gt;&lt;/div&gt;
&lt;p&gt;Lame. I had forgotten that I had a few &lt;code&gt;:git&lt;/code&gt; gems in my Gemfile (such as shardonnay, a private gem we&amp;#8217;re actively developing internally). As the &lt;a href='http://gembundler.com/v1.1/git.html'&gt;bundler documentation&lt;/a&gt; states, &lt;code&gt;:git&lt;/code&gt; gems are not available to rubygems. You have to use &lt;code&gt;Bundler.setup&lt;/code&gt; to make them available on the load path. But &lt;code&gt;Bundler.setup&lt;/code&gt; is equivalent to &lt;code&gt;bundle exec&lt;/code&gt;&lt;sup id='fnref:1'&gt;&lt;a href='#fn:1' rel='footnote'&gt;1&lt;/a&gt;&lt;/sup&gt;, and I still wanted to skip it if I could find way.&lt;/p&gt;

&lt;h2 id='the_solution'&gt;The Solution&lt;/h2&gt;

&lt;p&gt;One of my co-workers, Evan Battaglia, suggested there might be a way to make a record of all the load paths that need to be setup (including the paths for &lt;code&gt;:git&lt;/code&gt; gems) and re-use that. I started looking into doing this when I remembered a new bundler 1.1 option I&amp;#8217;ve been meaning to try out: &lt;code&gt;bundle install --standalone&lt;/code&gt;. Running this generates a handy file at &lt;code&gt;bundle/bundler/setup.rb&lt;/code&gt;:&lt;/p&gt;
&lt;div class='bogus-wrapper'&gt;&lt;notextile&gt;&lt;div class='code-wrap'&gt;&lt;figure class='code'&gt;&lt;figcaption&gt;&lt;span&gt;bundle/bundler/setup.rb &lt;/span&gt;&lt;/figcaption&gt;
 &lt;div class='highlight'&gt;&lt;table&gt;&lt;tr&gt;&lt;td class='gutter'&gt;&lt;pre class='line-numbers'&gt;&lt;span class='line-number'&gt;1&lt;/span&gt;
&lt;span class='line-number'&gt;2&lt;/span&gt;
&lt;span class='line-number'&gt;3&lt;/span&gt;
&lt;span class='line-number'&gt;4&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;td class='code'&gt;&lt;pre&gt;&lt;code class='rb'&gt;&lt;span class='line'&gt;&lt;span class='n'&gt;path&lt;/span&gt; &lt;span class='o'&gt;=&lt;/span&gt; &lt;span class='no'&gt;File&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;expand_path&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='s1'&gt;&amp;#39;..&amp;#39;&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='bp'&gt;__FILE__&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;&lt;span class='vg'&gt;$:&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;unshift&lt;/span&gt; &lt;span class='no'&gt;File&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;expand_path&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='s2'&gt;&amp;quot;&lt;/span&gt;&lt;span class='si'&gt;#{&lt;/span&gt;&lt;span class='n'&gt;path&lt;/span&gt;&lt;span class='si'&gt;}&lt;/span&gt;&lt;span class='s2'&gt;/../ruby/1.9.1/gems/rake-0.9.2.2/lib&amp;quot;&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;&lt;span class='vg'&gt;$:&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;unshift&lt;/span&gt; &lt;span class='no'&gt;File&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;expand_path&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='s2'&gt;&amp;quot;&lt;/span&gt;&lt;span class='si'&gt;#{&lt;/span&gt;&lt;span class='n'&gt;path&lt;/span&gt;&lt;span class='si'&gt;}&lt;/span&gt;&lt;span class='s2'&gt;/../ruby/1.9.1/gems/addressable-2.2.7/lib&amp;quot;&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;&lt;span class='vg'&gt;$:&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;unshift&lt;/span&gt; &lt;span class='no'&gt;File&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;expand_path&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='s2'&gt;&amp;quot;&lt;/span&gt;&lt;span class='si'&gt;#{&lt;/span&gt;&lt;span class='n'&gt;path&lt;/span&gt;&lt;span class='si'&gt;}&lt;/span&gt;&lt;span class='s2'&gt;/../ruby/1.9.1/bundler/gems/shardonnay-f2cf0d585593/lib&amp;quot;&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/figure&gt;&lt;/div&gt;&lt;/notextile&gt;&lt;/div&gt;
&lt;p&gt;The real file in my project is much longer, with many more gems, but that should give you the idea. Notice that it sets up the load path both for installed released gems and &lt;code&gt;:git&lt;/code&gt; gems. This makes it perfect for what I want to do.&lt;/p&gt;

&lt;p&gt;To use this, I&amp;#8217;ve git-ignored the &lt;code&gt;bundle&lt;/code&gt; directory (since it contains artifacts generated by bundler) and I have this bit of code that runs at the start of booting my test environment:&lt;/p&gt;
&lt;div class='bogus-wrapper'&gt;&lt;notextile&gt;&lt;div class='code-wrap'&gt;&lt;figure class='code'&gt;&lt;figcaption&gt;&lt;span&gt;setup_load_paths.rb &lt;/span&gt;&lt;/figcaption&gt;
 &lt;div class='highlight'&gt;&lt;table&gt;&lt;tr&gt;&lt;td class='gutter'&gt;&lt;pre class='line-numbers'&gt;&lt;span class='line-number'&gt;1&lt;/span&gt;
&lt;span class='line-number'&gt;2&lt;/span&gt;
&lt;span class='line-number'&gt;3&lt;/span&gt;
&lt;span class='line-number'&gt;4&lt;/span&gt;
&lt;span class='line-number'&gt;5&lt;/span&gt;
&lt;span class='line-number'&gt;6&lt;/span&gt;
&lt;span class='line-number'&gt;7&lt;/span&gt;
&lt;span class='line-number'&gt;8&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;td class='code'&gt;&lt;pre&gt;&lt;code class='rb'&gt;&lt;span class='line'&gt;&lt;span class='k'&gt;begin&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='c1'&gt;# use `bundle install --standalone&amp;#39; to get this...&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='n'&gt;require_relative&lt;/span&gt; &lt;span class='s1'&gt;&amp;#39;../bundle/bundler/setup&amp;#39;&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;&lt;span class='k'&gt;rescue&lt;/span&gt; &lt;span class='no'&gt;LoadError&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='c1'&gt;# fall back to regular bundler if the developer hasn&amp;#39;t bundled standalone&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='nb'&gt;require&lt;/span&gt; &lt;span class='s1'&gt;&amp;#39;bundler&amp;#39;&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='no'&gt;Bundler&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;setup&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;&lt;span class='k'&gt;end&lt;/span&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/figure&gt;&lt;/div&gt;&lt;/notextile&gt;&lt;/div&gt;
&lt;p&gt;With this in place, I&amp;#8217;m able to run my specs without &lt;code&gt;bundle exec&lt;/code&gt;, with no slowdown from bundler at runtime (since bundler isn&amp;#8217;t even being loaded at runtime!).&lt;/p&gt;

&lt;h2 id='caveats'&gt;Caveats&lt;/h2&gt;

&lt;p&gt;This is working great for me, and I plan to keep using this strategy, but it does have a few caveats:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;There&amp;#8217;s no guarantee that the right version of rspec will be used (since it is the binary I invoke from my shell, before the load paths get setup). I&amp;#8217;m using an RVM gemset for this project so it&amp;#8217;s not much of an issue.&lt;/li&gt;

&lt;li&gt;Bundler doesn&amp;#8217;t keep any persistent state about the fact that I&amp;#8217;m using &lt;code&gt;--standalone&lt;/code&gt;. If I forget the &lt;code&gt;--standalone&lt;/code&gt; flag the next time I run &lt;code&gt;bundle install&lt;/code&gt;, the generated setup file will not be updated with the new load paths&amp;#8211;which means the wrong version of a gem may be used the next time I run my tests.&lt;/li&gt;

&lt;li&gt;A full &lt;code&gt;Bundler.setup&lt;/code&gt; gives you a sandbox guarantee: the only gems that can be loaded are those that included in the locked bundle. There&amp;#8217;s no such guarantee when using &lt;code&gt;--standalone&lt;/code&gt;. I can install a gem and immediately require it. I&amp;#8217;m not too concerned about this since the normal way I install gems now is via Bundler; plus, our CI server will catch any problems here since it is running &lt;code&gt;bundle install&lt;/code&gt; (with no &lt;code&gt;--standalone&lt;/code&gt;).&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;I&amp;#8217;m certainly willing to live with these tradeoffs in exchange for faster test environment boot times, but you may not be.&lt;/p&gt;
&lt;div class='footnotes'&gt;&lt;hr /&gt;&lt;ol&gt;&lt;li id='fn:1'&gt;
&lt;p&gt;Technically, &lt;code&gt;Bundler.setup&lt;/code&gt; and &lt;code&gt;bundle exec&lt;/code&gt; aren&amp;#8217;t quite equivalent. &lt;code&gt;bundle exec&lt;/code&gt; essentially runs &lt;code&gt;Bundler.setup&lt;/code&gt; before the specified binary (rspec, in this case), ensuring that the version of rspec specified in your &lt;code&gt;Gemfile.lock&lt;/code&gt; is used. Putting &lt;code&gt;Bundler.setup&lt;/code&gt; in a file loaded by your tests (say, &lt;code&gt;spec_helper.rb&lt;/code&gt;) will ensure that all gems loaded after that point are the correct versions, but can&amp;#8217;t make any guarantee about gems that have already been loaded (such as rspec itself).&lt;/p&gt;
&lt;a href='#fnref:1' rev='footnote'&gt;&amp;#8617;&lt;/a&gt;&lt;/li&gt;&lt;/ol&gt;&lt;/div&gt;</content>
  </entry>
  
  <entry>
    <title>Building an Around Hook Using Fibers</title>
    <link href="http://myronmars.to/n/dev-blog/2012/03/building-an-around-hook-using-fibers"/>
    <updated>2012-03-09T00:00:00-08:00</updated>
    <id>http://myronmars.to/n/dev-blog/2012/03/building-an-around-hook-using-fibers</id>
    <content type="html">&lt;p&gt;Ruby 1.9&amp;#8217;s &lt;a href='http://ruby-doc.org/core-1.9.3/Fiber.html'&gt;fibers&lt;/a&gt; have lots of interesting uses. Recently, I realized that they can be used to build an around hook out of separate before and after hooks.&lt;/p&gt;

&lt;p&gt;RSpec provides an &lt;code&gt;around(:each)&lt;/code&gt; hook but has no equivalent &lt;code&gt;around(:all)&lt;/code&gt; hook. Let&amp;#8217;s build one!&lt;/p&gt;

&lt;p&gt;First, we&amp;#8217;ll start with a contrived example. We have some examples in a group that all need to run with a different working directory. Here&amp;#8217;s how we can manage this with the existing &lt;code&gt;before(:all)&lt;/code&gt; and &lt;code&gt;after(:all)&lt;/code&gt; hooks:&lt;/p&gt;
&lt;div class='bogus-wrapper'&gt;&lt;notextile&gt;&lt;div class='code-wrap'&gt;&lt;figure class='code'&gt;&lt;figcaption&gt;&lt;span&gt;chdir_spec.rb &lt;/span&gt;&lt;/figcaption&gt;
 &lt;div class='highlight'&gt;&lt;table&gt;&lt;tr&gt;&lt;td class='gutter'&gt;&lt;pre class='line-numbers'&gt;&lt;span class='line-number'&gt;1&lt;/span&gt;
&lt;span class='line-number'&gt;2&lt;/span&gt;
&lt;span class='line-number'&gt;3&lt;/span&gt;
&lt;span class='line-number'&gt;4&lt;/span&gt;
&lt;span class='line-number'&gt;5&lt;/span&gt;
&lt;span class='line-number'&gt;6&lt;/span&gt;
&lt;span class='line-number'&gt;7&lt;/span&gt;
&lt;span class='line-number'&gt;8&lt;/span&gt;
&lt;span class='line-number'&gt;9&lt;/span&gt;
&lt;span class='line-number'&gt;10&lt;/span&gt;
&lt;span class='line-number'&gt;11&lt;/span&gt;
&lt;span class='line-number'&gt;12&lt;/span&gt;
&lt;span class='line-number'&gt;13&lt;/span&gt;
&lt;span class='line-number'&gt;14&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;td class='code'&gt;&lt;pre&gt;&lt;code class='rb'&gt;&lt;span class='line'&gt;&lt;span class='n'&gt;describe&lt;/span&gt; &lt;span class='s2'&gt;&amp;quot;Changing to the tmp/foo directory&amp;quot;&lt;/span&gt; &lt;span class='k'&gt;do&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='n'&gt;before&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='ss'&gt;:all&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt; &lt;span class='k'&gt;do&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;    &lt;span class='vi'&gt;@orig_dir&lt;/span&gt; &lt;span class='o'&gt;=&lt;/span&gt; &lt;span class='no'&gt;Dir&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;pwd&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;    &lt;span class='no'&gt;Dir&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;chdir&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='s2'&gt;&amp;quot;tmp/foo&amp;quot;&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='k'&gt;end&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='n'&gt;after&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='ss'&gt;:all&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt; &lt;span class='k'&gt;do&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;    &lt;span class='no'&gt;Dir&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;chdir&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='vi'&gt;@orig_dir&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='k'&gt;end&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='n'&gt;it&lt;/span&gt; &lt;span class='s2'&gt;&amp;quot;changes the directory for all examples in this group&amp;quot;&lt;/span&gt; &lt;span class='k'&gt;do&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;    &lt;span class='no'&gt;Dir&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;pwd&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;should&lt;/span&gt; &lt;span class='n'&gt;eq&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='no'&gt;File&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;expand_path&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='s2'&gt;&amp;quot;../tmp/foo&amp;quot;&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='bp'&gt;__FILE__&lt;/span&gt;&lt;span class='p'&gt;))&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='k'&gt;end&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;&lt;span class='k'&gt;end&lt;/span&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/figure&gt;&lt;/div&gt;&lt;/notextile&gt;&lt;/div&gt;
&lt;p&gt;&lt;code&gt;Dir.chdir&lt;/code&gt; has two forms. The form above changes the directory for all subsequent code. The other form takes a block, and changes the directory for the duration of the block. This makes it an idea candidate for an around hook. Here&amp;#8217;s what we&amp;#8217;d like to do instead:&lt;/p&gt;
&lt;div class='bogus-wrapper'&gt;&lt;notextile&gt;&lt;div class='code-wrap'&gt;&lt;figure class='code'&gt;&lt;figcaption&gt;&lt;span&gt;chdir_spec.rb &lt;/span&gt;&lt;/figcaption&gt;
 &lt;div class='highlight'&gt;&lt;table&gt;&lt;tr&gt;&lt;td class='gutter'&gt;&lt;pre class='line-numbers'&gt;&lt;span class='line-number'&gt;1&lt;/span&gt;
&lt;span class='line-number'&gt;2&lt;/span&gt;
&lt;span class='line-number'&gt;3&lt;/span&gt;
&lt;span class='line-number'&gt;4&lt;/span&gt;
&lt;span class='line-number'&gt;5&lt;/span&gt;
&lt;span class='line-number'&gt;6&lt;/span&gt;
&lt;span class='line-number'&gt;7&lt;/span&gt;
&lt;span class='line-number'&gt;8&lt;/span&gt;
&lt;span class='line-number'&gt;9&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;td class='code'&gt;&lt;pre&gt;&lt;code class='rb'&gt;&lt;span class='line'&gt;&lt;span class='n'&gt;describe&lt;/span&gt; &lt;span class='s2'&gt;&amp;quot;Changing to the tmp/foo directory&amp;quot;&lt;/span&gt; &lt;span class='k'&gt;do&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='n'&gt;around&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='ss'&gt;:all&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt; &lt;span class='k'&gt;do&lt;/span&gt; &lt;span class='o'&gt;|&lt;/span&gt;&lt;span class='n'&gt;group&lt;/span&gt;&lt;span class='o'&gt;|&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;    &lt;span class='no'&gt;Dir&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;chdir&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='s2'&gt;&amp;quot;tmp/foo&amp;quot;&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='o'&gt;&amp;amp;&lt;/span&gt;&lt;span class='n'&gt;group&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='k'&gt;end&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='n'&gt;it&lt;/span&gt; &lt;span class='s2'&gt;&amp;quot;changes the directory for all examples in this group&amp;quot;&lt;/span&gt; &lt;span class='k'&gt;do&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;    &lt;span class='no'&gt;Dir&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;pwd&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;should&lt;/span&gt; &lt;span class='n'&gt;eq&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='no'&gt;File&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;expand_path&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='s2'&gt;&amp;quot;../tmp/foo&amp;quot;&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='bp'&gt;__FILE__&lt;/span&gt;&lt;span class='p'&gt;))&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='k'&gt;end&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;&lt;span class='k'&gt;end&lt;/span&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/figure&gt;&lt;/div&gt;&lt;/notextile&gt;&lt;/div&gt;
&lt;p&gt;Conceptually, you can think of a fiber as a thread, but rather than the OS or VM scheduling it, you manually switch back and forth. Unlike with a thread, you don&amp;#8217;t have to worry about race conditions when modifying shared process memory, since all context switches are manual.&lt;/p&gt;

&lt;p&gt;Our around hook needs to have its own sequence of execution that gets interrupted in the middle and then resumed; thus, the entire thing needs to run in its own fiber. Here&amp;#8217;s a first pass at that:&lt;/p&gt;
&lt;div class='bogus-wrapper'&gt;&lt;notextile&gt;&lt;div class='code-wrap'&gt;&lt;figure class='code'&gt;&lt;figcaption&gt;&lt;span&gt;chdir_spec.rb &lt;/span&gt;&lt;/figcaption&gt;
 &lt;div class='highlight'&gt;&lt;table&gt;&lt;tr&gt;&lt;td class='gutter'&gt;&lt;pre class='line-numbers'&gt;&lt;span class='line-number'&gt;1&lt;/span&gt;
&lt;span class='line-number'&gt;2&lt;/span&gt;
&lt;span class='line-number'&gt;3&lt;/span&gt;
&lt;span class='line-number'&gt;4&lt;/span&gt;
&lt;span class='line-number'&gt;5&lt;/span&gt;
&lt;span class='line-number'&gt;6&lt;/span&gt;
&lt;span class='line-number'&gt;7&lt;/span&gt;
&lt;span class='line-number'&gt;8&lt;/span&gt;
&lt;span class='line-number'&gt;9&lt;/span&gt;
&lt;span class='line-number'&gt;10&lt;/span&gt;
&lt;span class='line-number'&gt;11&lt;/span&gt;
&lt;span class='line-number'&gt;12&lt;/span&gt;
&lt;span class='line-number'&gt;13&lt;/span&gt;
&lt;span class='line-number'&gt;14&lt;/span&gt;
&lt;span class='line-number'&gt;15&lt;/span&gt;
&lt;span class='line-number'&gt;16&lt;/span&gt;
&lt;span class='line-number'&gt;17&lt;/span&gt;
&lt;span class='line-number'&gt;18&lt;/span&gt;
&lt;span class='line-number'&gt;19&lt;/span&gt;
&lt;span class='line-number'&gt;20&lt;/span&gt;
&lt;span class='line-number'&gt;21&lt;/span&gt;
&lt;span class='line-number'&gt;22&lt;/span&gt;
&lt;span class='line-number'&gt;23&lt;/span&gt;
&lt;span class='line-number'&gt;24&lt;/span&gt;
&lt;span class='line-number'&gt;25&lt;/span&gt;
&lt;span class='line-number'&gt;26&lt;/span&gt;
&lt;span class='line-number'&gt;27&lt;/span&gt;
&lt;span class='line-number'&gt;28&lt;/span&gt;
&lt;span class='line-number'&gt;29&lt;/span&gt;
&lt;span class='line-number'&gt;30&lt;/span&gt;
&lt;span class='line-number'&gt;31&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;td class='code'&gt;&lt;pre&gt;&lt;code class='rb'&gt;&lt;span class='line'&gt;&lt;span class='nb'&gt;require&lt;/span&gt; &lt;span class='s1'&gt;&amp;#39;fiber&amp;#39;&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;
&lt;/span&gt;&lt;span class='line'&gt;&lt;span class='k'&gt;module&lt;/span&gt; &lt;span class='nn'&gt;AroundAllHook&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='k'&gt;def&lt;/span&gt; &lt;span class='nf'&gt;around&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;scope&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='o'&gt;&amp;amp;&lt;/span&gt;&lt;span class='n'&gt;block&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;    &lt;span class='c1'&gt;# let RSpec handle around(:each) hooks...&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;    &lt;span class='k'&gt;return&lt;/span&gt; &lt;span class='k'&gt;super&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;scope&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='o'&gt;&amp;amp;&lt;/span&gt;&lt;span class='n'&gt;block&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt; &lt;span class='k'&gt;unless&lt;/span&gt; &lt;span class='n'&gt;scope&lt;/span&gt; &lt;span class='o'&gt;==&lt;/span&gt; &lt;span class='ss'&gt;:all&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;
&lt;/span&gt;&lt;span class='line'&gt;    &lt;span class='n'&gt;group&lt;/span&gt; &lt;span class='o'&gt;=&lt;/span&gt; &lt;span class='nb'&gt;self&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;    &lt;span class='n'&gt;fiber&lt;/span&gt; &lt;span class='o'&gt;=&lt;/span&gt; &lt;span class='kp'&gt;nil&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;    &lt;span class='n'&gt;before&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='ss'&gt;:all&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt; &lt;span class='k'&gt;do&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;      &lt;span class='n'&gt;fiber&lt;/span&gt; &lt;span class='o'&gt;=&lt;/span&gt; &lt;span class='no'&gt;Fiber&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;new&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='o'&gt;&amp;amp;&lt;/span&gt;&lt;span class='n'&gt;block&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;      &lt;span class='n'&gt;fiber&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;resume&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;group&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;    &lt;span class='k'&gt;end&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;
&lt;/span&gt;&lt;span class='line'&gt;    &lt;span class='n'&gt;after&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='ss'&gt;:all&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt; &lt;span class='k'&gt;do&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;      &lt;span class='n'&gt;fiber&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;resume&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;    &lt;span class='k'&gt;end&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='k'&gt;end&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;&lt;span class='k'&gt;end&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;
&lt;/span&gt;&lt;span class='line'&gt;&lt;span class='n'&gt;describe&lt;/span&gt; &lt;span class='s2'&gt;&amp;quot;Changing to the tmp/foo directory&amp;quot;&lt;/span&gt; &lt;span class='k'&gt;do&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='kp'&gt;extend&lt;/span&gt; &lt;span class='no'&gt;AroundAllHook&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='n'&gt;around&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='ss'&gt;:all&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt; &lt;span class='k'&gt;do&lt;/span&gt; &lt;span class='o'&gt;|&lt;/span&gt;&lt;span class='n'&gt;group&lt;/span&gt;&lt;span class='o'&gt;|&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;    &lt;span class='no'&gt;Dir&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;chdir&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='s2'&gt;&amp;quot;tmp/foo&amp;quot;&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt; &lt;span class='p'&gt;{&lt;/span&gt; &lt;span class='no'&gt;Fiber&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;yield&lt;/span&gt; &lt;span class='p'&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='k'&gt;end&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='n'&gt;it&lt;/span&gt; &lt;span class='s2'&gt;&amp;quot;changes the directory for all examples in this group&amp;quot;&lt;/span&gt; &lt;span class='k'&gt;do&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;    &lt;span class='no'&gt;Dir&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;pwd&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;should&lt;/span&gt; &lt;span class='n'&gt;eq&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='no'&gt;File&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;expand_path&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='s2'&gt;&amp;quot;../tmp/foo&amp;quot;&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='bp'&gt;__FILE__&lt;/span&gt;&lt;span class='p'&gt;))&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='k'&gt;end&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;&lt;span class='k'&gt;end&lt;/span&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/figure&gt;&lt;/div&gt;&lt;/notextile&gt;&lt;/div&gt;
&lt;p&gt;So how does this work? Taking it line by line:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;code&gt;fiber = nil&lt;/code&gt; creates a local variable. This is important so that the same fiber instance is in scope in both the before hook and the after hook. This is possible because ruby blocks are a kind of &lt;a href='http://en.wikipedia.org/wiki/Closure_(computer_science)'&gt;closure&lt;/a&gt; and thus retain a binding to that variable. It&amp;#8217;s important that we use a local variable here and not an instance variable. The local variable causes the fiber to be shared between just this pair of hooks. If you used an instance variable, it would not work when someone defined multiple &lt;code&gt;around(:all)&lt;/code&gt; hooks in the same group, because the fiber would be shared between multiple before/after pairs. We need one fiber per pair.&lt;/li&gt;

&lt;li&gt;&lt;code&gt;before(:all)&lt;/code&gt; and &lt;code&gt;after(:all)&lt;/code&gt; use the existing RSpec hooks. We can assume they&amp;#8217;ll be available in this context because this module is intended to be extended onto an example group.&lt;/li&gt;

&lt;li&gt;Within the before hook, we create a new fiber: &lt;code&gt;fiber =
Fiber.new(&amp;amp;block)&lt;/code&gt;. The block is passed to the fiber so that it runs entirely within it.&lt;/li&gt;

&lt;li&gt;&lt;code&gt;fiber.resume(group)&lt;/code&gt; starts the fiber, and passes the example group as an argument. That will cause it to be the yielded argument in the block.&lt;/li&gt;

&lt;li&gt;Within the declared &lt;code&gt;around(:all)&lt;/code&gt; hook, we have &lt;code&gt;Dir.chdir(&amp;quot;tmp/foo&amp;quot;)
{ Fiber.yield }&lt;/code&gt;. This changes the directory, then uses &lt;code&gt;Fiber.yield&lt;/code&gt; to return control to the root fiber&lt;sup id='fnref:1'&gt;&lt;a href='#fn:1' rel='footnote'&gt;1&lt;/a&gt;&lt;/sup&gt;. This allows RSpec to do what it normally does immediately after a &lt;code&gt;before(:all)&lt;/code&gt; hook: it runs the examples in the group.&lt;/li&gt;

&lt;li&gt;Once the examples finish, RSpec invokes our &lt;code&gt;after(:all)&lt;/code&gt; hook. In our hook, we simply resume the fiber: &lt;code&gt;fiber.resume&lt;/code&gt;. This returns execution to the point immediately after the &lt;code&gt;Fiber.yield&lt;/code&gt; in the &lt;code&gt;Dir.chdir&lt;/code&gt; block. Thus, it allows the block to complete and &lt;code&gt;Dir.chdir&lt;/code&gt; returns the working directory to its original value when the block completes.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;If you&amp;#8217;re not following what &lt;code&gt;Fiber#resume&lt;/code&gt; and &lt;code&gt;Fiber.yield&lt;/code&gt; do, check out the &lt;a href='http://ruby-doc.org/core-1.9.3/Fiber.html'&gt;fiber ruby docs&lt;/a&gt;. They have a good explanation and a simpler example.&lt;/p&gt;

&lt;p&gt;At this point, we have a working &lt;code&gt;around(:all)&lt;/code&gt; hook, but it&amp;#8217;s a pretty leaky abstraction. The user of this hook has to know to call &lt;code&gt;Fiber.yield&lt;/code&gt; in the middle of his hook; otherwise they&amp;#8217;ll get a &lt;code&gt;FiberError&lt;/code&gt; (&amp;#8220;dead fiber called&amp;#8221;) when RSpec runs the &lt;code&gt;after(:all)&lt;/code&gt; hook.&lt;/p&gt;

&lt;p&gt;Let&amp;#8217;s improve this API. First, we&amp;#8217;ll implement a &lt;code&gt;#run_examples&lt;/code&gt; method that simply delegates to &lt;code&gt;Fiber.yield&lt;/code&gt;:&lt;/p&gt;
&lt;div class='bogus-wrapper'&gt;&lt;notextile&gt;&lt;div class='code-wrap'&gt;&lt;figure class='code'&gt;&lt;figcaption&gt;&lt;span&gt;chdir_spec.rb &lt;/span&gt;&lt;/figcaption&gt;
 &lt;div class='highlight'&gt;&lt;table&gt;&lt;tr&gt;&lt;td class='gutter'&gt;&lt;pre class='line-numbers'&gt;&lt;span class='line-number'&gt;1&lt;/span&gt;
&lt;span class='line-number'&gt;2&lt;/span&gt;
&lt;span class='line-number'&gt;3&lt;/span&gt;
&lt;span class='line-number'&gt;4&lt;/span&gt;
&lt;span class='line-number'&gt;5&lt;/span&gt;
&lt;span class='line-number'&gt;6&lt;/span&gt;
&lt;span class='line-number'&gt;7&lt;/span&gt;
&lt;span class='line-number'&gt;8&lt;/span&gt;
&lt;span class='line-number'&gt;9&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;td class='code'&gt;&lt;pre&gt;&lt;code class='rb'&gt;&lt;span class='line'&gt;&lt;span class='nb'&gt;require&lt;/span&gt; &lt;span class='s1'&gt;&amp;#39;delegate&amp;#39;&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;
&lt;/span&gt;&lt;span class='line'&gt;&lt;span class='k'&gt;module&lt;/span&gt; &lt;span class='nn'&gt;AroundAllHook&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='k'&gt;class&lt;/span&gt; &lt;span class='nc'&gt;FiberAwareGroup&lt;/span&gt; &lt;span class='o'&gt;&amp;lt;&lt;/span&gt; &lt;span class='no'&gt;SimpleDelegator&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;    &lt;span class='k'&gt;def&lt;/span&gt; &lt;span class='nf'&gt;run_examples&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;      &lt;span class='no'&gt;Fiber&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;yield&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;    &lt;span class='k'&gt;end&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='k'&gt;end&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;&lt;span class='k'&gt;end&lt;/span&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/figure&gt;&lt;/div&gt;&lt;/notextile&gt;&lt;/div&gt;
&lt;p&gt;Now we can pass a &lt;code&gt;FiberAwareGroup&lt;/code&gt; instance to &lt;code&gt;fiber.resume&lt;/code&gt;:&lt;/p&gt;
&lt;div class='bogus-wrapper'&gt;&lt;notextile&gt;&lt;div class='code-wrap'&gt;&lt;figure class='code'&gt;&lt;figcaption&gt;&lt;span&gt;chdir_spec.rb &lt;/span&gt;&lt;/figcaption&gt;
 &lt;div class='highlight'&gt;&lt;table&gt;&lt;tr&gt;&lt;td class='gutter'&gt;&lt;pre class='line-numbers'&gt;&lt;span class='line-number'&gt;1&lt;/span&gt;
&lt;span class='line-number'&gt;2&lt;/span&gt;
&lt;span class='line-number'&gt;3&lt;/span&gt;
&lt;span class='line-number'&gt;4&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;td class='code'&gt;&lt;pre&gt;&lt;code class='rb'&gt;&lt;span class='line'&gt;&lt;span class='n'&gt;before&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='ss'&gt;:all&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt; &lt;span class='k'&gt;do&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='n'&gt;fiber&lt;/span&gt; &lt;span class='o'&gt;=&lt;/span&gt; &lt;span class='no'&gt;Fiber&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;new&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='o'&gt;&amp;amp;&lt;/span&gt;&lt;span class='n'&gt;block&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='n'&gt;fiber&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;resume&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='no'&gt;FiberAwareGroup&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;new&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;group&lt;/span&gt;&lt;span class='p'&gt;))&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;&lt;span class='k'&gt;end&lt;/span&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/figure&gt;&lt;/div&gt;&lt;/notextile&gt;&lt;/div&gt;
&lt;p&gt;Finally, we can use this in the &lt;code&gt;around(:all)&lt;/code&gt; hook:&lt;/p&gt;
&lt;div class='bogus-wrapper'&gt;&lt;notextile&gt;&lt;div class='code-wrap'&gt;&lt;figure class='code'&gt;&lt;figcaption&gt;&lt;span&gt;chdir_spec.rb &lt;/span&gt;&lt;/figcaption&gt;
 &lt;div class='highlight'&gt;&lt;table&gt;&lt;tr&gt;&lt;td class='gutter'&gt;&lt;pre class='line-numbers'&gt;&lt;span class='line-number'&gt;1&lt;/span&gt;
&lt;span class='line-number'&gt;2&lt;/span&gt;
&lt;span class='line-number'&gt;3&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;td class='code'&gt;&lt;pre&gt;&lt;code class='rb'&gt;&lt;span class='line'&gt;&lt;span class='n'&gt;around&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='ss'&gt;:all&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt; &lt;span class='k'&gt;do&lt;/span&gt; &lt;span class='o'&gt;|&lt;/span&gt;&lt;span class='n'&gt;group&lt;/span&gt;&lt;span class='o'&gt;|&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='no'&gt;Dir&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;chdir&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='s2'&gt;&amp;quot;tmp/foo&amp;quot;&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt; &lt;span class='p'&gt;{&lt;/span&gt; &lt;span class='n'&gt;group&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;run_examples&lt;/span&gt; &lt;span class='p'&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;&lt;span class='k'&gt;end&lt;/span&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/figure&gt;&lt;/div&gt;&lt;/notextile&gt;&lt;/div&gt;
&lt;p&gt;Note that we could have defined &lt;code&gt;run_examples&lt;/code&gt; as a singleton method on &lt;code&gt;group&lt;/code&gt;, or defined the method in a module that we extend onto &lt;code&gt;group&lt;/code&gt;, but I prefer delegation for cases like these. Both of the other techniques permanently modify the object and thus leak the &lt;code&gt;#run_examples&lt;/code&gt; method into other contexts where it no longer makes sense.&lt;/p&gt;

&lt;p&gt;This is an improvement from requiring users to call &lt;code&gt;Fiber.yield&lt;/code&gt;, but we can take it a step further. We&amp;#8217;d like to be able to treat the yielded group as a proc, like so:&lt;/p&gt;
&lt;div class='bogus-wrapper'&gt;&lt;notextile&gt;&lt;div class='code-wrap'&gt;&lt;figure class='code'&gt;&lt;figcaption&gt;&lt;span&gt;chdir_spec.rb &lt;/span&gt;&lt;/figcaption&gt;
 &lt;div class='highlight'&gt;&lt;table&gt;&lt;tr&gt;&lt;td class='gutter'&gt;&lt;pre class='line-numbers'&gt;&lt;span class='line-number'&gt;1&lt;/span&gt;
&lt;span class='line-number'&gt;2&lt;/span&gt;
&lt;span class='line-number'&gt;3&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;td class='code'&gt;&lt;pre&gt;&lt;code class='rb'&gt;&lt;span class='line'&gt;&lt;span class='n'&gt;around&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='ss'&gt;:all&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt; &lt;span class='k'&gt;do&lt;/span&gt; &lt;span class='o'&gt;|&lt;/span&gt;&lt;span class='n'&gt;group&lt;/span&gt;&lt;span class='o'&gt;|&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='no'&gt;Dir&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;chdir&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='s2'&gt;&amp;quot;tmp/foo&amp;quot;&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='o'&gt;&amp;amp;&lt;/span&gt;&lt;span class='n'&gt;group&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;&lt;span class='k'&gt;end&lt;/span&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/figure&gt;&lt;/div&gt;&lt;/notextile&gt;&lt;/div&gt;
&lt;p&gt;We simply need to define an appropriate &lt;code&gt;#to_proc&lt;/code&gt;:&lt;/p&gt;
&lt;div class='bogus-wrapper'&gt;&lt;notextile&gt;&lt;div class='code-wrap'&gt;&lt;figure class='code'&gt;&lt;figcaption&gt;&lt;span&gt;chdir_spec.rb &lt;/span&gt;&lt;/figcaption&gt;
 &lt;div class='highlight'&gt;&lt;table&gt;&lt;tr&gt;&lt;td class='gutter'&gt;&lt;pre class='line-numbers'&gt;&lt;span class='line-number'&gt;1&lt;/span&gt;
&lt;span class='line-number'&gt;2&lt;/span&gt;
&lt;span class='line-number'&gt;3&lt;/span&gt;
&lt;span class='line-number'&gt;4&lt;/span&gt;
&lt;span class='line-number'&gt;5&lt;/span&gt;
&lt;span class='line-number'&gt;6&lt;/span&gt;
&lt;span class='line-number'&gt;7&lt;/span&gt;
&lt;span class='line-number'&gt;8&lt;/span&gt;
&lt;span class='line-number'&gt;9&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;td class='code'&gt;&lt;pre&gt;&lt;code class='rb'&gt;&lt;span class='line'&gt;&lt;span class='k'&gt;class&lt;/span&gt; &lt;span class='nc'&gt;FiberAwareGroup&lt;/span&gt; &lt;span class='o'&gt;&amp;lt;&lt;/span&gt; &lt;span class='no'&gt;SimpleDelegator&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='k'&gt;def&lt;/span&gt; &lt;span class='nf'&gt;run_examples&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;    &lt;span class='no'&gt;Fiber&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;yield&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='k'&gt;end&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='k'&gt;def&lt;/span&gt; &lt;span class='nf'&gt;to_proc&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;    &lt;span class='nb'&gt;proc&lt;/span&gt; &lt;span class='p'&gt;{&lt;/span&gt; &lt;span class='n'&gt;run_examples&lt;/span&gt; &lt;span class='p'&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='k'&gt;end&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;&lt;span class='k'&gt;end&lt;/span&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/figure&gt;&lt;/div&gt;&lt;/notextile&gt;&lt;/div&gt;
&lt;p&gt;To see the final code, check out the little &lt;a href='https://gist.github.com/2005175'&gt;microgem&lt;/a&gt; I put together.&lt;/p&gt;
&lt;div class='footnotes'&gt;&lt;hr /&gt;&lt;ol&gt;&lt;li id='fn:1'&gt;
&lt;p&gt;I was going use the term &amp;#8220;main fiber&amp;#8221; instead (since &amp;#8220;main thread&amp;#8221; is a standard term), but the &lt;a href='http://ruby-doc.org/core-1.9.3/Fiber.html#method-c-current'&gt;ruby docs&lt;/a&gt; use the term &amp;#8220;root fiber&amp;#8221; so I figured I would too :).&lt;/p&gt;
&lt;a href='#fnref:1' rev='footnote'&gt;&amp;#8617;&lt;/a&gt;&lt;/li&gt;&lt;/ol&gt;&lt;/div&gt;</content>
  </entry>
  
  <entry>
    <title>VCR 2.0.0 Released!</title>
    <link href="http://myronmars.to/n/dev-blog/2012/03/vcr-2-0-0-released"/>
    <updated>2012-03-02T00:00:00-08:00</updated>
    <id>http://myronmars.to/n/dev-blog/2012/03/vcr-2-0-0-released</id>
    <content type="html">&lt;p&gt;I&amp;#8217;ve just released VCR 2.0.0 final. This marks the culmination of 6 months of work, and involved re-writing large portions of VCR.&lt;/p&gt;

&lt;p&gt;VCR 2 is far more flexible than VCR 1.x ever was. The &lt;a href='https://github.com/myronmarston/vcr/blob/v2.0.0/Upgrade.md'&gt;Upgrade&lt;/a&gt; doc has a high-level listing of most of the new features. I&amp;#8217;ve also blogged about the new stuff:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href='/n/dev-blog/2011/10/custom-request-matchers-in-vcr-2-0'&gt;Custom Request Matchers in VCR 2.0&lt;/a&gt;&lt;/li&gt;

&lt;li&gt;&lt;a href='/n/dev-blog/2011/11/cassettes-in-vcr-2-0'&gt;Cassettes in VCR 2.0&lt;/a&gt;&lt;/li&gt;

&lt;li&gt;&lt;a href='/n/dev-blog/2011/12/vcr-2-0-0-rc-released'&gt;VCR 2.0.0 RC Released!&lt;/a&gt;&lt;/li&gt;

&lt;li&gt;&lt;a href='/n/dev-blog/2012/02/vcr-2-0-0-rc2-released'&gt;VCR 2.0.0 RC2 Released!&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id='thanks'&gt;Thanks!&lt;/h2&gt;

&lt;p&gt;I couldn&amp;#8217;t have developed VCR 2 on my own. Thanks to:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;David Balatero, for help with Typhoeus integration.&lt;/p&gt;
&lt;/li&gt;

&lt;li&gt;
&lt;p&gt;Bartosz Blimke, for help with WebMock integration.&lt;/p&gt;
&lt;/li&gt;

&lt;li&gt;
&lt;p&gt;Wesley Beary, for help with Excon integration.&lt;/p&gt;
&lt;/li&gt;

&lt;li&gt;
&lt;p&gt;Ryan Bates, for the great idea to improve VCR&amp;#8217;s integration with RSpec using metadata RSpec metadata.&lt;/p&gt;
&lt;/li&gt;

&lt;li&gt;
&lt;p&gt;Loren Segal, for patiently answering all my noob YARD questions.&lt;/p&gt;
&lt;/li&gt;

&lt;li&gt;
&lt;p&gt;Jeff Pollard, for reviewing code and giving great feedback.&lt;/p&gt;
&lt;/li&gt;

&lt;li&gt;
&lt;p&gt;Avdi Grimm, for several ideas for new features.&lt;/p&gt;
&lt;/li&gt;

&lt;li&gt;
&lt;p&gt;Everyone who submitted patches for VCR: 2.0:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;Benjamin Oakes&lt;/li&gt;

&lt;li&gt;Flaviu Simihaian&lt;/li&gt;

&lt;li&gt;Michael Lavrisha&lt;/li&gt;

&lt;li&gt;Paco Guzmán&lt;/li&gt;

&lt;li&gt;Ryan Bates&lt;/li&gt;

&lt;li&gt;Sathya Sekaran&lt;/li&gt;

&lt;li&gt;Carlos Kirkconnell&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;

&lt;li&gt;
&lt;p&gt;The Travis CI crew. Travis has made it so easy to keep VCR&amp;#8217;s tests passing against multiple ruby interpreters!&lt;/p&gt;
&lt;/li&gt;

&lt;li&gt;
&lt;p&gt;Everyone who tried one of the VCR 2.0 preleases and gave me feedback.&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;</content>
  </entry>
  
  <entry>
    <title>VCR 2.0.0 RC2 Released!</title>
    <link href="http://myronmars.to/n/dev-blog/2012/02/vcr-2-0-0-rc2-released"/>
    <updated>2012-02-24T00:00:00-08:00</updated>
    <id>http://myronmars.to/n/dev-blog/2012/02/vcr-2-0-0-rc2-released</id>
    <content type="html">&lt;p&gt;I&amp;#8217;ve just released VCR 2.0.0.rc2. This is (hopefully) the last stop before the final 2.0.0 relesae. If there are no major issues, I plan to release 2.0.0 next week some time. Please give 2.0.0.rc2 a try with your test suite!&lt;/p&gt;

&lt;p&gt;On to what&amp;#8217;s been changed since RC1&amp;#8230;&lt;/p&gt;

&lt;h2 id='yard_api_docs'&gt;Yard API Docs&lt;/h2&gt;

&lt;p&gt;VCR has used its cucumber suite, hosted on &lt;a href='http://relishapp.com/myronmarston/vcr'&gt;relish&lt;/a&gt;, as documentation for a good year or so. I&amp;#8217;ve received many positive comments about the docs, and how useful all the executable examples are.&lt;/p&gt;

&lt;p&gt;The relish docs are great at demonstrating each high-level feature through an exectuble example, but they&amp;#8217;re not so great at documenting the interface for particular objects. VCR now has many hooks, and it&amp;#8217;s hard to document the full interface of the objects yielded to those hooks on relish.&lt;/p&gt;

&lt;p&gt;So, with the help of &lt;a href='http://www.benjaminoakes.com/'&gt;Benjamin Oakes&lt;/a&gt; (and many patient answers to my questions from &lt;a href='http://gnuu.org/'&gt;Loren Segal&lt;/a&gt;), VCR now has proper &lt;a href='http://rubydoc.info/github/myronmarston/vcr/frames'&gt;YARD API docs&lt;/a&gt;.&lt;/p&gt;

&lt;h2 id='hook_filters'&gt;Hook Filters&lt;/h2&gt;

&lt;p&gt;The &lt;code&gt;before_http_request&lt;/code&gt;, &lt;code&gt;after_http_request&lt;/code&gt;, and &lt;code&gt;around_http_request&lt;/code&gt; hooks all now accept zero or more filters as an argument. &amp;#8220;Filters&amp;#8221; are simply objects that respond to &lt;code&gt;#to_proc&lt;/code&gt;. Before invoking the hook, VCR will call the filter procs, and only continue invoking the hook if all of the filter procs return a truthy value.&lt;/p&gt;

&lt;p&gt;On top of that, the request object has gained some additional predicate methods in the context of these hooks: &lt;code&gt;#real?&lt;/code&gt;, &lt;code&gt;#ignored?&lt;/code&gt;, &lt;code&gt;#stubbed?&lt;/code&gt;, &lt;code&gt;#recordable?&lt;/code&gt; and &lt;code&gt;#unhandled?&lt;/code&gt;. You can use these in a hook to conditionally run logic for only certain types of requests. For example, to do something before all real requests:&lt;/p&gt;
&lt;div class='bogus-wrapper'&gt;&lt;notextile&gt;&lt;div class='code-wrap'&gt;&lt;figure class='code'&gt;&lt;figcaption&gt;&lt;span&gt;request_hook.rb &lt;/span&gt;&lt;/figcaption&gt;
 &lt;div class='highlight'&gt;&lt;table&gt;&lt;tr&gt;&lt;td class='gutter'&gt;&lt;pre class='line-numbers'&gt;&lt;span class='line-number'&gt;1&lt;/span&gt;
&lt;span class='line-number'&gt;2&lt;/span&gt;
&lt;span class='line-number'&gt;3&lt;/span&gt;
&lt;span class='line-number'&gt;4&lt;/span&gt;
&lt;span class='line-number'&gt;5&lt;/span&gt;
&lt;span class='line-number'&gt;6&lt;/span&gt;
&lt;span class='line-number'&gt;7&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;td class='code'&gt;&lt;pre&gt;&lt;code class='rb'&gt;&lt;span class='line'&gt;&lt;span class='no'&gt;VCR&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;configure&lt;/span&gt; &lt;span class='k'&gt;do&lt;/span&gt; &lt;span class='o'&gt;|&lt;/span&gt;&lt;span class='n'&gt;c&lt;/span&gt;&lt;span class='o'&gt;|&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='n'&gt;c&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;before_http_request&lt;/span&gt; &lt;span class='k'&gt;do&lt;/span&gt; &lt;span class='o'&gt;|&lt;/span&gt;&lt;span class='n'&gt;request&lt;/span&gt;&lt;span class='o'&gt;|&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;    &lt;span class='k'&gt;if&lt;/span&gt; &lt;span class='n'&gt;request&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;real?&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;      &lt;span class='n'&gt;do_something_with&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;request&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;    &lt;span class='k'&gt;end&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='k'&gt;end&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;&lt;span class='k'&gt;end&lt;/span&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/figure&gt;&lt;/div&gt;&lt;/notextile&gt;&lt;/div&gt;
&lt;p&gt;Or, if you prefer (and I certainly do!), using a filter:&lt;/p&gt;
&lt;div class='bogus-wrapper'&gt;&lt;notextile&gt;&lt;div class='code-wrap'&gt;&lt;figure class='code'&gt;&lt;figcaption&gt;&lt;span&gt;request_hook.rb &lt;/span&gt;&lt;/figcaption&gt;
 &lt;div class='highlight'&gt;&lt;table&gt;&lt;tr&gt;&lt;td class='gutter'&gt;&lt;pre class='line-numbers'&gt;&lt;span class='line-number'&gt;1&lt;/span&gt;
&lt;span class='line-number'&gt;2&lt;/span&gt;
&lt;span class='line-number'&gt;3&lt;/span&gt;
&lt;span class='line-number'&gt;4&lt;/span&gt;
&lt;span class='line-number'&gt;5&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;td class='code'&gt;&lt;pre&gt;&lt;code class='rb'&gt;&lt;span class='line'&gt;&lt;span class='no'&gt;VCR&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;configure&lt;/span&gt; &lt;span class='k'&gt;do&lt;/span&gt; &lt;span class='o'&gt;|&lt;/span&gt;&lt;span class='n'&gt;c&lt;/span&gt;&lt;span class='o'&gt;|&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='n'&gt;c&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;before_http_request&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='ss'&gt;:real?&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt; &lt;span class='k'&gt;do&lt;/span&gt; &lt;span class='o'&gt;|&lt;/span&gt;&lt;span class='n'&gt;request&lt;/span&gt;&lt;span class='o'&gt;|&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;    &lt;span class='n'&gt;do_something_with&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;request&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='k'&gt;end&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;&lt;span class='k'&gt;end&lt;/span&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/figure&gt;&lt;/div&gt;&lt;/notextile&gt;&lt;/div&gt;
&lt;p&gt;This feature is also quite useful when used in conjunction with an &lt;code&gt;around_http_request&lt;/code&gt; hook to globally handle requests to a particular host. Here&amp;#8217;s the code example I put in the &lt;a href='/n/dev-blog/2011/12/vcr-2-0-0-rc-released'&gt;2.0.0 RC1 release announcement&lt;/a&gt;:&lt;/p&gt;
&lt;div class='bogus-wrapper'&gt;&lt;notextile&gt;&lt;div class='code-wrap'&gt;&lt;figure class='code'&gt;&lt;figcaption&gt;&lt;span&gt;handle_geocoding_requests.rb &lt;/span&gt;&lt;/figcaption&gt;
 &lt;div class='highlight'&gt;&lt;table&gt;&lt;tr&gt;&lt;td class='gutter'&gt;&lt;pre class='line-numbers'&gt;&lt;span class='line-number'&gt;1&lt;/span&gt;
&lt;span class='line-number'&gt;2&lt;/span&gt;
&lt;span class='line-number'&gt;3&lt;/span&gt;
&lt;span class='line-number'&gt;4&lt;/span&gt;
&lt;span class='line-number'&gt;5&lt;/span&gt;
&lt;span class='line-number'&gt;6&lt;/span&gt;
&lt;span class='line-number'&gt;7&lt;/span&gt;
&lt;span class='line-number'&gt;8&lt;/span&gt;
&lt;span class='line-number'&gt;9&lt;/span&gt;
&lt;span class='line-number'&gt;10&lt;/span&gt;
&lt;span class='line-number'&gt;11&lt;/span&gt;
&lt;span class='line-number'&gt;12&lt;/span&gt;
&lt;span class='line-number'&gt;13&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;td class='code'&gt;&lt;pre&gt;&lt;code class='rb'&gt;&lt;span class='line'&gt;&lt;span class='no'&gt;VCR&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;configure&lt;/span&gt; &lt;span class='k'&gt;do&lt;/span&gt; &lt;span class='o'&gt;|&lt;/span&gt;&lt;span class='n'&gt;c&lt;/span&gt;&lt;span class='o'&gt;|&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='n'&gt;c&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;around_http_request&lt;/span&gt; &lt;span class='k'&gt;do&lt;/span&gt; &lt;span class='o'&gt;|&lt;/span&gt;&lt;span class='n'&gt;request&lt;/span&gt;&lt;span class='o'&gt;|&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;    &lt;span class='n'&gt;uri&lt;/span&gt; &lt;span class='o'&gt;=&lt;/span&gt; &lt;span class='no'&gt;URI&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;request&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;uri&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;    &lt;span class='k'&gt;if&lt;/span&gt; &lt;span class='n'&gt;uri&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;host&lt;/span&gt; &lt;span class='o'&gt;==&lt;/span&gt; &lt;span class='s1'&gt;&amp;#39;api.geocoder.com&amp;#39;&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;      &lt;span class='c1'&gt;# extract an address like &amp;quot;1700 E Pine St, Seattle, WA&amp;quot;&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;      &lt;span class='c1'&gt;# from a query like &amp;quot;address=1700+E+Pine+St%2C+Seattle%2C+WA&amp;quot;&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;      &lt;span class='n'&gt;address&lt;/span&gt; &lt;span class='o'&gt;=&lt;/span&gt; &lt;span class='no'&gt;CGI&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;unescape&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;uri&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;query&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;split&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='s1'&gt;&amp;#39;=&amp;#39;&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;last&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;      &lt;span class='no'&gt;VCR&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;use_cassette&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='s2'&gt;&amp;quot;geocoding/&lt;/span&gt;&lt;span class='si'&gt;#{&lt;/span&gt;&lt;span class='n'&gt;address&lt;/span&gt;&lt;span class='si'&gt;}&lt;/span&gt;&lt;span class='s2'&gt;&amp;quot;&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='o'&gt;&amp;amp;&lt;/span&gt;&lt;span class='n'&gt;request&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;    &lt;span class='k'&gt;else&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;      &lt;span class='n'&gt;request&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;proceed&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;    &lt;span class='k'&gt;end&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='k'&gt;end&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;&lt;span class='k'&gt;end&lt;/span&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/figure&gt;&lt;/div&gt;&lt;/notextile&gt;&lt;/div&gt;
&lt;p&gt;Here&amp;#8217;s how you could clean this up a bit with a hook filter:&lt;/p&gt;
&lt;div class='bogus-wrapper'&gt;&lt;notextile&gt;&lt;div class='code-wrap'&gt;&lt;figure class='code'&gt;&lt;figcaption&gt;&lt;span&gt;handle_geocoding_requests.rb &lt;/span&gt;&lt;/figcaption&gt;
 &lt;div class='highlight'&gt;&lt;table&gt;&lt;tr&gt;&lt;td class='gutter'&gt;&lt;pre class='line-numbers'&gt;&lt;span class='line-number'&gt;1&lt;/span&gt;
&lt;span class='line-number'&gt;2&lt;/span&gt;
&lt;span class='line-number'&gt;3&lt;/span&gt;
&lt;span class='line-number'&gt;4&lt;/span&gt;
&lt;span class='line-number'&gt;5&lt;/span&gt;
&lt;span class='line-number'&gt;6&lt;/span&gt;
&lt;span class='line-number'&gt;7&lt;/span&gt;
&lt;span class='line-number'&gt;8&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;td class='code'&gt;&lt;pre&gt;&lt;code class='rb'&gt;&lt;span class='line'&gt;&lt;span class='no'&gt;VCR&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;configure&lt;/span&gt; &lt;span class='k'&gt;do&lt;/span&gt; &lt;span class='o'&gt;|&lt;/span&gt;&lt;span class='n'&gt;c&lt;/span&gt;&lt;span class='o'&gt;|&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='n'&gt;c&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;around_http_request&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='nb'&gt;lambda&lt;/span&gt; &lt;span class='p'&gt;{&lt;/span&gt; &lt;span class='o'&gt;|&lt;/span&gt;&lt;span class='n'&gt;r&lt;/span&gt;&lt;span class='o'&gt;|&lt;/span&gt; &lt;span class='n'&gt;r&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;uri&lt;/span&gt; &lt;span class='o'&gt;=~&lt;/span&gt; &lt;span class='sr'&gt;/api.geocoder.com/&lt;/span&gt; &lt;span class='p'&gt;})&lt;/span&gt; &lt;span class='k'&gt;do&lt;/span&gt; &lt;span class='o'&gt;|&lt;/span&gt;&lt;span class='n'&gt;request&lt;/span&gt;&lt;span class='o'&gt;|&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;    &lt;span class='c1'&gt;# extract an address like &amp;quot;1700 E Pine St, Seattle, WA&amp;quot;&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;    &lt;span class='c1'&gt;# from a query like &amp;quot;address=1700+E+Pine+St%2C+Seattle%2C+WA&amp;quot;&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;    &lt;span class='n'&gt;address&lt;/span&gt; &lt;span class='o'&gt;=&lt;/span&gt; &lt;span class='no'&gt;CGI&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;unescape&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='no'&gt;URI&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;request&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;uri&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;query&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;split&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='s1'&gt;&amp;#39;=&amp;#39;&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;last&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;    &lt;span class='no'&gt;VCR&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;use_cassette&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='s2'&gt;&amp;quot;geocoding/&lt;/span&gt;&lt;span class='si'&gt;#{&lt;/span&gt;&lt;span class='n'&gt;address&lt;/span&gt;&lt;span class='si'&gt;}&lt;/span&gt;&lt;span class='s2'&gt;&amp;quot;&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='o'&gt;&amp;amp;&lt;/span&gt;&lt;span class='n'&gt;request&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='k'&gt;end&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;&lt;span class='k'&gt;end&lt;/span&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/figure&gt;&lt;/div&gt;&lt;/notextile&gt;&lt;/div&gt;
&lt;h2 id='improved_excon_support'&gt;Improved Excon Support&lt;/h2&gt;

&lt;p&gt;VCR has supported Excon for a while, but the integration has &lt;a href='http://groups.google.com/group/ruby-fog/browse_thread/thread/737295ebb42e67d1/df2effe4cceffc68'&gt;had a few issues&lt;/a&gt;. I myself have experienced some of this pain when I tried to use VCR to help test some code that uses Fog to communicate with S3.&lt;/p&gt;

&lt;p&gt;I finally dug in and worked through the issues. There were a couple bugs on the VCR side and one bug in Excon&amp;#8217;s stubbing support. I believe VCR should work seemlessly with any excon request now, including with Fog.&lt;/p&gt;

&lt;h2 id='debug_logging'&gt;Debug Logging&lt;/h2&gt;

&lt;p&gt;Sometimes VCR doesn&amp;#8217;t work the way you would expect, and prior to now, there hasn&amp;#8217;t been a good built-in way to get insight into what VCR was doing. VCR now has a new &lt;code&gt;debug_logger&lt;/code&gt; option. Set it to any object with a &lt;code&gt;puts&lt;/code&gt; method:&lt;/p&gt;
&lt;div class='bogus-wrapper'&gt;&lt;notextile&gt;&lt;div class='code-wrap'&gt;&lt;figure class='code'&gt;&lt;figcaption&gt;&lt;span&gt;debug_logging.rb &lt;/span&gt;&lt;/figcaption&gt;
 &lt;div class='highlight'&gt;&lt;table&gt;&lt;tr&gt;&lt;td class='gutter'&gt;&lt;pre class='line-numbers'&gt;&lt;span class='line-number'&gt;1&lt;/span&gt;
&lt;span class='line-number'&gt;2&lt;/span&gt;
&lt;span class='line-number'&gt;3&lt;/span&gt;
&lt;span class='line-number'&gt;4&lt;/span&gt;
&lt;span class='line-number'&gt;5&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;td class='code'&gt;&lt;pre&gt;&lt;code class='rb'&gt;&lt;span class='line'&gt;&lt;span class='no'&gt;VCR&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;configure&lt;/span&gt; &lt;span class='k'&gt;do&lt;/span&gt; &lt;span class='o'&gt;|&lt;/span&gt;&lt;span class='n'&gt;c&lt;/span&gt;&lt;span class='o'&gt;|&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='n'&gt;c&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;debug_logger&lt;/span&gt; &lt;span class='o'&gt;=&lt;/span&gt; &lt;span class='vg'&gt;$stdout&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='c1'&gt;# or&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='n'&gt;c&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;debug_logger&lt;/span&gt; &lt;span class='o'&gt;=&lt;/span&gt; &lt;span class='no'&gt;File&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;open&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='s1'&gt;&amp;#39;log/vcr.log&amp;#39;&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;&lt;span class='k'&gt;end&lt;/span&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/figure&gt;&lt;/div&gt;&lt;/notextile&gt;&lt;/div&gt;
&lt;h2 id='new__option'&gt;New &lt;code&gt;preserve_exact_body_bytes&lt;/code&gt; option&lt;/h2&gt;

&lt;p&gt;Some HTTP servers are not well-behaved and respond with invalid data: the response body may not be encoded according to the encoding specified in the HTTP headers, or there may be bytes that are invalid for the given encoding. The YAML and JSON serializers are not generally designed to handle these cases gracefully, and you may get errors when the cassette is serialized or deserialized. Also, the encoding may not be preserved when round-tripped through the serializer.&lt;/p&gt;

&lt;p&gt;VCR now has a a &lt;code&gt;preserve_exact_body_bytes&lt;/code&gt; option to help deal with cases like these. You can set it globally:&lt;/p&gt;
&lt;div class='bogus-wrapper'&gt;&lt;notextile&gt;&lt;div class='code-wrap'&gt;&lt;figure class='code'&gt;&lt;figcaption&gt;&lt;span&gt;preserve_exact_body_bytes.rb &lt;/span&gt;&lt;/figcaption&gt;
 &lt;div class='highlight'&gt;&lt;table&gt;&lt;tr&gt;&lt;td class='gutter'&gt;&lt;pre class='line-numbers'&gt;&lt;span class='line-number'&gt;1&lt;/span&gt;
&lt;span class='line-number'&gt;2&lt;/span&gt;
&lt;span class='line-number'&gt;3&lt;/span&gt;
&lt;span class='line-number'&gt;4&lt;/span&gt;
&lt;span class='line-number'&gt;5&lt;/span&gt;
&lt;span class='line-number'&gt;6&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;td class='code'&gt;&lt;pre&gt;&lt;code class='rb'&gt;&lt;span class='line'&gt;&lt;span class='no'&gt;VCR&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;configure&lt;/span&gt; &lt;span class='k'&gt;do&lt;/span&gt; &lt;span class='o'&gt;|&lt;/span&gt;&lt;span class='n'&gt;c&lt;/span&gt;&lt;span class='o'&gt;|&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='n'&gt;c&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;preserve_exact_body_bytes&lt;/span&gt; &lt;span class='k'&gt;do&lt;/span&gt; &lt;span class='o'&gt;|&lt;/span&gt;&lt;span class='n'&gt;http_message&lt;/span&gt;&lt;span class='o'&gt;|&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;    &lt;span class='n'&gt;http_message&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;body&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;encoding&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;name&lt;/span&gt; &lt;span class='o'&gt;==&lt;/span&gt; &lt;span class='s1'&gt;&amp;#39;ASCII-8BIT&amp;#39;&lt;/span&gt; &lt;span class='o'&gt;||&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;    &lt;span class='o'&gt;!&lt;/span&gt;&lt;span class='n'&gt;http_message&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;body&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;valid_encoding?&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='k'&gt;end&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;&lt;span class='k'&gt;end&lt;/span&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/figure&gt;&lt;/div&gt;&lt;/notextile&gt;&lt;/div&gt;
&lt;p&gt;&amp;#8230;or you can force the option for a particular cassette:&lt;/p&gt;
&lt;div class='bogus-wrapper'&gt;&lt;notextile&gt;&lt;div class='code-wrap'&gt;&lt;figure class='code'&gt;&lt;figcaption&gt;&lt;span&gt;preserve_exact_body_bytes.rb &lt;/span&gt;&lt;/figcaption&gt;
 &lt;div class='highlight'&gt;&lt;table&gt;&lt;tr&gt;&lt;td class='gutter'&gt;&lt;pre class='line-numbers'&gt;&lt;span class='line-number'&gt;1&lt;/span&gt;
&lt;span class='line-number'&gt;2&lt;/span&gt;
&lt;span class='line-number'&gt;3&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;td class='code'&gt;&lt;pre&gt;&lt;code class='rb'&gt;&lt;span class='line'&gt;&lt;span class='no'&gt;VCR&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;use_cassette&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='s2'&gt;&amp;quot;example&amp;quot;&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='ss'&gt;:preserve_exact_body_bytes&lt;/span&gt; &lt;span class='o'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='kp'&gt;true&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt; &lt;span class='k'&gt;do&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='c1'&gt;# ...&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;&lt;span class='k'&gt;end&lt;/span&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/figure&gt;&lt;/div&gt;&lt;/notextile&gt;&lt;/div&gt;
&lt;p&gt;When you set this opion, VCR will base64 encode the body of the request or response during serialization, in order to preserve the bytes exactly.&lt;/p&gt;

&lt;h2 id='whats_next'&gt;What&amp;#8217;s next&lt;/h2&gt;

&lt;p&gt;I plan to release VCR 2.0.0 final in the next week or two. Please give VCR 2.0.0.rc2 a try and let me know if you have any issues!&lt;/p&gt;</content>
  </entry>
  
  <entry>
    <title>Why Sinatra's Halt is Awesome</title>
    <link href="http://myronmars.to/n/dev-blog/2012/01/why-sinatras-halt-is-awesome"/>
    <updated>2012-01-09T00:00:00-08:00</updated>
    <id>http://myronmars.to/n/dev-blog/2012/01/why-sinatras-halt-is-awesome</id>
    <content type="html">&lt;p&gt;Most of &lt;a href='http://sinatrarb.com/'&gt;Sinatra&amp;#8217;s&lt;/a&gt; well-deserved praise is directed toward its simple, elegant routing DSL. I want to draw attention to another feature that I love that doesn&amp;#8217;t get much attention: Sinatra&amp;#8217;s &lt;code&gt;halt&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;One of the biggest sources of complexity when developing robust applications is all of the error-handling code. Generally, code is easier to understand and is more maintainable when the error handling is not mixed together with the &amp;#8220;happy path&amp;#8221; code. This is one reason that virtually all modern languages have opted to provide exceptions rather than old C-style error return values. &lt;code&gt;halt&lt;/code&gt; provides similar benefits.&lt;/p&gt;

&lt;p&gt;Consider a simple sinatra route:&lt;/p&gt;
&lt;div class='bogus-wrapper'&gt;&lt;notextile&gt;&lt;div class='code-wrap'&gt;&lt;figure class='code'&gt;&lt;figcaption&gt;&lt;span&gt;application.rb &lt;/span&gt;&lt;/figcaption&gt;
 &lt;div class='highlight'&gt;&lt;table&gt;&lt;tr&gt;&lt;td class='gutter'&gt;&lt;pre class='line-numbers'&gt;&lt;span class='line-number'&gt;1&lt;/span&gt;
&lt;span class='line-number'&gt;2&lt;/span&gt;
&lt;span class='line-number'&gt;3&lt;/span&gt;
&lt;span class='line-number'&gt;4&lt;/span&gt;
&lt;span class='line-number'&gt;5&lt;/span&gt;
&lt;span class='line-number'&gt;6&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;td class='code'&gt;&lt;pre&gt;&lt;code class='rb'&gt;&lt;span class='line'&gt;&lt;span class='n'&gt;get&lt;/span&gt; &lt;span class='s1'&gt;&amp;#39;/users/:user_id/projects/:project_id/tasks-due-on/:task_date&amp;#39;&lt;/span&gt; &lt;span class='k'&gt;do&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='n'&gt;user&lt;/span&gt; &lt;span class='o'&gt;=&lt;/span&gt; &lt;span class='no'&gt;User&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;find&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;params&lt;/span&gt;&lt;span class='o'&gt;[&lt;/span&gt;&lt;span class='ss'&gt;:user_id&lt;/span&gt;&lt;span class='o'&gt;]&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='n'&gt;project&lt;/span&gt; &lt;span class='o'&gt;=&lt;/span&gt; &lt;span class='n'&gt;user&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;projects&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;find&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;params&lt;/span&gt;&lt;span class='o'&gt;[&lt;/span&gt;&lt;span class='ss'&gt;:project_id&lt;/span&gt;&lt;span class='o'&gt;]&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='n'&gt;tasks&lt;/span&gt; &lt;span class='o'&gt;=&lt;/span&gt; &lt;span class='n'&gt;project&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;tasks_due_on&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='no'&gt;Date&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;iso8601&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;params&lt;/span&gt;&lt;span class='o'&gt;[&lt;/span&gt;&lt;span class='ss'&gt;:task_date&lt;/span&gt;&lt;span class='o'&gt;]&lt;/span&gt;&lt;span class='p'&gt;))&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='n'&gt;tasks&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;to_json&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;&lt;span class='k'&gt;end&lt;/span&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/figure&gt;&lt;/div&gt;&lt;/notextile&gt;&lt;/div&gt;
&lt;p&gt;This is all &amp;#8220;happy path&amp;#8221; code, and there are a few potential problems that aren&amp;#8217;t handled at all:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;The user record for the given &lt;code&gt;:user_id&lt;/code&gt; may not exist.&lt;/li&gt;

&lt;li&gt;The project record for the given &lt;code&gt;:project_id&lt;/code&gt; may not exist, or may not belong to the given user.&lt;/li&gt;

&lt;li&gt;The &lt;code&gt;:task_date&lt;/code&gt; date string may not be in iso8601 format (i.e. YYYY-MM-DD).&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Let&amp;#8217;s handle each of these so that our API returns semantic HTTP status codes rather than responding with a 500 error:&lt;/p&gt;
&lt;div class='bogus-wrapper'&gt;&lt;notextile&gt;&lt;div class='code-wrap'&gt;&lt;figure class='code'&gt;&lt;figcaption&gt;&lt;span&gt;application.rb &lt;/span&gt;&lt;/figcaption&gt;
 &lt;div class='highlight'&gt;&lt;table&gt;&lt;tr&gt;&lt;td class='gutter'&gt;&lt;pre class='line-numbers'&gt;&lt;span class='line-number'&gt;1&lt;/span&gt;
&lt;span class='line-number'&gt;2&lt;/span&gt;
&lt;span class='line-number'&gt;3&lt;/span&gt;
&lt;span class='line-number'&gt;4&lt;/span&gt;
&lt;span class='line-number'&gt;5&lt;/span&gt;
&lt;span class='line-number'&gt;6&lt;/span&gt;
&lt;span class='line-number'&gt;7&lt;/span&gt;
&lt;span class='line-number'&gt;8&lt;/span&gt;
&lt;span class='line-number'&gt;9&lt;/span&gt;
&lt;span class='line-number'&gt;10&lt;/span&gt;
&lt;span class='line-number'&gt;11&lt;/span&gt;
&lt;span class='line-number'&gt;12&lt;/span&gt;
&lt;span class='line-number'&gt;13&lt;/span&gt;
&lt;span class='line-number'&gt;14&lt;/span&gt;
&lt;span class='line-number'&gt;15&lt;/span&gt;
&lt;span class='line-number'&gt;16&lt;/span&gt;
&lt;span class='line-number'&gt;17&lt;/span&gt;
&lt;span class='line-number'&gt;18&lt;/span&gt;
&lt;span class='line-number'&gt;19&lt;/span&gt;
&lt;span class='line-number'&gt;20&lt;/span&gt;
&lt;span class='line-number'&gt;21&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;td class='code'&gt;&lt;pre&gt;&lt;code class='rb'&gt;&lt;span class='line'&gt;&lt;span class='n'&gt;get&lt;/span&gt; &lt;span class='s1'&gt;&amp;#39;/users/:user_id/projects/:project_id/tasks-due-on/:task_date&amp;#39;&lt;/span&gt; &lt;span class='k'&gt;do&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='n'&gt;user&lt;/span&gt; &lt;span class='o'&gt;=&lt;/span&gt; &lt;span class='no'&gt;User&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;find&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;params&lt;/span&gt;&lt;span class='o'&gt;[&lt;/span&gt;&lt;span class='ss'&gt;:user_id&lt;/span&gt;&lt;span class='o'&gt;]&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='k'&gt;if&lt;/span&gt; &lt;span class='n'&gt;user&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;    &lt;span class='n'&gt;project&lt;/span&gt; &lt;span class='o'&gt;=&lt;/span&gt; &lt;span class='n'&gt;user&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;projects&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;find&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;params&lt;/span&gt;&lt;span class='o'&gt;[&lt;/span&gt;&lt;span class='ss'&gt;:project_id&lt;/span&gt;&lt;span class='o'&gt;]&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;
&lt;/span&gt;&lt;span class='line'&gt;    &lt;span class='k'&gt;if&lt;/span&gt; &lt;span class='n'&gt;project&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;      &lt;span class='k'&gt;begin&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;        &lt;span class='n'&gt;tasks&lt;/span&gt; &lt;span class='o'&gt;=&lt;/span&gt; &lt;span class='n'&gt;project&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;tasks_due_on&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='no'&gt;Date&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;iso8601&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;params&lt;/span&gt;&lt;span class='o'&gt;[&lt;/span&gt;&lt;span class='ss'&gt;:task_date&lt;/span&gt;&lt;span class='o'&gt;]&lt;/span&gt;&lt;span class='p'&gt;))&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;      &lt;span class='k'&gt;rescue&lt;/span&gt; &lt;span class='no'&gt;ArgumentError&lt;/span&gt; &lt;span class='c1'&gt;# for an invalid date string&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;        &lt;span class='n'&gt;status&lt;/span&gt; &lt;span class='mi'&gt;400&lt;/span&gt; &lt;span class='c1'&gt;# bad request&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;      &lt;span class='k'&gt;else&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;        &lt;span class='n'&gt;tasks&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;to_json&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;      &lt;span class='k'&gt;end&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;    &lt;span class='k'&gt;else&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;      &lt;span class='n'&gt;status&lt;/span&gt; &lt;span class='mi'&gt;404&lt;/span&gt; &lt;span class='c1'&gt;# not found&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;    &lt;span class='k'&gt;end&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='k'&gt;else&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;    &lt;span class='n'&gt;status&lt;/span&gt; &lt;span class='mi'&gt;404&lt;/span&gt; &lt;span class='c1'&gt;# not found&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='k'&gt;end&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;&lt;span class='k'&gt;end&lt;/span&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/figure&gt;&lt;/div&gt;&lt;/notextile&gt;&lt;/div&gt;
&lt;p&gt;This is certainly more robust, but I really, really hate this style of code. It makes my eyes bleed just looking at it. Let&amp;#8217;s clean it up a bit with some helper methods and &lt;code&gt;halt&lt;/code&gt;:&lt;/p&gt;
&lt;div class='bogus-wrapper'&gt;&lt;notextile&gt;&lt;div class='code-wrap'&gt;&lt;figure class='code'&gt;&lt;figcaption&gt;&lt;span&gt;application.rb &lt;/span&gt;&lt;/figcaption&gt;
 &lt;div class='highlight'&gt;&lt;table&gt;&lt;tr&gt;&lt;td class='gutter'&gt;&lt;pre class='line-numbers'&gt;&lt;span class='line-number'&gt;1&lt;/span&gt;
&lt;span class='line-number'&gt;2&lt;/span&gt;
&lt;span class='line-number'&gt;3&lt;/span&gt;
&lt;span class='line-number'&gt;4&lt;/span&gt;
&lt;span class='line-number'&gt;5&lt;/span&gt;
&lt;span class='line-number'&gt;6&lt;/span&gt;
&lt;span class='line-number'&gt;7&lt;/span&gt;
&lt;span class='line-number'&gt;8&lt;/span&gt;
&lt;span class='line-number'&gt;9&lt;/span&gt;
&lt;span class='line-number'&gt;10&lt;/span&gt;
&lt;span class='line-number'&gt;11&lt;/span&gt;
&lt;span class='line-number'&gt;12&lt;/span&gt;
&lt;span class='line-number'&gt;13&lt;/span&gt;
&lt;span class='line-number'&gt;14&lt;/span&gt;
&lt;span class='line-number'&gt;15&lt;/span&gt;
&lt;span class='line-number'&gt;16&lt;/span&gt;
&lt;span class='line-number'&gt;17&lt;/span&gt;
&lt;span class='line-number'&gt;18&lt;/span&gt;
&lt;span class='line-number'&gt;19&lt;/span&gt;
&lt;span class='line-number'&gt;20&lt;/span&gt;
&lt;span class='line-number'&gt;21&lt;/span&gt;
&lt;span class='line-number'&gt;22&lt;/span&gt;
&lt;span class='line-number'&gt;23&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;td class='code'&gt;&lt;pre&gt;&lt;code class='rb'&gt;&lt;span class='line'&gt;&lt;span class='n'&gt;helpers&lt;/span&gt; &lt;span class='k'&gt;do&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='k'&gt;def&lt;/span&gt; &lt;span class='nf'&gt;user&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;    &lt;span class='vi'&gt;@user&lt;/span&gt; &lt;span class='o'&gt;||=&lt;/span&gt; &lt;span class='no'&gt;User&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;find&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;params&lt;/span&gt;&lt;span class='o'&gt;[&lt;/span&gt;&lt;span class='ss'&gt;:user_id&lt;/span&gt;&lt;span class='o'&gt;]&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt; &lt;span class='o'&gt;||&lt;/span&gt; &lt;span class='n'&gt;halt&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='mi'&gt;404&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='k'&gt;end&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='k'&gt;def&lt;/span&gt; &lt;span class='nf'&gt;project&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;    &lt;span class='vi'&gt;@project&lt;/span&gt; &lt;span class='o'&gt;||=&lt;/span&gt; &lt;span class='n'&gt;user&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;projects&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;find&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;params&lt;/span&gt;&lt;span class='o'&gt;[&lt;/span&gt;&lt;span class='ss'&gt;:project_id&lt;/span&gt;&lt;span class='o'&gt;]&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt; &lt;span class='o'&gt;||&lt;/span&gt; &lt;span class='n'&gt;halt&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='mi'&gt;404&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='k'&gt;end&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='k'&gt;def&lt;/span&gt; &lt;span class='nf'&gt;task_date&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;    &lt;span class='vi'&gt;@task_date&lt;/span&gt; &lt;span class='o'&gt;||=&lt;/span&gt; &lt;span class='no'&gt;Date&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;iso8601&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;params&lt;/span&gt;&lt;span class='o'&gt;[&lt;/span&gt;&lt;span class='ss'&gt;:task_date&lt;/span&gt;&lt;span class='o'&gt;]&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='k'&gt;rescue&lt;/span&gt; &lt;span class='no'&gt;ArgumentError&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;    &lt;span class='n'&gt;halt&lt;/span&gt; &lt;span class='mi'&gt;400&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='k'&gt;end&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='k'&gt;def&lt;/span&gt; &lt;span class='nf'&gt;tasks&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;    &lt;span class='vi'&gt;@tasks&lt;/span&gt; &lt;span class='o'&gt;||=&lt;/span&gt; &lt;span class='n'&gt;project&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;tasks_due_on&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;task_date&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='k'&gt;end&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;&lt;span class='k'&gt;end&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;
&lt;/span&gt;&lt;span class='line'&gt;&lt;span class='n'&gt;get&lt;/span&gt; &lt;span class='s1'&gt;&amp;#39;/users/:user_id/projects/:project_id/tasks-due-on/:task_date&amp;#39;&lt;/span&gt; &lt;span class='k'&gt;do&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='n'&gt;tasks&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;to_json&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;&lt;span class='k'&gt;end&lt;/span&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/figure&gt;&lt;/div&gt;&lt;/notextile&gt;&lt;/div&gt;
&lt;p&gt;Much, much better. It&amp;#8217;s more lines of code, but so much simpler. The error handling for each piece of data is handled directly in the helper method that is responsible for that piece of data. This has the added benefit of making it simpler to implement other routes that need some of these pieces of data (and the corresponding error handling):&lt;/p&gt;
&lt;div class='bogus-wrapper'&gt;&lt;notextile&gt;&lt;div class='code-wrap'&gt;&lt;figure class='code'&gt;&lt;figcaption&gt;&lt;span&gt;application.rb &lt;/span&gt;&lt;/figcaption&gt;
 &lt;div class='highlight'&gt;&lt;table&gt;&lt;tr&gt;&lt;td class='gutter'&gt;&lt;pre class='line-numbers'&gt;&lt;span class='line-number'&gt;1&lt;/span&gt;
&lt;span class='line-number'&gt;2&lt;/span&gt;
&lt;span class='line-number'&gt;3&lt;/span&gt;
&lt;span class='line-number'&gt;4&lt;/span&gt;
&lt;span class='line-number'&gt;5&lt;/span&gt;
&lt;span class='line-number'&gt;6&lt;/span&gt;
&lt;span class='line-number'&gt;7&lt;/span&gt;
&lt;span class='line-number'&gt;8&lt;/span&gt;
&lt;span class='line-number'&gt;9&lt;/span&gt;
&lt;span class='line-number'&gt;10&lt;/span&gt;
&lt;span class='line-number'&gt;11&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;td class='code'&gt;&lt;pre&gt;&lt;code class='rb'&gt;&lt;span class='line'&gt;&lt;span class='n'&gt;helpers&lt;/span&gt; &lt;span class='k'&gt;do&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='c1'&gt;# all the helpers defined above...&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;&lt;span class='k'&gt;end&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;
&lt;/span&gt;&lt;span class='line'&gt;&lt;span class='n'&gt;get&lt;/span&gt; &lt;span class='s1'&gt;&amp;#39;/users/:user_id/projects/:project_id&amp;#39;&lt;/span&gt; &lt;span class='k'&gt;do&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='n'&gt;project&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;to_json&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;&lt;span class='k'&gt;end&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;
&lt;/span&gt;&lt;span class='line'&gt;&lt;span class='n'&gt;get&lt;/span&gt; &lt;span class='s1'&gt;&amp;#39;/users/:user_id/projects/:project_id/tasks-due-on/:task_date&amp;#39;&lt;/span&gt; &lt;span class='k'&gt;do&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='n'&gt;tasks&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;to_json&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;&lt;span class='k'&gt;end&lt;/span&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/figure&gt;&lt;/div&gt;&lt;/notextile&gt;&lt;/div&gt;
&lt;p&gt;This is only possible through the magic of &lt;code&gt;halt&lt;/code&gt;. Under the covers, &lt;code&gt;halt&lt;/code&gt; uses &lt;code&gt;throw&lt;/code&gt;&lt;sup id='fnref:1'&gt;&lt;a href='#fn:1' rel='footnote'&gt;1&lt;/a&gt;&lt;/sup&gt; to immediately stop processing the route and return the response given to &lt;code&gt;halt&lt;/code&gt;. Some ruby developers have &lt;a href='http://m.onkey.org/ruby-i-don-t-like-2-catch-wtf-throw-wtf'&gt;gone on record as hating ruby&amp;#8217;s throw&lt;/a&gt;, and it can certainly be abused&amp;#8230;but Sinatra&amp;#8217;s &lt;code&gt;halt&lt;/code&gt; sure is useful and is only made possible by &lt;code&gt;throw&lt;/code&gt;&lt;sup id='fnref:2'&gt;&lt;a href='#fn:2' rel='footnote'&gt;2&lt;/a&gt;&lt;/sup&gt;.&lt;/p&gt;

&lt;p&gt;The next time you&amp;#8217;re building a Sinatra application, I encourage you to consider using &lt;code&gt;halt&lt;/code&gt; to simplify your error handling.&lt;/p&gt;
&lt;div class='footnotes'&gt;&lt;hr /&gt;&lt;ol&gt;&lt;li id='fn:1'&gt;
&lt;p&gt;If you&amp;#8217;re unfamiliar with &lt;code&gt;throw&lt;/code&gt;, check out Avdi Grimm&amp;#8217;s &lt;a href='http://rubylearning.com/blog/2011/07/12/throw-catch-raise-rescue-im-so-confused/'&gt;blog post&lt;/a&gt; on the topic.&lt;/p&gt;
&lt;a href='#fnref:1' rev='footnote'&gt;&amp;#8617;&lt;/a&gt;&lt;/li&gt;&lt;li id='fn:2'&gt;
&lt;p&gt;Technically, you could implement &lt;code&gt;halt&lt;/code&gt; using exceptions, but that seems semantically wrong to me. &lt;code&gt;throw&lt;/code&gt; is specifically intended for cases like these.&lt;/p&gt;
&lt;a href='#fnref:2' rev='footnote'&gt;&amp;#8617;&lt;/a&gt;&lt;/li&gt;&lt;/ol&gt;&lt;/div&gt;</content>
  </entry>
  
  <entry>
    <title>Deprecating a Legacy Subsystem in Rails</title>
    <link href="http://myronmars.to/n/dev-blog/2011/12/deprecating-a-legacy-subsystem-in-rails"/>
    <updated>2011-12-28T00:00:00-08:00</updated>
    <id>http://myronmars.to/n/dev-blog/2011/12/deprecating-a-legacy-subsystem-in-rails</id>
    <content type="html">&lt;p&gt;A major part of my job in the past year at &lt;a href='http://www.seomoz.org/'&gt;SEOmoz&lt;/a&gt; was a re-write of the &lt;a href='http://www.seomoz.org/features'&gt;rank-tracking component&lt;/a&gt; of SEOmoz PRO. The existing system had major performance and scalability problems, and &lt;a href='http://bitfluxx.com/'&gt;Jeff Pollard&lt;/a&gt; and I were tasked with designing and and building an internal service to solve all these problems.&lt;/p&gt;

&lt;p&gt;Jeff previously &lt;a href='http://devblog.seomoz.org/2011/10/using-riak-for-ranking-collection/'&gt;blogged a bit&lt;/a&gt; about the design of the system, particularly our choice of Riak as the main data store. One of the other interesting bits to come out of this project was the way we migrated from the old system to the new system. We knew it would take at least a couple weeks (although, in the end it took 3 months!) and it was important that there was ZERO negative customer impact during the migration period. I came up with a technique that made it very easy to keep the existing system around in a deprecated state, and, once all data had been migrated to the new system, remove it entirely.&lt;/p&gt;

&lt;h2 id='the_goals'&gt;The Goals&lt;/h2&gt;

&lt;p&gt;We had several goals and constraints for the migration:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;The volume of data to import (billions of MySQL records) was such that a single atomic switch to the new system seemed impossible (or, at the very least, extremely risky). Thus, we knew we wanted to have a way to run the old and new systems side-by-side, and migrate customers over to the new system one-by-one.&lt;/li&gt;

&lt;li&gt;The old ranking system used a tangle of SQL views, ActiveRecord models, and controller and view logic. There was no value in re-using any of this code for the new system. Thus, we wanted to &amp;#8220;quarantine&amp;#8221; this old code to have a clean slate to build out the controller and views for the new system (the new system didn&amp;#8217;t have any ActiveRecord models since it relied upon the HTTP API of the service for its data). Once the migration was complete, we wanted it to be very easy to remove the old system (i.e. by simply deleting the source files from a few directories).&lt;/li&gt;

&lt;li&gt;The routes for the existing ranking system were fine, and we wanted to keep using them for the new system.&lt;/li&gt;

&lt;li&gt;Previously, we had replaced one of the other subsystems with an internal service. For that project, the rails app had a long-running branch (as in several months) that integrated with the new service. We frequently experienced merge pain for that project. This time, we knew we wanted to use a feature flag, and build out the rails side of the new system directly in the master branch, with no painful merges.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;The solution I came up with worked very well, and I think it can apply to similar problems in other systems.&lt;/p&gt;

&lt;h2 id='step_1_move_the_models_into_deprecated_directory'&gt;Step 1: Move the models into deprecated directory&lt;/h2&gt;

&lt;p&gt;First, I made a new directory at &lt;code&gt;app/models/deprecated&lt;/code&gt; and moved all the models for the old ranking system there. This quarantined the legacy code and made it clear that the code was going away soon and no significant investment should go into refactoring it.&lt;/p&gt;

&lt;p&gt;We had to configure rails to recognize this new directory for auto-loading:&lt;/p&gt;
&lt;div class='bogus-wrapper'&gt;&lt;notextile&gt;&lt;div class='code-wrap'&gt;&lt;figure class='code'&gt;&lt;figcaption&gt;&lt;span&gt;config/application.rb &lt;/span&gt;&lt;/figcaption&gt;
 &lt;div class='highlight'&gt;&lt;table&gt;&lt;tr&gt;&lt;td class='gutter'&gt;&lt;pre class='line-numbers'&gt;&lt;span class='line-number'&gt;1&lt;/span&gt;
&lt;span class='line-number'&gt;2&lt;/span&gt;
&lt;span class='line-number'&gt;3&lt;/span&gt;
&lt;span class='line-number'&gt;4&lt;/span&gt;
&lt;span class='line-number'&gt;5&lt;/span&gt;
&lt;span class='line-number'&gt;6&lt;/span&gt;
&lt;span class='line-number'&gt;7&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;td class='code'&gt;&lt;pre&gt;&lt;code class='rb'&gt;&lt;span class='line'&gt;&lt;span class='k'&gt;module&lt;/span&gt; &lt;span class='nn'&gt;Cmoz&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='k'&gt;class&lt;/span&gt; &lt;span class='nc'&gt;Application&lt;/span&gt; &lt;span class='o'&gt;&amp;lt;&lt;/span&gt; &lt;span class='no'&gt;Rails&lt;/span&gt;&lt;span class='o'&gt;::&lt;/span&gt;&lt;span class='no'&gt;Application&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;    &lt;span class='c1'&gt;# ...&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;    &lt;span class='n'&gt;config&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;autoload_paths&lt;/span&gt; &lt;span class='o'&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class='s2'&gt;&amp;quot;&lt;/span&gt;&lt;span class='si'&gt;#{&lt;/span&gt;&lt;span class='n'&gt;config&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;root&lt;/span&gt;&lt;span class='si'&gt;}&lt;/span&gt;&lt;span class='s2'&gt;/app/models/deprecated&amp;quot;&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;    &lt;span class='c1'&gt;# ...&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='k'&gt;end&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;&lt;span class='k'&gt;end&lt;/span&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/figure&gt;&lt;/div&gt;&lt;/notextile&gt;&lt;/div&gt;
&lt;h2 id='step_2_add_a_feature_flag_to_the_user_model'&gt;Step 2: Add a feature flag to the user model&lt;/h2&gt;

&lt;p&gt;The new service was named &amp;#8220;silo&amp;#8221;, so we added a &lt;code&gt;using_silo&lt;/code&gt; flag to the user model that defaulted to false.&lt;/p&gt;
&lt;div class='bogus-wrapper'&gt;&lt;notextile&gt;&lt;div class='code-wrap'&gt;&lt;figure class='code'&gt;&lt;figcaption&gt;&lt;span&gt;db/migrate/20110509180019_add_using_silo_to_users.rb &lt;/span&gt;&lt;/figcaption&gt;
 &lt;div class='highlight'&gt;&lt;table&gt;&lt;tr&gt;&lt;td class='gutter'&gt;&lt;pre class='line-numbers'&gt;&lt;span class='line-number'&gt;1&lt;/span&gt;
&lt;span class='line-number'&gt;2&lt;/span&gt;
&lt;span class='line-number'&gt;3&lt;/span&gt;
&lt;span class='line-number'&gt;4&lt;/span&gt;
&lt;span class='line-number'&gt;5&lt;/span&gt;
&lt;span class='line-number'&gt;6&lt;/span&gt;
&lt;span class='line-number'&gt;7&lt;/span&gt;
&lt;span class='line-number'&gt;8&lt;/span&gt;
&lt;span class='line-number'&gt;9&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;td class='code'&gt;&lt;pre&gt;&lt;code class='rb'&gt;&lt;span class='line'&gt;&lt;span class='k'&gt;class&lt;/span&gt; &lt;span class='nc'&gt;AddUsingSiloToUsers&lt;/span&gt; &lt;span class='o'&gt;&amp;lt;&lt;/span&gt; &lt;span class='no'&gt;ActiveRecord&lt;/span&gt;&lt;span class='o'&gt;::&lt;/span&gt;&lt;span class='no'&gt;Migration&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='k'&gt;def&lt;/span&gt; &lt;span class='nc'&gt;self&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='nf'&gt;up&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;    &lt;span class='n'&gt;add_column&lt;/span&gt; &lt;span class='ss'&gt;:users&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='ss'&gt;:using_silo&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='ss'&gt;:boolean&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='ss'&gt;:null&lt;/span&gt; &lt;span class='o'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='kp'&gt;false&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='ss'&gt;:default&lt;/span&gt; &lt;span class='o'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='kp'&gt;false&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='k'&gt;end&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='k'&gt;def&lt;/span&gt; &lt;span class='nc'&gt;self&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='nf'&gt;down&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;    &lt;span class='n'&gt;remove_column&lt;/span&gt; &lt;span class='ss'&gt;:users&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='ss'&gt;:using_silo&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='k'&gt;end&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;&lt;span class='k'&gt;end&lt;/span&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/figure&gt;&lt;/div&gt;&lt;/notextile&gt;&lt;/div&gt;
&lt;h2 id='step_3_turn_the_old_controller_into_a_conditionally_extended_module'&gt;Step 3: Turn the old controller into a conditionally extended module&lt;/h2&gt;

&lt;p&gt;The controller and views were a bit more difficult to deprecate cleanly. As I mentioned above, we wanted to preserve the existing routes, and I don&amp;#8217;t know of a way in rails to route identical requests to different controllers based on a feature flag on the current user record. Instead, we kept a single controller, and turned the old controller into a mixin that we conditionally extended onto the controller instance.&lt;/p&gt;

&lt;p&gt;We started with a controller that was roughly like this:&lt;/p&gt;
&lt;div class='bogus-wrapper'&gt;&lt;notextile&gt;&lt;div class='code-wrap'&gt;&lt;figure class='code'&gt;&lt;figcaption&gt;&lt;span&gt;app/controllers/rankings_controller.rb &lt;/span&gt;&lt;/figcaption&gt;
 &lt;div class='highlight'&gt;&lt;table&gt;&lt;tr&gt;&lt;td class='gutter'&gt;&lt;pre class='line-numbers'&gt;&lt;span class='line-number'&gt;1&lt;/span&gt;
&lt;span class='line-number'&gt;2&lt;/span&gt;
&lt;span class='line-number'&gt;3&lt;/span&gt;
&lt;span class='line-number'&gt;4&lt;/span&gt;
&lt;span class='line-number'&gt;5&lt;/span&gt;
&lt;span class='line-number'&gt;6&lt;/span&gt;
&lt;span class='line-number'&gt;7&lt;/span&gt;
&lt;span class='line-number'&gt;8&lt;/span&gt;
&lt;span class='line-number'&gt;9&lt;/span&gt;
&lt;span class='line-number'&gt;10&lt;/span&gt;
&lt;span class='line-number'&gt;11&lt;/span&gt;
&lt;span class='line-number'&gt;12&lt;/span&gt;
&lt;span class='line-number'&gt;13&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;td class='code'&gt;&lt;pre&gt;&lt;code class='rb'&gt;&lt;span class='line'&gt;&lt;span class='k'&gt;class&lt;/span&gt; &lt;span class='nc'&gt;RankingsController&lt;/span&gt; &lt;span class='o'&gt;&amp;lt;&lt;/span&gt; &lt;span class='no'&gt;ApplicationController&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='k'&gt;def&lt;/span&gt; &lt;span class='nf'&gt;index&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;    &lt;span class='c1'&gt;# fetch rankings from the old database&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;    &lt;span class='vi'&gt;@rankings&lt;/span&gt; &lt;span class='o'&gt;=&lt;/span&gt; &lt;span class='n'&gt;fetch_rankings&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;    &lt;span class='c1'&gt;# ...and lots more stuff; this was not a skinny controller&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='k'&gt;end&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='k'&gt;def&lt;/span&gt; &lt;span class='nf'&gt;show&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;    &lt;span class='c1'&gt;# fetch rankings from the old database for the given keyword&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;    &lt;span class='vi'&gt;@rankings&lt;/span&gt; &lt;span class='o'&gt;=&lt;/span&gt; &lt;span class='n'&gt;fetch_rankings_for_keyword&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;params&lt;/span&gt;&lt;span class='o'&gt;[&lt;/span&gt;&lt;span class='ss'&gt;:keyword_id&lt;/span&gt;&lt;span class='o'&gt;]&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;    &lt;span class='c1'&gt;# ...and lots more stuff; this was not a skinny controller&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='k'&gt;end&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;&lt;span class='k'&gt;end&lt;/span&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/figure&gt;&lt;/div&gt;&lt;/notextile&gt;&lt;/div&gt;
&lt;p&gt;&amp;#8230;and we changed it like so:&lt;/p&gt;
&lt;div class='bogus-wrapper'&gt;&lt;notextile&gt;&lt;div class='code-wrap'&gt;&lt;figure class='code'&gt;&lt;figcaption&gt;&lt;span&gt;app/controllers/deprecated/legacy_rankings_controller.rb &lt;/span&gt;&lt;/figcaption&gt;
 &lt;div class='highlight'&gt;&lt;table&gt;&lt;tr&gt;&lt;td class='gutter'&gt;&lt;pre class='line-numbers'&gt;&lt;span class='line-number'&gt;1&lt;/span&gt;
&lt;span class='line-number'&gt;2&lt;/span&gt;
&lt;span class='line-number'&gt;3&lt;/span&gt;
&lt;span class='line-number'&gt;4&lt;/span&gt;
&lt;span class='line-number'&gt;5&lt;/span&gt;
&lt;span class='line-number'&gt;6&lt;/span&gt;
&lt;span class='line-number'&gt;7&lt;/span&gt;
&lt;span class='line-number'&gt;8&lt;/span&gt;
&lt;span class='line-number'&gt;9&lt;/span&gt;
&lt;span class='line-number'&gt;10&lt;/span&gt;
&lt;span class='line-number'&gt;11&lt;/span&gt;
&lt;span class='line-number'&gt;12&lt;/span&gt;
&lt;span class='line-number'&gt;13&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;td class='code'&gt;&lt;pre&gt;&lt;code class='rb'&gt;&lt;span class='line'&gt;&lt;span class='k'&gt;module&lt;/span&gt; &lt;span class='nn'&gt;LegacyRankingsController&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='k'&gt;def&lt;/span&gt; &lt;span class='nf'&gt;index&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;    &lt;span class='c1'&gt;# fetch rankings from the old database&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;    &lt;span class='vi'&gt;@rankings&lt;/span&gt; &lt;span class='o'&gt;=&lt;/span&gt; &lt;span class='n'&gt;fetch_rankings&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;    &lt;span class='c1'&gt;# ...and lots more stuff; this was not a skinny controller&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='k'&gt;end&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='k'&gt;def&lt;/span&gt; &lt;span class='nf'&gt;show&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;    &lt;span class='c1'&gt;# fetch rankings from the old database for the given keyword&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;    &lt;span class='vi'&gt;@rankings&lt;/span&gt; &lt;span class='o'&gt;=&lt;/span&gt; &lt;span class='n'&gt;fetch_rankings_for_keyword&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;params&lt;/span&gt;&lt;span class='o'&gt;[&lt;/span&gt;&lt;span class='ss'&gt;:keyword_id&lt;/span&gt;&lt;span class='o'&gt;]&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;    &lt;span class='c1'&gt;# ...and lots more stuff; this was not a skinny controller&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='k'&gt;end&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;&lt;span class='k'&gt;end&lt;/span&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/figure&gt;&lt;/div&gt;&lt;/notextile&gt;&lt;/div&gt;&lt;div class='bogus-wrapper'&gt;&lt;notextile&gt;&lt;div class='code-wrap'&gt;&lt;figure class='code'&gt;&lt;figcaption&gt;&lt;span&gt;app/controllers/rankings_controller.rb &lt;/span&gt;&lt;/figcaption&gt;
 &lt;div class='highlight'&gt;&lt;table&gt;&lt;tr&gt;&lt;td class='gutter'&gt;&lt;pre class='line-numbers'&gt;&lt;span class='line-number'&gt;1&lt;/span&gt;
&lt;span class='line-number'&gt;2&lt;/span&gt;
&lt;span class='line-number'&gt;3&lt;/span&gt;
&lt;span class='line-number'&gt;4&lt;/span&gt;
&lt;span class='line-number'&gt;5&lt;/span&gt;
&lt;span class='line-number'&gt;6&lt;/span&gt;
&lt;span class='line-number'&gt;7&lt;/span&gt;
&lt;span class='line-number'&gt;8&lt;/span&gt;
&lt;span class='line-number'&gt;9&lt;/span&gt;
&lt;span class='line-number'&gt;10&lt;/span&gt;
&lt;span class='line-number'&gt;11&lt;/span&gt;
&lt;span class='line-number'&gt;12&lt;/span&gt;
&lt;span class='line-number'&gt;13&lt;/span&gt;
&lt;span class='line-number'&gt;14&lt;/span&gt;
&lt;span class='line-number'&gt;15&lt;/span&gt;
&lt;span class='line-number'&gt;16&lt;/span&gt;
&lt;span class='line-number'&gt;17&lt;/span&gt;
&lt;span class='line-number'&gt;18&lt;/span&gt;
&lt;span class='line-number'&gt;19&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;td class='code'&gt;&lt;pre&gt;&lt;code class='rb'&gt;&lt;span class='line'&gt;&lt;span class='nb'&gt;require&lt;/span&gt; &lt;span class='s1'&gt;&amp;#39;deprecated/legacy_rankings_controller&amp;#39;&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;
&lt;/span&gt;&lt;span class='line'&gt;&lt;span class='k'&gt;class&lt;/span&gt; &lt;span class='nc'&gt;RankingsController&lt;/span&gt; &lt;span class='o'&gt;&amp;lt;&lt;/span&gt; &lt;span class='no'&gt;ApplicationController&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='n'&gt;before_filter&lt;/span&gt; &lt;span class='ss'&gt;:conditionally_use_legacy_controller&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='k'&gt;def&lt;/span&gt; &lt;span class='nf'&gt;index&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;    &lt;span class='k'&gt;raise&lt;/span&gt; &lt;span class='no'&gt;NotImplementedError&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='s2'&gt;&amp;quot;The new code hasn&amp;#39;t been written yet&amp;quot;&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='k'&gt;end&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='k'&gt;def&lt;/span&gt; &lt;span class='nf'&gt;show&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;    &lt;span class='k'&gt;raise&lt;/span&gt; &lt;span class='no'&gt;NotImplementedError&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='s2'&gt;&amp;quot;The new code hasn&amp;#39;t been written yet&amp;quot;&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='k'&gt;end&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;
&lt;/span&gt;&lt;span class='line'&gt;&lt;span class='kp'&gt;private&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='k'&gt;def&lt;/span&gt; &lt;span class='nf'&gt;conditionally_use_legacy_controller&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;    &lt;span class='kp'&gt;extend&lt;/span&gt; &lt;span class='no'&gt;LegacyRankingsController&lt;/span&gt; &lt;span class='k'&gt;unless&lt;/span&gt; &lt;span class='n'&gt;current_user&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;using_silo?&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='k'&gt;end&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;&lt;span class='k'&gt;end&lt;/span&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/figure&gt;&lt;/div&gt;&lt;/notextile&gt;&lt;/div&gt;
&lt;p&gt;Hopefully it&amp;#8217;s clear what&amp;#8217;s going on here, but in case it&amp;#8217;s not:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;Rails constructs a new instance of the controller class for every request.&lt;/li&gt;

&lt;li&gt;&lt;code&gt;extend&lt;/code&gt; is standard ruby method that lets you apply a module to a single object instance. The methods in the module, like singleton methods, take precedence over the methods defined in the controller class.&lt;/li&gt;

&lt;li&gt;The before filter replaces the controller implementation with the logic in the module for all requests for users who are not yet using silo. The fact that rails uses a new instance of the controller for every request ensures that the module extension is performed (or not) for each request in isolation.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;This gives us a very simple, clean way to route the requests to different action implementations based on our feature flag.&lt;/p&gt;

&lt;h2 id='step_4_move_the_views_into_a_deprecated_directory'&gt;Step 4: Move the views into a deprecated directory&lt;/h2&gt;

&lt;p&gt;As with the models above, we moved the views from &lt;code&gt;app/views/rankings&lt;/code&gt; to &lt;code&gt;app/views/deprecated/rankings&lt;/code&gt; to quarantine the old code. Of course, this prevents rails from finding the views where it expects them&amp;#8230;but luckily, rails provides &lt;code&gt;prepend_view_paths&lt;/code&gt; (both as an &lt;a href='https://github.com/rails/rails/blob/v3.1.3/actionpack/lib/abstract_controller/view_paths.rb#L54-56'&gt;instance method&lt;/a&gt; and a &lt;a href='https://github.com/rails/rails/blob/v3.1.3/actionpack/lib/abstract_controller/view_paths.rb#L69-77'&gt;class method&lt;/a&gt;), which solves this problem perfectly. We just need to tweak &lt;code&gt;conditionally_use_legacy_controller&lt;/code&gt; a bit to use the instance method:&lt;/p&gt;
&lt;div class='bogus-wrapper'&gt;&lt;notextile&gt;&lt;div class='code-wrap'&gt;&lt;figure class='code'&gt;&lt;figcaption&gt;&lt;span&gt;app/controllers/rankings_controller.rb &lt;/span&gt;&lt;/figcaption&gt;
 &lt;div class='highlight'&gt;&lt;table&gt;&lt;tr&gt;&lt;td class='gutter'&gt;&lt;pre class='line-numbers'&gt;&lt;span class='line-number'&gt;1&lt;/span&gt;
&lt;span class='line-number'&gt;2&lt;/span&gt;
&lt;span class='line-number'&gt;3&lt;/span&gt;
&lt;span class='line-number'&gt;4&lt;/span&gt;
&lt;span class='line-number'&gt;5&lt;/span&gt;
&lt;span class='line-number'&gt;6&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;td class='code'&gt;&lt;pre&gt;&lt;code class='rb'&gt;&lt;span class='line'&gt;&lt;span class='k'&gt;def&lt;/span&gt; &lt;span class='nf'&gt;conditionally_use_legacy_controller&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='k'&gt;unless&lt;/span&gt; &lt;span class='n'&gt;current_user&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;using_silo?&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;    &lt;span class='kp'&gt;extend&lt;/span&gt; &lt;span class='no'&gt;LegacyRankingsController&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;    &lt;span class='n'&gt;prepend_view_path&lt;/span&gt; &lt;span class='s2'&gt;&amp;quot;app/views/deprecated&amp;quot;&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='k'&gt;end&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;&lt;span class='k'&gt;end&lt;/span&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/figure&gt;&lt;/div&gt;&lt;/notextile&gt;&lt;/div&gt;
&lt;p&gt;This forces Rails to render the views in &lt;code&gt;app/views/rankings&lt;/code&gt; for users on the new rankings system, and to render the views in &lt;code&gt;app/views/deprecated/rankings&lt;/code&gt; for users still on the old system. It only affects this one request because we are using the instance method &lt;code&gt;prepend_view_path&lt;/code&gt;, not the class method.&lt;/p&gt;

&lt;h2 id='wrapping_up'&gt;Wrapping Up&lt;/h2&gt;

&lt;p&gt;From here, I had a clean slate to implement the controller and views for the new rankings system. The &lt;code&gt;using_silo&lt;/code&gt; flag made it easy to let admins try-out and test the new system before turning it on for all new users. We migrated existing users over to the new system one-by-one, and it was easy to get rid of the code for the old system once all users were migrated.&lt;/p&gt;

&lt;p&gt;I imagine this pattern would be useful in plenty of other situations, too; it&amp;#8217;s a simple, clean way to route requests to different controller and view implementations.&lt;/p&gt;</content>
  </entry>
  
  <entry>
    <title>VCR 2.0.0 RC Released!</title>
    <link href="http://myronmars.to/n/dev-blog/2011/12/vcr-2-0-0-rc-released"/>
    <updated>2011-12-08T00:00:00-08:00</updated>
    <id>http://myronmars.to/n/dev-blog/2011/12/vcr-2-0-0-rc-released</id>
    <content type="html">&lt;p&gt;I&amp;#8217;ve just released the release candidate for VCR 2.0.0. There&amp;#8217;s lots of new goodness. This blog post is a bit of an &amp;#8220;extended&amp;#8221; change log detailing most of the interesting changes from VCR 1.x.&lt;/p&gt;

&lt;h2 id='whats_been_removed'&gt;What&amp;#8217;s been removed&lt;/h2&gt;

&lt;p&gt;Support for Ruby 1.8.6 and 1.9.1 has been dropped. It doesn&amp;#8217;t make sense to keep supporting these versions, especially since I use &lt;a href='http://travis-ci.org/#!/myronmarston/vcr'&gt;travis-ci&lt;/a&gt; for my CI builds and it no longer supports 1.8.6 and 1.9.1.&lt;/p&gt;

&lt;p&gt;There are several old deprecated APIs that have been removed. This is unlikely to affect anyone since I believe they have all been deprecated for over a year. I won&amp;#8217;t detail them here. If you&amp;#8217;re running a fairly recent 1.x release without any warnings then this shouldn&amp;#8217;t affect you at all.&lt;/p&gt;

&lt;p&gt;VCR 1.x supported regexes that were manually inserted in a cassette in place of a URI. This support has been dropped. VCR 2.0 supports &lt;a href='/n/dev-blog/2011/10/custom-request-matchers-in-vcr-2-0#request_matching_in_vcr_20'&gt;custom request matchers&lt;/a&gt; which are much more flexible then the regex support in VCR 1.x. You could even re-implement the regex support using a custom request matcher in a few lines of code if it is important for your test suite.&lt;/p&gt;

&lt;h2 id='whats_been_changed'&gt;What&amp;#8217;s been changed&lt;/h2&gt;

&lt;p&gt;The configuration API has changed slightly:&lt;/p&gt;
&lt;div class='bogus-wrapper'&gt;&lt;notextile&gt;&lt;div class='code-wrap'&gt;&lt;figure class='code'&gt;&lt;figcaption&gt;&lt;span&gt;configuration.rb &lt;/span&gt;&lt;/figcaption&gt;
 &lt;div class='highlight'&gt;&lt;table&gt;&lt;tr&gt;&lt;td class='gutter'&gt;&lt;pre class='line-numbers'&gt;&lt;span class='line-number'&gt;1&lt;/span&gt;
&lt;span class='line-number'&gt;2&lt;/span&gt;
&lt;span class='line-number'&gt;3&lt;/span&gt;
&lt;span class='line-number'&gt;4&lt;/span&gt;
&lt;span class='line-number'&gt;5&lt;/span&gt;
&lt;span class='line-number'&gt;6&lt;/span&gt;
&lt;span class='line-number'&gt;7&lt;/span&gt;
&lt;span class='line-number'&gt;8&lt;/span&gt;
&lt;span class='line-number'&gt;9&lt;/span&gt;
&lt;span class='line-number'&gt;10&lt;/span&gt;
&lt;span class='line-number'&gt;11&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;td class='code'&gt;&lt;pre&gt;&lt;code class='rb'&gt;&lt;span class='line'&gt;&lt;span class='c1'&gt;# VCR 1.x&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;&lt;span class='no'&gt;VCR&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;config&lt;/span&gt; &lt;span class='k'&gt;do&lt;/span&gt; &lt;span class='o'&gt;|&lt;/span&gt;&lt;span class='n'&gt;c&lt;/span&gt;&lt;span class='o'&gt;|&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='n'&gt;c&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;cassette_library_dir&lt;/span&gt; &lt;span class='o'&gt;=&lt;/span&gt; &lt;span class='s1'&gt;&amp;#39;cassettes&amp;#39;&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='n'&gt;c&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;stub_with&lt;/span&gt; &lt;span class='ss'&gt;:fakeweb&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='ss'&gt;:typhoeus&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;&lt;span class='k'&gt;end&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;
&lt;/span&gt;&lt;span class='line'&gt;&lt;span class='c1'&gt;# VCR 2.0&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;&lt;span class='no'&gt;VCR&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;configure&lt;/span&gt; &lt;span class='k'&gt;do&lt;/span&gt; &lt;span class='o'&gt;|&lt;/span&gt;&lt;span class='n'&gt;c&lt;/span&gt;&lt;span class='o'&gt;|&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='n'&gt;c&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;cassette_library_dir&lt;/span&gt; &lt;span class='o'&gt;=&lt;/span&gt; &lt;span class='s1'&gt;&amp;#39;cassettes&amp;#39;&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='n'&gt;c&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;hook_into&lt;/span&gt; &lt;span class='ss'&gt;:fakeweb&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='ss'&gt;:typhoeus&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;&lt;span class='k'&gt;end&lt;/span&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/figure&gt;&lt;/div&gt;&lt;/notextile&gt;&lt;/div&gt;
&lt;p&gt;Your existing configuration will continue to work with a deprecation warning.&lt;/p&gt;

&lt;p&gt;The &lt;a href='/n/dev-blog/2011/11/cassettes-in-vcr-2-0'&gt;cassette format has changed significantly&lt;/a&gt;. VCR 1.x cassettes are not compatible with VCR 2.0. You&amp;#8217;ll need to either re-record them or &lt;a href='https://github.com/myronmarston/vcr/blob/master/Upgrade.md'&gt;migrate them to the new format&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Individual HTTP interactions are no longer replayed multiple times during the use of a single cassette. The new &lt;a href='https://www.relishapp.com/myronmarston/vcr/docs/request-matching/playback-repeats'&gt;&lt;code&gt;:allow_playback_repeats&lt;/code&gt; cassette option&lt;/a&gt; can be used to restore the VCR 1.x behavior.&lt;/p&gt;

&lt;p&gt;The &lt;a href='https://github.com/technoweenie/faraday'&gt;Faraday&lt;/a&gt; integration has been rewritten. The Faraday integration in VCR 1.x was more than a little confusing; besides configuring &lt;code&gt;config.stub_with :faraday&lt;/code&gt;, you also had to insert &lt;code&gt;VCR::Middleware::Faraday&lt;/code&gt; in the Faraday middleware stack and provide a cassette configuration block. In VCR 2.0, you simply configure &lt;code&gt;config.hook_into :faraday&lt;/code&gt;, just like for FakeWeb, WebMock, Typhoeus or Excon. Under the covers, it takes care of inserting the middleware in the Faraday stack. Alternately, if you want control over where the VCR middleware goes in the stack, you can opt to insert it yourself.&lt;/p&gt;

&lt;h2 id='custom_request_matchers'&gt;Custom Request Matchers&lt;/h2&gt;

&lt;p&gt;This is one of the best new features of VCR 2.0. I &lt;a href='/n/dev-blog/2011/10/custom-request-matchers-in-vcr-2-0#request_matching_in_vcr_20'&gt;blogged about this previously&lt;/a&gt;, so I won&amp;#8217;t belabor it here.&lt;/p&gt;

&lt;h2 id='swappable_and_custom_serializers'&gt;Swappable (and Custom) Serializers&lt;/h2&gt;

&lt;p&gt;This is one of the other big new features of VCR 2.0. My &lt;a href='/n/dev-blog/2011/11/cassettes-in-vcr-2-0#new_serializers'&gt;recent blog post&lt;/a&gt; contains the pertinent details.&lt;/p&gt;

&lt;h2 id='request_hooks'&gt;Request Hooks&lt;/h2&gt;

&lt;p&gt;VCR now provides &lt;code&gt;before_http_request&lt;/code&gt;, &lt;code&gt;after_http_request&lt;/code&gt; and &lt;code&gt;around_http_request&lt;/code&gt; hooks. These can be used in many ways. Here&amp;#8217;s how you could use an &lt;code&gt;after_http_request&lt;/code&gt; hook to log all HTTP requests:&lt;/p&gt;
&lt;div class='bogus-wrapper'&gt;&lt;notextile&gt;&lt;div class='code-wrap'&gt;&lt;figure class='code'&gt;&lt;figcaption&gt;&lt;span&gt;log_request.rb &lt;/span&gt;&lt;/figcaption&gt;
 &lt;div class='highlight'&gt;&lt;table&gt;&lt;tr&gt;&lt;td class='gutter'&gt;&lt;pre class='line-numbers'&gt;&lt;span class='line-number'&gt;1&lt;/span&gt;
&lt;span class='line-number'&gt;2&lt;/span&gt;
&lt;span class='line-number'&gt;3&lt;/span&gt;
&lt;span class='line-number'&gt;4&lt;/span&gt;
&lt;span class='line-number'&gt;5&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;td class='code'&gt;&lt;pre&gt;&lt;code class='rb'&gt;&lt;span class='line'&gt;&lt;span class='no'&gt;VCR&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;configure&lt;/span&gt; &lt;span class='k'&gt;do&lt;/span&gt; &lt;span class='o'&gt;|&lt;/span&gt;&lt;span class='n'&gt;c&lt;/span&gt;&lt;span class='o'&gt;|&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='n'&gt;c&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;after_http_request&lt;/span&gt; &lt;span class='k'&gt;do&lt;/span&gt; &lt;span class='o'&gt;|&lt;/span&gt;&lt;span class='n'&gt;request&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='n'&gt;response&lt;/span&gt;&lt;span class='o'&gt;|&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;    &lt;span class='no'&gt;Logger&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;log_http_request&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;request&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='n'&gt;response&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='k'&gt;end&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;&lt;span class='k'&gt;end&lt;/span&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/figure&gt;&lt;/div&gt;&lt;/notextile&gt;&lt;/div&gt;
&lt;p&gt;You can also use a request hook to globally handle all requests made to a specific API:&lt;/p&gt;
&lt;div class='bogus-wrapper'&gt;&lt;notextile&gt;&lt;div class='code-wrap'&gt;&lt;figure class='code'&gt;&lt;figcaption&gt;&lt;span&gt;handle_geocoding_requests.rb &lt;/span&gt;&lt;/figcaption&gt;
 &lt;div class='highlight'&gt;&lt;table&gt;&lt;tr&gt;&lt;td class='gutter'&gt;&lt;pre class='line-numbers'&gt;&lt;span class='line-number'&gt;1&lt;/span&gt;
&lt;span class='line-number'&gt;2&lt;/span&gt;
&lt;span class='line-number'&gt;3&lt;/span&gt;
&lt;span class='line-number'&gt;4&lt;/span&gt;
&lt;span class='line-number'&gt;5&lt;/span&gt;
&lt;span class='line-number'&gt;6&lt;/span&gt;
&lt;span class='line-number'&gt;7&lt;/span&gt;
&lt;span class='line-number'&gt;8&lt;/span&gt;
&lt;span class='line-number'&gt;9&lt;/span&gt;
&lt;span class='line-number'&gt;10&lt;/span&gt;
&lt;span class='line-number'&gt;11&lt;/span&gt;
&lt;span class='line-number'&gt;12&lt;/span&gt;
&lt;span class='line-number'&gt;13&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;td class='code'&gt;&lt;pre&gt;&lt;code class='rb'&gt;&lt;span class='line'&gt;&lt;span class='no'&gt;VCR&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;configure&lt;/span&gt; &lt;span class='k'&gt;do&lt;/span&gt; &lt;span class='o'&gt;|&lt;/span&gt;&lt;span class='n'&gt;c&lt;/span&gt;&lt;span class='o'&gt;|&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='n'&gt;c&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;around_http_request&lt;/span&gt; &lt;span class='k'&gt;do&lt;/span&gt; &lt;span class='o'&gt;|&lt;/span&gt;&lt;span class='n'&gt;request&lt;/span&gt;&lt;span class='o'&gt;|&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;    &lt;span class='n'&gt;uri&lt;/span&gt; &lt;span class='o'&gt;=&lt;/span&gt; &lt;span class='no'&gt;URI&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;request&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;uri&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;    &lt;span class='k'&gt;if&lt;/span&gt; &lt;span class='n'&gt;uri&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;host&lt;/span&gt; &lt;span class='o'&gt;==&lt;/span&gt; &lt;span class='s1'&gt;&amp;#39;api.geocoder.com&amp;#39;&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;      &lt;span class='c1'&gt;# extract an address like &amp;quot;1700 E Pine St, Seattle, WA&amp;quot;&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;      &lt;span class='c1'&gt;# from a query like &amp;quot;address=1700+E+Pine+St%2C+Seattle%2C+WA&amp;quot;&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;      &lt;span class='n'&gt;address&lt;/span&gt; &lt;span class='o'&gt;=&lt;/span&gt; &lt;span class='no'&gt;CGI&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;unescape&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;uri&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;query&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;split&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='s1'&gt;&amp;#39;=&amp;#39;&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;last&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;      &lt;span class='no'&gt;VCR&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;use_cassette&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='s2'&gt;&amp;quot;geocoding/&lt;/span&gt;&lt;span class='si'&gt;#{&lt;/span&gt;&lt;span class='n'&gt;address&lt;/span&gt;&lt;span class='si'&gt;}&lt;/span&gt;&lt;span class='s2'&gt;&amp;quot;&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='o'&gt;&amp;amp;&lt;/span&gt;&lt;span class='n'&gt;request&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;    &lt;span class='k'&gt;else&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;      &lt;span class='n'&gt;request&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;proceed&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;    &lt;span class='k'&gt;end&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='k'&gt;end&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;&lt;span class='k'&gt;end&lt;/span&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/figure&gt;&lt;/div&gt;&lt;/notextile&gt;&lt;/div&gt;
&lt;p&gt;In an &lt;code&gt;around_http_request&lt;/code&gt;, you can either treat the request as a proc (and pass it on to a method that expects a block as &lt;code&gt;&amp;amp;request&lt;/code&gt;), or use &lt;code&gt;request.proceed&lt;/code&gt; to allow the request to continue.&lt;/p&gt;

&lt;p&gt;I certainly wouldn&amp;#8217;t recommend doing this for all requests&amp;#8211;you&amp;#8217;ll often want to test the same requests getting different responses in different tests&amp;#8211;but for truly stateless APIs that always return the same response for a given request (such as a geocoder) this can be very handy.&lt;/p&gt;

&lt;p&gt;On ruby 1.8 you won&amp;#8217;t be able to use an &lt;code&gt;around_http_request&lt;/code&gt; hook because it uses a fiber; instead you can use separate &lt;code&gt;before_http_request&lt;/code&gt; and &lt;code&gt;after_http_request&lt;/code&gt; to achieve the same behavior.&lt;/p&gt;

&lt;h2 id='ignore_a_request_based_on_anything'&gt;Ignore a Request Based on Anything&lt;/h2&gt;

&lt;p&gt;VCR 1.x made it simple to ignore a request based on the host:&lt;/p&gt;
&lt;div class='bogus-wrapper'&gt;&lt;notextile&gt;&lt;div class='code-wrap'&gt;&lt;figure class='code'&gt;&lt;figcaption&gt;&lt;span&gt;vcr_setup.rb &lt;/span&gt;&lt;/figcaption&gt;
 &lt;div class='highlight'&gt;&lt;table&gt;&lt;tr&gt;&lt;td class='gutter'&gt;&lt;pre class='line-numbers'&gt;&lt;span class='line-number'&gt;1&lt;/span&gt;
&lt;span class='line-number'&gt;2&lt;/span&gt;
&lt;span class='line-number'&gt;3&lt;/span&gt;
&lt;span class='line-number'&gt;4&lt;/span&gt;
&lt;span class='line-number'&gt;5&lt;/span&gt;
&lt;span class='line-number'&gt;6&lt;/span&gt;
&lt;span class='line-number'&gt;7&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;td class='code'&gt;&lt;pre&gt;&lt;code class='rb'&gt;&lt;span class='line'&gt;&lt;span class='no'&gt;VCR&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;configure&lt;/span&gt; &lt;span class='k'&gt;do&lt;/span&gt; &lt;span class='o'&gt;|&lt;/span&gt;&lt;span class='n'&gt;c&lt;/span&gt;&lt;span class='o'&gt;|&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='n'&gt;c&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;ignore_localhost&lt;/span&gt; &lt;span class='o'&gt;=&lt;/span&gt; &lt;span class='kp'&gt;true&lt;/span&gt; &lt;span class='c1'&gt;# to ignore 127.0.0.1 and localhost requests&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='c1'&gt;# or...&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='n'&gt;c&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;ignore_hosts&lt;/span&gt; &lt;span class='s1'&gt;&amp;#39;foo.com&amp;#39;&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='s1'&gt;&amp;#39;bar.com&amp;#39;&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;&lt;span class='k'&gt;end&lt;/span&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/figure&gt;&lt;/div&gt;&lt;/notextile&gt;&lt;/div&gt;
&lt;p&gt;This worked great for most people, but some wanted to &lt;a href='https://github.com/myronmarston/vcr/issues/42'&gt;selectively ignore localhost requests based on port&lt;/a&gt;. VCR 2.0 now lets you ignore a request based on &lt;em&gt;anything&lt;/em&gt;, by providing a block that returns a truthy value if the given request should be ignored. Here&amp;#8217;s how you can ignore only localhost requests to port 7500:&lt;/p&gt;
&lt;div class='bogus-wrapper'&gt;&lt;notextile&gt;&lt;div class='code-wrap'&gt;&lt;figure class='code'&gt;&lt;figcaption&gt;&lt;span&gt;ignore_request.rb &lt;/span&gt;&lt;/figcaption&gt;
 &lt;div class='highlight'&gt;&lt;table&gt;&lt;tr&gt;&lt;td class='gutter'&gt;&lt;pre class='line-numbers'&gt;&lt;span class='line-number'&gt;1&lt;/span&gt;
&lt;span class='line-number'&gt;2&lt;/span&gt;
&lt;span class='line-number'&gt;3&lt;/span&gt;
&lt;span class='line-number'&gt;4&lt;/span&gt;
&lt;span class='line-number'&gt;5&lt;/span&gt;
&lt;span class='line-number'&gt;6&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;td class='code'&gt;&lt;pre&gt;&lt;code class='rb'&gt;&lt;span class='line'&gt;&lt;span class='no'&gt;VCR&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;configure&lt;/span&gt; &lt;span class='k'&gt;do&lt;/span&gt; &lt;span class='o'&gt;|&lt;/span&gt;&lt;span class='n'&gt;c&lt;/span&gt;&lt;span class='o'&gt;|&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='n'&gt;c&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;ignore_request&lt;/span&gt; &lt;span class='k'&gt;do&lt;/span&gt; &lt;span class='o'&gt;|&lt;/span&gt;&lt;span class='n'&gt;request&lt;/span&gt;&lt;span class='o'&gt;|&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;    &lt;span class='n'&gt;uri&lt;/span&gt; &lt;span class='o'&gt;=&lt;/span&gt; &lt;span class='no'&gt;URI&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;request&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;uri&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;    &lt;span class='n'&gt;uri&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;host&lt;/span&gt; &lt;span class='o'&gt;==&lt;/span&gt; &lt;span class='s1'&gt;&amp;#39;localhost&amp;#39;&lt;/span&gt; &lt;span class='o'&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class='n'&gt;uri&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;port&lt;/span&gt; &lt;span class='o'&gt;==&lt;/span&gt; &lt;span class='mi'&gt;7500&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='k'&gt;end&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;&lt;span class='k'&gt;end&lt;/span&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/figure&gt;&lt;/div&gt;&lt;/notextile&gt;&lt;/div&gt;
&lt;h2 id='improved_unhandled_request_error_messages'&gt;Improved Unhandled Request Error Messages&lt;/h2&gt;

&lt;p&gt;If you&amp;#8217;ve used VCR 1.x, you&amp;#8217;ve undoubtedly gotten an error like this:&lt;/p&gt;
&lt;div class='bogus-wrapper'&gt;&lt;notextile&gt;&lt;div class='code-wrap'&gt;&lt;figure class='code'&gt;&lt;figcaption&gt;&lt;span&gt;vcr_1_x_error.txt  &lt;/span&gt;&lt;/figcaption&gt;
 &lt;div class='highlight'&gt;&lt;table&gt;&lt;tr&gt;&lt;td class='gutter'&gt;&lt;pre class='line-numbers'&gt;&lt;span class='line-number'&gt;1&lt;/span&gt;
&lt;span class='line-number'&gt;2&lt;/span&gt;
&lt;span class='line-number'&gt;3&lt;/span&gt;
&lt;span class='line-number'&gt;4&lt;/span&gt;
&lt;span class='line-number'&gt;5&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;td class='code'&gt;&lt;pre&gt;&lt;code class='sh'&gt;&lt;span class='line'&gt;Real HTTP connections are disabled. Unregistered request: GET
&lt;/span&gt;&lt;span class='line'&gt;http://api.somehost.com/widgets.  You can use VCR to automatically
&lt;/span&gt;&lt;span class='line'&gt;record this request and replay it later.  For more details, visit
&lt;/span&gt;&lt;span class='line'&gt;the VCR documentation at: http://relishapp.com/myronmarston/vcr/v/1-11-3
&lt;/span&gt;&lt;span class='line'&gt;&lt;span class='o'&gt;(&lt;/span&gt;FakeWeb::NetConnectNotAllowedError&lt;span class='o'&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/figure&gt;&lt;/div&gt;&lt;/notextile&gt;&lt;/div&gt;
&lt;p&gt;You get this kind of error when a request is made that VCR does not know how to handle. There are a lot of different ways you can fix the error, but the message doesn&amp;#8217;t give you much help.&lt;/p&gt;

&lt;p&gt;In VCR 2.0, you&amp;#8217;ll get a more helpful error message:&lt;/p&gt;
&lt;div class='bogus-wrapper'&gt;&lt;notextile&gt;&lt;div class='code-wrap'&gt;&lt;figure class='code'&gt;&lt;figcaption&gt;&lt;span&gt;example_error.txt  &lt;/span&gt;&lt;/figcaption&gt;
 &lt;div class='highlight'&gt;&lt;table&gt;&lt;tr&gt;&lt;td class='gutter'&gt;&lt;pre class='line-numbers'&gt;&lt;span class='line-number'&gt;1&lt;/span&gt;
&lt;span class='line-number'&gt;2&lt;/span&gt;
&lt;span class='line-number'&gt;3&lt;/span&gt;
&lt;span class='line-number'&gt;4&lt;/span&gt;
&lt;span class='line-number'&gt;5&lt;/span&gt;
&lt;span class='line-number'&gt;6&lt;/span&gt;
&lt;span class='line-number'&gt;7&lt;/span&gt;
&lt;span class='line-number'&gt;8&lt;/span&gt;
&lt;span class='line-number'&gt;9&lt;/span&gt;
&lt;span class='line-number'&gt;10&lt;/span&gt;
&lt;span class='line-number'&gt;11&lt;/span&gt;
&lt;span class='line-number'&gt;12&lt;/span&gt;
&lt;span class='line-number'&gt;13&lt;/span&gt;
&lt;span class='line-number'&gt;14&lt;/span&gt;
&lt;span class='line-number'&gt;15&lt;/span&gt;
&lt;span class='line-number'&gt;16&lt;/span&gt;
&lt;span class='line-number'&gt;17&lt;/span&gt;
&lt;span class='line-number'&gt;18&lt;/span&gt;
&lt;span class='line-number'&gt;19&lt;/span&gt;
&lt;span class='line-number'&gt;20&lt;/span&gt;
&lt;span class='line-number'&gt;21&lt;/span&gt;
&lt;span class='line-number'&gt;22&lt;/span&gt;
&lt;span class='line-number'&gt;23&lt;/span&gt;
&lt;span class='line-number'&gt;24&lt;/span&gt;
&lt;span class='line-number'&gt;25&lt;/span&gt;
&lt;span class='line-number'&gt;26&lt;/span&gt;
&lt;span class='line-number'&gt;27&lt;/span&gt;
&lt;span class='line-number'&gt;28&lt;/span&gt;
&lt;span class='line-number'&gt;29&lt;/span&gt;
&lt;span class='line-number'&gt;30&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;td class='code'&gt;&lt;pre&gt;&lt;code class='sh'&gt;&lt;span class='line'&gt;&lt;span class='o'&gt;================================================================================&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;An HTTP request has been made that VCR does not know how to handle:
&lt;/span&gt;&lt;span class='line'&gt;  GET http://api.somehost.com/widgets
&lt;/span&gt;&lt;span class='line'&gt;
&lt;/span&gt;&lt;span class='line'&gt;VCR is currently using the following cassette:
&lt;/span&gt;&lt;span class='line'&gt;  - cassettes/widgets.yml
&lt;/span&gt;&lt;span class='line'&gt;  - :record &lt;span class='o'&gt;=&lt;/span&gt;&amp;gt; :once
&lt;/span&gt;&lt;span class='line'&gt;  - :match_requests_on &lt;span class='o'&gt;=&lt;/span&gt;&amp;gt; &lt;span class='o'&gt;[&lt;/span&gt;:method, :uri&lt;span class='o'&gt;]&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;
&lt;/span&gt;&lt;span class='line'&gt;Under the current configuration VCR can not find a suitable HTTP interaction
&lt;/span&gt;&lt;span class='line'&gt;to replay and is prevented from recording new requests. There are a few ways
&lt;/span&gt;&lt;span class='line'&gt;you can deal with this:
&lt;/span&gt;&lt;span class='line'&gt;
&lt;/span&gt;&lt;span class='line'&gt;  * You can use the :new_episodes record mode to allow VCR to
&lt;/span&gt;&lt;span class='line'&gt;    record this new request to the existing cassette &lt;span class='o'&gt;[&lt;/span&gt;1&lt;span class='o'&gt;]&lt;/span&gt;.
&lt;/span&gt;&lt;span class='line'&gt;  * If you want VCR to ignore this request &lt;span class='o'&gt;(&lt;/span&gt;and others like it&lt;span class='o'&gt;)&lt;/span&gt;, you can
&lt;/span&gt;&lt;span class='line'&gt;    &lt;span class='nb'&gt;set &lt;/span&gt;an &lt;span class='sb'&gt;`&lt;/span&gt;ignore_request&lt;span class='sb'&gt;`&lt;/span&gt; callback &lt;span class='o'&gt;[&lt;/span&gt;2&lt;span class='o'&gt;]&lt;/span&gt;.
&lt;/span&gt;&lt;span class='line'&gt;  * The current record mode &lt;span class='o'&gt;(&lt;/span&gt;:once&lt;span class='o'&gt;)&lt;/span&gt; does not allow new requests to be recorded
&lt;/span&gt;&lt;span class='line'&gt;    to a previously recorded cassette. You can delete the cassette file and re-run
&lt;/span&gt;&lt;span class='line'&gt;    your tests to allow the cassette to be recorded with this request &lt;span class='o'&gt;[&lt;/span&gt;3&lt;span class='o'&gt;]&lt;/span&gt;.
&lt;/span&gt;&lt;span class='line'&gt;  * The cassette contains 1 HTTP interaction that has not been
&lt;/span&gt;&lt;span class='line'&gt;    played back. If your request is non-deterministic, you may need to
&lt;/span&gt;&lt;span class='line'&gt;    change your :match_requests_on cassette option to be more lenient
&lt;/span&gt;&lt;span class='line'&gt;    or use a custom request matcher to allow it to match &lt;span class='o'&gt;[&lt;/span&gt;4&lt;span class='o'&gt;]&lt;/span&gt;.
&lt;/span&gt;&lt;span class='line'&gt;
&lt;/span&gt;&lt;span class='line'&gt;&lt;span class='o'&gt;[&lt;/span&gt;1&lt;span class='o'&gt;]&lt;/span&gt; https://www.relishapp.com/myronmarston/vcr/v/2-0-0-rc1/docs/record-modes/new-episodes
&lt;/span&gt;&lt;span class='line'&gt;&lt;span class='o'&gt;[&lt;/span&gt;2&lt;span class='o'&gt;]&lt;/span&gt; https://www.relishapp.com/myronmarston/vcr/v/2-0-0-rc1/docs/configuration/ignore-request
&lt;/span&gt;&lt;span class='line'&gt;&lt;span class='o'&gt;[&lt;/span&gt;3&lt;span class='o'&gt;]&lt;/span&gt; https://www.relishapp.com/myronmarston/vcr/v/2-0-0-rc1/docs/record-modes/once
&lt;/span&gt;&lt;span class='line'&gt;&lt;span class='o'&gt;[&lt;/span&gt;4&lt;span class='o'&gt;]&lt;/span&gt; https://www.relishapp.com/myronmarston/vcr/v/2-0-0-rc1/docs/request-matching
&lt;/span&gt;&lt;span class='line'&gt;&lt;span class='o'&gt;================================================================================&lt;/span&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/figure&gt;&lt;/div&gt;&lt;/notextile&gt;&lt;/div&gt;
&lt;h2 id='integration_with_rspec_2_metadata'&gt;Integration with RSpec 2 Metadata&lt;/h2&gt;

&lt;p&gt;&lt;a href='http://twitter.com/rbates'&gt;Ryan Bates&lt;/a&gt; had this &lt;a href='https://gist.github.com/1212530'&gt;great idea&lt;/a&gt; to integrate VCR with RSpec 2 using metadata. VCR 2.0 now provides direct support for this:&lt;/p&gt;
&lt;div class='bogus-wrapper'&gt;&lt;notextile&gt;&lt;div class='code-wrap'&gt;&lt;figure class='code'&gt;&lt;figcaption&gt;&lt;span&gt;vcr_rspec_metadata.rb &lt;/span&gt;&lt;/figcaption&gt;
 &lt;div class='highlight'&gt;&lt;table&gt;&lt;tr&gt;&lt;td class='gutter'&gt;&lt;pre class='line-numbers'&gt;&lt;span class='line-number'&gt;1&lt;/span&gt;
&lt;span class='line-number'&gt;2&lt;/span&gt;
&lt;span class='line-number'&gt;3&lt;/span&gt;
&lt;span class='line-number'&gt;4&lt;/span&gt;
&lt;span class='line-number'&gt;5&lt;/span&gt;
&lt;span class='line-number'&gt;6&lt;/span&gt;
&lt;span class='line-number'&gt;7&lt;/span&gt;
&lt;span class='line-number'&gt;8&lt;/span&gt;
&lt;span class='line-number'&gt;9&lt;/span&gt;
&lt;span class='line-number'&gt;10&lt;/span&gt;
&lt;span class='line-number'&gt;11&lt;/span&gt;
&lt;span class='line-number'&gt;12&lt;/span&gt;
&lt;span class='line-number'&gt;13&lt;/span&gt;
&lt;span class='line-number'&gt;14&lt;/span&gt;
&lt;span class='line-number'&gt;15&lt;/span&gt;
&lt;span class='line-number'&gt;16&lt;/span&gt;
&lt;span class='line-number'&gt;17&lt;/span&gt;
&lt;span class='line-number'&gt;18&lt;/span&gt;
&lt;span class='line-number'&gt;19&lt;/span&gt;
&lt;span class='line-number'&gt;20&lt;/span&gt;
&lt;span class='line-number'&gt;21&lt;/span&gt;
&lt;span class='line-number'&gt;22&lt;/span&gt;
&lt;span class='line-number'&gt;23&lt;/span&gt;
&lt;span class='line-number'&gt;24&lt;/span&gt;
&lt;span class='line-number'&gt;25&lt;/span&gt;
&lt;span class='line-number'&gt;26&lt;/span&gt;
&lt;span class='line-number'&gt;27&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;td class='code'&gt;&lt;pre&gt;&lt;code class='rb'&gt;&lt;span class='line'&gt;&lt;span class='no'&gt;VCR&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;configure&lt;/span&gt; &lt;span class='k'&gt;do&lt;/span&gt; &lt;span class='o'&gt;|&lt;/span&gt;&lt;span class='n'&gt;c&lt;/span&gt;&lt;span class='o'&gt;|&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='n'&gt;c&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;configure_rspec_metadata!&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;&lt;span class='k'&gt;end&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;
&lt;/span&gt;&lt;span class='line'&gt;&lt;span class='no'&gt;RSpec&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;configure&lt;/span&gt; &lt;span class='k'&gt;do&lt;/span&gt; &lt;span class='o'&gt;|&lt;/span&gt;&lt;span class='n'&gt;c&lt;/span&gt;&lt;span class='o'&gt;|&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='c1'&gt;# so we can use `:vcr` rather than `:vcr =&amp;gt; true`;&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='c1'&gt;# in RSpec 3 this will no longer be necessary.&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='n'&gt;c&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;treat_symbols_as_metadata_keys_with_true_values&lt;/span&gt; &lt;span class='o'&gt;=&lt;/span&gt; &lt;span class='kp'&gt;true&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;&lt;span class='k'&gt;end&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;
&lt;/span&gt;&lt;span class='line'&gt;&lt;span class='c1'&gt;# apply it to an example group&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;&lt;span class='n'&gt;describe&lt;/span&gt; &lt;span class='no'&gt;MyAPIWrapper&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='ss'&gt;:vcr&lt;/span&gt; &lt;span class='k'&gt;do&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;&lt;span class='k'&gt;end&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;
&lt;/span&gt;&lt;span class='line'&gt;&lt;span class='n'&gt;describe&lt;/span&gt; &lt;span class='no'&gt;MyAPIWrapper&lt;/span&gt; &lt;span class='k'&gt;do&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='c1'&gt;# apply it to an individual example&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='n'&gt;it&lt;/span&gt; &lt;span class='s2'&gt;&amp;quot;does something&amp;quot;&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='ss'&gt;:vcr&lt;/span&gt; &lt;span class='k'&gt;do&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='k'&gt;end&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='c1'&gt;# set some cassette options&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='n'&gt;it&lt;/span&gt; &lt;span class='s2'&gt;&amp;quot;does something&amp;quot;&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='ss'&gt;:vcr&lt;/span&gt; &lt;span class='o'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='p'&gt;{&lt;/span&gt; &lt;span class='ss'&gt;:record&lt;/span&gt; &lt;span class='o'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='ss'&gt;:new_episodes&lt;/span&gt; &lt;span class='p'&gt;}&lt;/span&gt; &lt;span class='k'&gt;do&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='k'&gt;end&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='c1'&gt;# override the cassette name&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='n'&gt;it&lt;/span&gt; &lt;span class='s2'&gt;&amp;quot;does something&amp;quot;&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='ss'&gt;:vcr&lt;/span&gt; &lt;span class='o'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='p'&gt;{&lt;/span&gt; &lt;span class='ss'&gt;:cassette_name&lt;/span&gt; &lt;span class='o'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='s2'&gt;&amp;quot;something&amp;quot;&lt;/span&gt; &lt;span class='p'&gt;}&lt;/span&gt; &lt;span class='k'&gt;do&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='k'&gt;end&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;&lt;span class='k'&gt;end&lt;/span&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/figure&gt;&lt;/div&gt;&lt;/notextile&gt;&lt;/div&gt;
&lt;p&gt;The old &lt;a href='https://www.relishapp.com/myronmarston/vcr/docs/test-frameworks/usage-with-rspec-macro'&gt;&lt;code&gt;use_vcr_cassette&lt;/code&gt; macro&lt;/a&gt; still works. The primary difference is that the macro uses the same cassette for each example in an example group, while the metadata uses a different cassette for each individual example.&lt;/p&gt;

&lt;h2 id='exclusive_cassettes'&gt;Exclusive cassettes&lt;/h2&gt;

&lt;p&gt;VCR has always allowed you to &amp;#8220;nest&amp;#8221; cassettes; for example, you may use a cassette for an entire cucumber scenario and then also use a cassette in an individual step definition. When you do this, requests may be handled by an HTTP interaction from the outer cassette if there is not an HTTP interaction from the inner cassette that matches.&lt;/p&gt;

&lt;p&gt;If you do not want to allow the matching to &amp;#8220;fall through&amp;#8221; to the outer cassette you can use the new &lt;code&gt;:exclusive&lt;/code&gt; option:&lt;/p&gt;
&lt;div class='bogus-wrapper'&gt;&lt;notextile&gt;&lt;div class='code-wrap'&gt;&lt;figure class='code'&gt;&lt;figcaption&gt;&lt;span&gt;exclusive_cassette.rb &lt;/span&gt;&lt;/figcaption&gt;
 &lt;div class='highlight'&gt;&lt;table&gt;&lt;tr&gt;&lt;td class='gutter'&gt;&lt;pre class='line-numbers'&gt;&lt;span class='line-number'&gt;1&lt;/span&gt;
&lt;span class='line-number'&gt;2&lt;/span&gt;
&lt;span class='line-number'&gt;3&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;td class='code'&gt;&lt;pre&gt;&lt;code class='rb'&gt;&lt;span class='line'&gt;&lt;span class='no'&gt;VCR&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;use_cassette&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='s1'&gt;&amp;#39;my_cassette&amp;#39;&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='ss'&gt;:exclusive&lt;/span&gt; &lt;span class='o'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='kp'&gt;true&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt; &lt;span class='k'&gt;do&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='c1'&gt;# ...&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;&lt;span class='k'&gt;end&lt;/span&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/figure&gt;&lt;/div&gt;&lt;/notextile&gt;&lt;/div&gt;
&lt;h2 id='vcr_200_final'&gt;VCR 2.0.0 Final&lt;/h2&gt;

&lt;p&gt;I plan to release VCR 2.0.0 final in a couple of weeks. Please give the RC a try and give me feedback!&lt;/p&gt;</content>
  </entry>
  
  <entry>
    <title>Cassettes in VCR 2.0</title>
    <link href="http://myronmars.to/n/dev-blog/2011/11/cassettes-in-vcr-2-0"/>
    <updated>2011-11-07T00:00:00-08:00</updated>
    <id>http://myronmars.to/n/dev-blog/2011/11/cassettes-in-vcr-2-0</id>
    <content type="html">&lt;p&gt;The first beta release of VCR 2.0 was focused on &lt;a href='/n/dev-blog/2011/10/custom-request-matchers-in-vcr-2-0'&gt;improving how the request matchers work&lt;/a&gt; so users can easily customize them to their needs.&lt;/p&gt;

&lt;p&gt;The second beta, released yesterday, includes a bunch of changes to the cassette format. Unfortunately, cassettes recorded with VCR 1.x are not compatible with VCR 2.0. I imagine this may make upgrading painful for some users (though, I&amp;#8217;m hopeful the pain will be minimal), and I thought it worthwhile to explain the reasons for all the changes.&lt;/p&gt;

&lt;h2 id='yaml_issues'&gt;YAML issues&lt;/h2&gt;

&lt;p&gt;&lt;a href='http://yaml.org/'&gt;YAML&lt;/a&gt; is a great serialization format. It&amp;#8217;s the most human-readable and human-editable format I know of (both of which I consider to be very important for VCR). It&amp;#8217;s been the only serialization format for VCR cassettes from the first release.&lt;/p&gt;

&lt;p&gt;However, it&amp;#8217;s not without issues. Syck, the YAML engine in ruby 1.8, has a number of unfortunate bugs. I&amp;#8217;ve had &lt;a href='https://github.com/myronmarston/vcr/issues/4'&gt;multiple&lt;/a&gt; &lt;a href='https://github.com/myronmarston/vcr/issues/39'&gt;reports&lt;/a&gt; of syck segfaulting due to particular data in the VCR cassette. In addition, it &lt;a href='https://gist.github.com/815754'&gt;removes spaces from whitespace-only lines&lt;/a&gt;. A string like &lt;code&gt;&amp;quot;1\n
\n2&amp;quot;&lt;/code&gt;, when round-tripped through syck, results in &lt;code&gt;&amp;quot;1\n\n2&amp;quot;&lt;/code&gt;&amp;#8211;a string of one less character. This can cause problems for HTTP clients that depend on the &amp;#8220;Content-Length&amp;#8221; header accurately matching the length of the response body. Mechanize, for example, will raise an error.&lt;/p&gt;

&lt;p&gt;Psych, the new YAML engine in ruby 1.9 written by &lt;a href='http://twitter.com/tenderlove'&gt;tenderlove&lt;/a&gt;, is much improved. Since 1.7.0, VCR has attempted to use psych when it is avaiable. However, psych also occasionally has &lt;a href='https://github.com/myronmarston/vcr/issues/74'&gt;segfaulting&lt;/a&gt;/&lt;a href='https://github.com/myronmarston/vcr/issues/83'&gt;memory corruption&lt;/a&gt; issues.&lt;/p&gt;

&lt;h2 id='new_serializers'&gt;New Serializers!&lt;/h2&gt;

&lt;p&gt;VCR 2.0 allows you to choose from several different serializers, or even provide your own. This can be useful to work around an issue with either sych or psych, or simply because you prefer another format (e.g. JSON). VCR 2.0 now has 4 built in serializers:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;YAML&lt;/li&gt;

&lt;li&gt;Syck&lt;/li&gt;

&lt;li&gt;Psych&lt;/li&gt;

&lt;li&gt;JSON&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;YAML is still the default, and uses the standard library &lt;code&gt;YAML&lt;/code&gt; after requiring &amp;#8220;yaml&amp;#8221;. This could wind up using either syck or psych, depending upon your ruby interpreter. The Syck and Psych serializers are useful as a way to force those libraries to be used. Syck is particularly useful when you have a project that needs to run on 1.8 and 1.9, so that the same YAML library gets used regardless of the ruby interpreter version. The JSON serializer uses &lt;a href='https://github.com/intridea/multi_json'&gt;multi_json&lt;/a&gt; so that it supports a variety of JSON backends.&lt;/p&gt;

&lt;p&gt;Here&amp;#8217;s how to pick a serializer:&lt;/p&gt;
&lt;div class='bogus-wrapper'&gt;&lt;notextile&gt;&lt;div class='code-wrap'&gt;&lt;figure class='code'&gt;&lt;figcaption&gt;&lt;span&gt;serialize_with_json.rb &lt;/span&gt;&lt;/figcaption&gt;
 &lt;div class='highlight'&gt;&lt;table&gt;&lt;tr&gt;&lt;td class='gutter'&gt;&lt;pre class='line-numbers'&gt;&lt;span class='line-number'&gt;1&lt;/span&gt;
&lt;span class='line-number'&gt;2&lt;/span&gt;
&lt;span class='line-number'&gt;3&lt;/span&gt;
&lt;span class='line-number'&gt;4&lt;/span&gt;
&lt;span class='line-number'&gt;5&lt;/span&gt;
&lt;span class='line-number'&gt;6&lt;/span&gt;
&lt;span class='line-number'&gt;7&lt;/span&gt;
&lt;span class='line-number'&gt;8&lt;/span&gt;
&lt;span class='line-number'&gt;9&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;td class='code'&gt;&lt;pre&gt;&lt;code class='rb'&gt;&lt;span class='line'&gt;&lt;span class='c1'&gt;# use the JSON serializer for a particular cassette...&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;&lt;span class='no'&gt;VCR&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;use_cassette&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='s2'&gt;&amp;quot;example&amp;quot;&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='ss'&gt;:serialize_with&lt;/span&gt; &lt;span class='o'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='ss'&gt;:json&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt; &lt;span class='k'&gt;do&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='c1'&gt;# make an HTTP request&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;&lt;span class='k'&gt;end&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;
&lt;/span&gt;&lt;span class='line'&gt;&lt;span class='c1'&gt;# ...or use the JSON serializer for all cassettes&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;&lt;span class='no'&gt;VCR&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;configure&lt;/span&gt; &lt;span class='k'&gt;do&lt;/span&gt; &lt;span class='o'&gt;|&lt;/span&gt;&lt;span class='n'&gt;config&lt;/span&gt;&lt;span class='o'&gt;|&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='n'&gt;config&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;default_cassette_options&lt;/span&gt; &lt;span class='o'&gt;=&lt;/span&gt; &lt;span class='p'&gt;{&lt;/span&gt; &lt;span class='ss'&gt;:serialize_with&lt;/span&gt; &lt;span class='o'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='ss'&gt;:json&lt;/span&gt; &lt;span class='p'&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;&lt;span class='k'&gt;end&lt;/span&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/figure&gt;&lt;/div&gt;&lt;/notextile&gt;&lt;/div&gt;
&lt;h2 id='providing_your_own_custom_serializer'&gt;Providing Your Own Custom Serializer&lt;/h2&gt;

&lt;p&gt;It&amp;#8217;s fairly trivial to provide your own serializer. You need to provide an object that implements three methods:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;code&gt;file_extension&lt;/code&gt;&lt;/li&gt;

&lt;li&gt;&lt;code&gt;serialize(hash)&lt;/code&gt;&lt;/li&gt;

&lt;li&gt;&lt;code&gt;deserialize(string)&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Here&amp;#8217;s an example using ruby&amp;#8217;s marshal library:&lt;/p&gt;
&lt;div class='bogus-wrapper'&gt;&lt;notextile&gt;&lt;div class='code-wrap'&gt;&lt;figure class='code'&gt;&lt;figcaption&gt;&lt;span&gt;marshal_serializer.rb &lt;/span&gt;&lt;/figcaption&gt;
 &lt;div class='highlight'&gt;&lt;table&gt;&lt;tr&gt;&lt;td class='gutter'&gt;&lt;pre class='line-numbers'&gt;&lt;span class='line-number'&gt;1&lt;/span&gt;
&lt;span class='line-number'&gt;2&lt;/span&gt;
&lt;span class='line-number'&gt;3&lt;/span&gt;
&lt;span class='line-number'&gt;4&lt;/span&gt;
&lt;span class='line-number'&gt;5&lt;/span&gt;
&lt;span class='line-number'&gt;6&lt;/span&gt;
&lt;span class='line-number'&gt;7&lt;/span&gt;
&lt;span class='line-number'&gt;8&lt;/span&gt;
&lt;span class='line-number'&gt;9&lt;/span&gt;
&lt;span class='line-number'&gt;10&lt;/span&gt;
&lt;span class='line-number'&gt;11&lt;/span&gt;
&lt;span class='line-number'&gt;12&lt;/span&gt;
&lt;span class='line-number'&gt;13&lt;/span&gt;
&lt;span class='line-number'&gt;14&lt;/span&gt;
&lt;span class='line-number'&gt;15&lt;/span&gt;
&lt;span class='line-number'&gt;16&lt;/span&gt;
&lt;span class='line-number'&gt;17&lt;/span&gt;
&lt;span class='line-number'&gt;18&lt;/span&gt;
&lt;span class='line-number'&gt;19&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;td class='code'&gt;&lt;pre&gt;&lt;code class='rb'&gt;&lt;span class='line'&gt;&lt;span class='n'&gt;serializer&lt;/span&gt; &lt;span class='o'&gt;=&lt;/span&gt; &lt;span class='no'&gt;Object&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;new&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;&lt;span class='n'&gt;serializer&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;instance_eval&lt;/span&gt; &lt;span class='k'&gt;do&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='k'&gt;def&lt;/span&gt; &lt;span class='nf'&gt;file_extension&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;    &lt;span class='s2'&gt;&amp;quot;rb_marshal&amp;quot;&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='k'&gt;end&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='k'&gt;def&lt;/span&gt; &lt;span class='nf'&gt;serialize&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='nb'&gt;hash&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;    &lt;span class='no'&gt;Marshal&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;dump&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='nb'&gt;hash&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='k'&gt;end&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='k'&gt;def&lt;/span&gt; &lt;span class='nf'&gt;deserialize&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;string&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;    &lt;span class='no'&gt;Marshal&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;load&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;string&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='k'&gt;end&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;&lt;span class='k'&gt;end&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;
&lt;/span&gt;&lt;span class='line'&gt;&lt;span class='no'&gt;VCR&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;configure&lt;/span&gt; &lt;span class='k'&gt;do&lt;/span&gt; &lt;span class='o'&gt;|&lt;/span&gt;&lt;span class='n'&gt;config&lt;/span&gt;&lt;span class='o'&gt;|&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='n'&gt;config&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;cassette_serializers&lt;/span&gt;&lt;span class='o'&gt;[&lt;/span&gt;&lt;span class='ss'&gt;:marshal&lt;/span&gt;&lt;span class='o'&gt;]&lt;/span&gt; &lt;span class='o'&gt;=&lt;/span&gt; &lt;span class='n'&gt;serializer&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='n'&gt;config&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;default_cassette_options&lt;/span&gt; &lt;span class='o'&gt;=&lt;/span&gt; &lt;span class='p'&gt;{&lt;/span&gt; &lt;span class='ss'&gt;:serialize_with&lt;/span&gt; &lt;span class='o'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='ss'&gt;:marshal&lt;/span&gt; &lt;span class='p'&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;&lt;span class='k'&gt;end&lt;/span&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/figure&gt;&lt;/div&gt;&lt;/notextile&gt;&lt;/div&gt;
&lt;h2 id='cassettes_are_more_portable'&gt;Cassettes are More Portable&lt;/h2&gt;

&lt;p&gt;VCR 1.x serialized some structs directly to YAML. This caused the classes (&lt;code&gt;VCR::HTTPInteraction&lt;/code&gt;, &lt;code&gt;VCR::Request&lt;/code&gt; and &lt;code&gt;VCR::Response&lt;/code&gt;) to be named directly in the cassette. In 2.0, VCR passes a simple hash to the serializer, so these class names no longer show up in the cassette file. Besides making it possible to use different serializers, this also makes the VCR cassette format much more portable. You can read and use a VCR cassette without loading VCR now! It opens up the possibility to use a VCR cassette from other languages as well.&lt;/p&gt;

&lt;h2 id='now_with_less_normalization'&gt;Now With Less Normalization&lt;/h2&gt;

&lt;p&gt;VCR 1.x extensively normalized each HTTP Interaction. VCR originally only worked with FakeWeb and Net::HTTP. As I expanded VCR to work with many other libraries, I tried to ensure that the cassette that resulted from a particular set of recorded HTTP interactions would be the same, regardless of the HTTP client library or stubbing library used. At the time, it made sense to me that since a VCR cassette is agnostic about which HTTP client library was used, it should be the same for the same set of HTTP interactions. Net::HTTP normalizes header keys to lower case, so VCR 1.x performed the same normalization on the headers stored in the cassette. On playback, it would de-normalize as necessary; if the header key was &lt;code&gt;content-type&lt;/code&gt;, it would be de-normalized as &lt;code&gt;Content-Type&lt;/code&gt;. Theoretically, this would have allowed you to change your implementation to use a different HTTP library, and the VCR cassette should continue to playback just fine.&lt;/p&gt;

&lt;p&gt;Unfortunately, the de-normalization doesn&amp;#8217;t always work properly. If a header is recorded as &lt;code&gt;etag&lt;/code&gt;, it gets de-normalized to &lt;code&gt;Etag&lt;/code&gt; even though it may originally have been &lt;code&gt;ETag&lt;/code&gt;. This is in fact an &lt;a href='https://github.com/fog/fog/issues/434'&gt;issue when using VCR with Fog&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;So, in VCR 2.0, I&amp;#8217;ve removed this normalization. You&amp;#8217;ll see more variance in the data that gets recorded by an identical HTTP request from different HTTP libraries.&lt;/p&gt;

&lt;h2 id='new__metadata'&gt;New &lt;code&gt;recorded_at&lt;/code&gt; metadata&lt;/h2&gt;

&lt;p&gt;VCR 2.0 now includes a &lt;code&gt;recorded_at&lt;/code&gt; timestamp for each HTTP Interaction. This allows the &lt;code&gt;re_record_interval&lt;/code&gt; cassette option to work much more accurately. Previously, VCR used the cassette file&amp;#8217;s modification time, but this may not be accurate, especially when the file on disk changes due to your source control (i.e. if you change git branches or whatever).&lt;/p&gt;

&lt;h2 id='new__metadata'&gt;New &lt;code&gt;recorded_with&lt;/code&gt; metadata&lt;/h2&gt;

&lt;p&gt;VCR 2.0 also includes a bit of metadata about the cassette as a whole: &lt;code&gt;recorded_with&lt;/code&gt; will be a string like &lt;code&gt;&amp;quot;VCR 2.0.0&amp;quot;&lt;/code&gt;. Theoretically, if any other tool like VCR comes along and wanted to adopt the same fixture format, it could use this to identify itself as well.&lt;/p&gt;

&lt;p&gt;I&amp;#8217;ve wanted to make changes to the VCR cassette format for awhile, but have held off for fear of making breaking changes. This bit of metadata should make future format changes much easier to make in a backwards-compatible way, as it will identify the format version that was used to record the cassette so it can be easily and automatically upgraded.&lt;/p&gt;

&lt;h2 id='upgrading'&gt;Upgrading&lt;/h2&gt;

&lt;p&gt;The &lt;a href='https://www.relishapp.com/myronmarston/vcr/docs/upgrade'&gt;upgrade notes&lt;/a&gt; contain instructions for how to upgrade from VCR 1.x. If you&amp;#8217;re curious to see examples of how the cassette format changed, take a look at a &lt;a href='https://github.com/myronmarston/vcr/blob/v1.11.3/spec/fixtures/not_1.9.1/cassette_spec/example.yml'&gt;1.x cassette&lt;/a&gt; compared to the same cassette in &lt;a href='https://github.com/myronmarston/vcr/blob/v2.0.0.beta2/spec/fixtures/cassette_spec/example.yml'&gt;2.0 format&lt;/a&gt;.&lt;/p&gt;</content>
  </entry>
  
  <entry>
    <title>Recent RSpec Configuration Warnings and Errors</title>
    <link href="http://myronmars.to/n/dev-blog/2011/11/recent-rspec-configuration-warnings-and-errors"/>
    <updated>2011-11-04T00:00:00-07:00</updated>
    <id>http://myronmars.to/n/dev-blog/2011/11/recent-rspec-configuration-warnings-and-errors</id>
    <content type="html">&lt;p&gt;RSpec 2.6 introduced a deprecation warning when using &lt;code&gt;RSpec.configure {
... }&lt;/code&gt; after defining an example group. In RSpec 2.7, this warning was removed, and now an error is raised when particular configuration settings (&lt;code&gt;expect_with&lt;/code&gt; and &lt;code&gt;mock_with&lt;/code&gt;) are set after defining an example group.&lt;/p&gt;

&lt;p&gt;Recently, there have been comments and complaints on these changes from &lt;a href='http://twitter.com/#!/elight/status/112166313518039040'&gt;several&lt;/a&gt; &lt;a href='http://twitter.com/#!/stevenharman/status/132251947473444864'&gt;different&lt;/a&gt; &lt;a href='http://twitter.com/#!/pda/status/129116122074185728'&gt;people&lt;/a&gt; on &lt;a href='http://twitter.com/#!/kytrinyx/status/116773198833532928'&gt;twitter&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;I&amp;#8217;m the one who made those changes to RSpec, and people are rightfully annoyed with these changes&amp;#8230;but there&amp;#8217;s a lot more to the story. I&amp;#8217;m not sure what the right solution is to the problem I was trying to solve by making those changes, but I&amp;#8217;m hoping that by blogging about it, we can get some good ideas from the community.&lt;/p&gt;

&lt;h2 id='rspec_20'&gt;RSpec 2.0&lt;/h2&gt;

&lt;p&gt;One of the primary goals of RSpec 2 was to decouple the spec runner (rspec-core) from the mocking framework (rspec-mocks) and the expectation framework (rspec-expectations). Besides the fact that decoupling is A Good Thing&amp;#8482;, this separation opened up new possibilities for people to pick and choose which parts of RSpec they want to use.&lt;/p&gt;

&lt;p&gt;In particular, it allows people to use rspec-core to define and run their tests using RSpec&amp;#8217;s example definition DSL (&lt;code&gt;describe&lt;/code&gt;, &lt;code&gt;it&lt;/code&gt;, &lt;code&gt;before&lt;/code&gt;, &lt;code&gt;let&lt;/code&gt;, etc) while sticking with the &lt;code&gt;assert_foo&lt;/code&gt; assertion methods from Test::Unit or minitest, rather than using RSpec&amp;#8217;s &lt;code&gt;object.should whatever&lt;/code&gt; syntax. For better or worse, some people really dislike rspec-expectations but love the runner.&lt;/p&gt;

&lt;p&gt;RSpec 2 allows you to configure which you want to use:&lt;/p&gt;
&lt;div class='bogus-wrapper'&gt;&lt;notextile&gt;&lt;div class='code-wrap'&gt;&lt;figure class='code'&gt;&lt;figcaption&gt;&lt;span&gt;spec_helper.rb &lt;/span&gt;&lt;/figcaption&gt;
 &lt;div class='highlight'&gt;&lt;table&gt;&lt;tr&gt;&lt;td class='gutter'&gt;&lt;pre class='line-numbers'&gt;&lt;span class='line-number'&gt;1&lt;/span&gt;
&lt;span class='line-number'&gt;2&lt;/span&gt;
&lt;span class='line-number'&gt;3&lt;/span&gt;
&lt;span class='line-number'&gt;4&lt;/span&gt;
&lt;span class='line-number'&gt;5&lt;/span&gt;
&lt;span class='line-number'&gt;6&lt;/span&gt;
&lt;span class='line-number'&gt;7&lt;/span&gt;
&lt;span class='line-number'&gt;8&lt;/span&gt;
&lt;span class='line-number'&gt;9&lt;/span&gt;
&lt;span class='line-number'&gt;10&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;td class='code'&gt;&lt;pre&gt;&lt;code class='rb'&gt;&lt;span class='line'&gt;&lt;span class='no'&gt;RSpec&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;configure&lt;/span&gt; &lt;span class='k'&gt;do&lt;/span&gt; &lt;span class='o'&gt;|&lt;/span&gt;&lt;span class='n'&gt;config&lt;/span&gt;&lt;span class='o'&gt;|&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='n'&gt;config&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;expect_with&lt;/span&gt; &lt;span class='ss'&gt;:stdlib&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;&lt;span class='k'&gt;end&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;
&lt;/span&gt;&lt;span class='line'&gt;&lt;span class='c1'&gt;# or&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;
&lt;/span&gt;&lt;span class='line'&gt;&lt;span class='no'&gt;RSpec&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;configure&lt;/span&gt; &lt;span class='k'&gt;do&lt;/span&gt; &lt;span class='o'&gt;|&lt;/span&gt;&lt;span class='n'&gt;config&lt;/span&gt;&lt;span class='o'&gt;|&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='c1'&gt;# not strictly necessary; this is the default config anyway&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='n'&gt;config&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;expect_with&lt;/span&gt; &lt;span class='ss'&gt;:rspec&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;&lt;span class='k'&gt;end&lt;/span&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/figure&gt;&lt;/div&gt;&lt;/notextile&gt;&lt;/div&gt;
&lt;p&gt;Both rspec-expectations and the standard library assertions are available as modules&amp;#8211;&lt;code&gt;RSpec::Matchers&lt;/code&gt; and &lt;code&gt;Test::Unit::Assertions&lt;/code&gt;, respectively. RSpec 2.0 to 2.5 included the appropriate module into &lt;code&gt;RSpec::Core::ExampleGroup&lt;/code&gt; just prior to running the examples (that is, after all of them have been defined) to allow people to configure this whenever they want.&lt;/p&gt;

&lt;p&gt;Unfortunately, this triggered an unfortunate bug in ruby 1.9&amp;#8230;which I&amp;#8217;ll get to below.&lt;/p&gt;

&lt;h2 id='infinite_recursion_issues'&gt;Infinite Recursion Issues&lt;/h2&gt;

&lt;p&gt;Shortly after RSpec 2 was released, we began to get some &lt;a href='http://groups.google.com/group/rspec/browse_thread/thread/eb54642fa0f051d1'&gt;intermittent&lt;/a&gt; &lt;a href='https://github.com/rspec/rspec-expectations/issues/63'&gt;reports&lt;/a&gt; that users were occasionally getting a &lt;code&gt;SystemStackError&lt;/code&gt; from RSpec, indicating infinite recursion was occurring. I myself saw this error when working on the rspec-core specs at one point.&lt;/p&gt;

&lt;p&gt;The recursion always happened in rspec-expectations&amp;#8217; &lt;a href='https://github.com/rspec/rspec-expectations/blob/v2.7.0/lib/rspec/matchers/method_missing.rb#L6-10'&gt;method_missing hook&lt;/a&gt;. In particular, the call to &lt;code&gt;super&lt;/code&gt; triggered infinite recursion.&lt;/p&gt;

&lt;p&gt;I found this very, very puzzling, and spent many hours troubleshooting trying to figure out why &lt;code&gt;super&lt;/code&gt; would infinitely recurse on itself.&lt;/p&gt;

&lt;h2 id='its_a_bug_in_ruby_19'&gt;It&amp;#8217;s a Bug in Ruby 1.9&lt;/h2&gt;

&lt;p&gt;I eventually managed to boil the problem down to a simple rspec-less example:&lt;/p&gt;
&lt;div class='bogus-wrapper'&gt;&lt;notextile&gt;&lt;div class='code-wrap'&gt;&lt;figure class='code'&gt;&lt;figcaption&gt;&lt;span&gt;example.rb &lt;/span&gt;&lt;/figcaption&gt;
 &lt;div class='highlight'&gt;&lt;table&gt;&lt;tr&gt;&lt;td class='gutter'&gt;&lt;pre class='line-numbers'&gt;&lt;span class='line-number'&gt;1&lt;/span&gt;
&lt;span class='line-number'&gt;2&lt;/span&gt;
&lt;span class='line-number'&gt;3&lt;/span&gt;
&lt;span class='line-number'&gt;4&lt;/span&gt;
&lt;span class='line-number'&gt;5&lt;/span&gt;
&lt;span class='line-number'&gt;6&lt;/span&gt;
&lt;span class='line-number'&gt;7&lt;/span&gt;
&lt;span class='line-number'&gt;8&lt;/span&gt;
&lt;span class='line-number'&gt;9&lt;/span&gt;
&lt;span class='line-number'&gt;10&lt;/span&gt;
&lt;span class='line-number'&gt;11&lt;/span&gt;
&lt;span class='line-number'&gt;12&lt;/span&gt;
&lt;span class='line-number'&gt;13&lt;/span&gt;
&lt;span class='line-number'&gt;14&lt;/span&gt;
&lt;span class='line-number'&gt;15&lt;/span&gt;
&lt;span class='line-number'&gt;16&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;td class='code'&gt;&lt;pre&gt;&lt;code class='rb'&gt;&lt;span class='line'&gt;&lt;span class='k'&gt;module&lt;/span&gt; &lt;span class='nn'&gt;MyModule&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='k'&gt;def&lt;/span&gt; &lt;span class='nf'&gt;some_method&lt;/span&gt;&lt;span class='p'&gt;;&lt;/span&gt; &lt;span class='k'&gt;super&lt;/span&gt;&lt;span class='p'&gt;;&lt;/span&gt; &lt;span class='k'&gt;end&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;&lt;span class='k'&gt;end&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;
&lt;/span&gt;&lt;span class='line'&gt;&lt;span class='k'&gt;class&lt;/span&gt; &lt;span class='nc'&gt;MyBaseClass&lt;/span&gt;&lt;span class='p'&gt;;&lt;/span&gt; &lt;span class='k'&gt;end&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;
&lt;/span&gt;&lt;span class='line'&gt;&lt;span class='k'&gt;class&lt;/span&gt; &lt;span class='nc'&gt;MySubClass&lt;/span&gt; &lt;span class='o'&gt;&amp;lt;&lt;/span&gt; &lt;span class='no'&gt;MyBaseClass&lt;/span&gt;&lt;span class='p'&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='kp'&gt;include&lt;/span&gt; &lt;span class='no'&gt;MyModule&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;&lt;span class='k'&gt;end&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;
&lt;/span&gt;&lt;span class='line'&gt;&lt;span class='c1'&gt;# To trigger this bug, we must include the module in the base class after&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;&lt;span class='c1'&gt;# the module has already been included in the subclass.  If we move this line&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;&lt;span class='c1'&gt;# above the subclass declaration, this bug will not occur.&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;&lt;span class='no'&gt;MyBaseClass&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;send&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='ss'&gt;:include&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='no'&gt;MyModule&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;
&lt;/span&gt;&lt;span class='line'&gt;&lt;span class='no'&gt;MySubClass&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;new&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;some_method&lt;/span&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/figure&gt;&lt;/div&gt;&lt;/notextile&gt;&lt;/div&gt;
&lt;p&gt;If you run this on ruby 1.8, you will (correctly) get a &lt;code&gt;NoMethodError&lt;/code&gt;. On ruby 1.9, you get infinite recursion and a &lt;code&gt;SystemStackError&lt;/code&gt;. Here&amp;#8217;s my short explanation of the conditions that trigger this bug:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;Define a module that has a method that uses &lt;code&gt;super&lt;/code&gt;.&lt;/li&gt;

&lt;li&gt;Include that module in a class &lt;em&gt;after&lt;/em&gt; it has already been included in one of its subclasses.&lt;/li&gt;

&lt;li&gt;Create an instance of said subclass and call the method.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Note that this error does not occur if the module is included in the superclass &lt;em&gt;before&lt;/em&gt; it is included in the subclass.&lt;/p&gt;

&lt;h2 id='how_this_bug_manifested_itself_in_rspec'&gt;How this Bug Manifested Itself in RSpec&lt;/h2&gt;

&lt;p&gt;Here&amp;#8217;s how this bug manifested itself in RSpec:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;Every time you define an example group (using &lt;code&gt;describe&lt;/code&gt; or &lt;code&gt;context&lt;/code&gt;), RSpec creates a new subclass of &lt;code&gt;RSpec::Core::ExampleGroup&lt;/code&gt;, or a subclass-of-a-subclass, if you have nested your example group within another one.&lt;/li&gt;

&lt;li&gt;Some users included &lt;code&gt;RSpec::Matchers&lt;/code&gt; into their example groups. &lt;a href='https://github.com/radar/forem/blob/a9ce93d15fa77dbb3c586c3583dda49e70750809/spec/support/integration_example_group.rb#L13'&gt;Here&amp;#8217;s one example&lt;/a&gt;.&lt;/li&gt;

&lt;li&gt;As I explained above, in 2.0 to 2.5, RSpec included &lt;code&gt;RSpec::Matchers&lt;/code&gt; in &lt;code&gt;RSpec::Core::ExampleGroup&lt;/code&gt; right before running the examples, &lt;em&gt;after&lt;/em&gt; all examples have been defined (and hence, after the user may have already included &lt;code&gt;RSpec::Matchers&lt;/code&gt; in their example groups).&lt;/li&gt;

&lt;li&gt;When a user called an undefined or misspelled method from an example, it would trigger this error.&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id='fixing_the_issueby_introducing_other_problems_'&gt;Fixing the Issue&amp;#8230;by Introducing Other Problems :(&lt;/h2&gt;

&lt;p&gt;To prevent users from getting infinite recursion, we need to prevent &lt;code&gt;RSpec::Matchers&lt;/code&gt; (and really, any other module that may use &lt;code&gt;super&lt;/code&gt;) from being included in an example group before it is included in &lt;code&gt;RSpec::Core::ExampleGroup&lt;/code&gt;. At one point, I considered adding a hook to either &lt;code&gt;RSpec::Core::ExampleGroup&lt;/code&gt; or &lt;code&gt;RSpec::Matchers&lt;/code&gt; to detect when a user is including it, and somehow prevent or warn them. However, I quickly realized that the extreme flexibility of Ruby&amp;#8217;s module system makes this very complicated. A user may not be including &lt;code&gt;RSpec::Matchers&lt;/code&gt; directly; they may be including a module from some library or plugin, that itself includes &lt;code&gt;RSpec::Matchers&lt;/code&gt;, or includes a module that includes &lt;code&gt;RSpec::Matchers&lt;/code&gt;. I realized this wasn&amp;#8217;t going to be a simple solution to get right.&lt;/p&gt;

&lt;p&gt;Instead, after talking with &lt;a href='http://twitter.com/#!/dchelimsky'&gt;David Chelimsky&lt;/a&gt; and some other members of the RSpec core team, we decided it was best to change when &lt;code&gt;RSpec::Matchers&lt;/code&gt; gets included. By including &lt;code&gt;RSpec::Matchers&lt;/code&gt; in &lt;code&gt;RSpec::Core::ExampleGroup&lt;/code&gt; before it has been subclassed the issue goes away entirely.&lt;/p&gt;

&lt;p&gt;We still wanted to let people configure &lt;code&gt;expect_with :stdlib&lt;/code&gt;, though. the best solution we could come up with is to delay the inclusion of the expectation module until the moment when &lt;code&gt;RSpec::Core::ExampleGroup&lt;/code&gt; is being subclassed for the first time. This gives the user a chance to configure &lt;code&gt;expect_with :stdlib&lt;/code&gt; as long as they do so before defining any example groups. Once an example group has been defined, we automatically default to &lt;code&gt;expect_with :rspec&lt;/code&gt;&amp;#8211;which means that any future &lt;code&gt;expect_with&lt;/code&gt; configuration would be effectively ignored.&lt;/p&gt;

&lt;p&gt;&lt;a href='https://github.com/rspec/rspec-core/commit/622a4b7ac41e0ab6a4786070cca3ff866b72b57c'&gt;Here&amp;#8217;s the commit&lt;/a&gt;, if you&amp;#8217;re interested. You&amp;#8217;ll notice that it also changes when the mocking framework adapter module gets included. Since we don&amp;#8217;t want to deal with this issue again if/when one of the mocking framework adapter modules uses &lt;code&gt;super&lt;/code&gt;, I thought it best to change it as well.&lt;/p&gt;

&lt;p&gt;This whole issue suggested to me that it&amp;#8217;s problematic to allow users to configure RSpec after defining examples. In my mind, since the configuration affects how RSpec works, it&amp;#8217;s best to set it &lt;em&gt;before&lt;/em&gt; you start to use RSpec (i.e. by defining examples). I &lt;a href='https://github.com/rspec/rspec-core/commit/fc70cee014689a947bfdea1ab04d91191327946f'&gt;made a change&lt;/a&gt; to cause RSpec to print a deprecation warning when you use &lt;code&gt;RSpec.configure&lt;/code&gt; after defining an example group.&lt;/p&gt;

&lt;p&gt;In retrospect, I should have realized that this would affect a lot of users. At the time, it didn&amp;#8217;t occur to me that it would. I do all of my RSpec configuration before defining any example groups and I assumed that&amp;#8217;s what everyone else did, too. The deprecation warning was mostly just put there on the off chance that someone might configure RSpec after defining an example.&lt;/p&gt;

&lt;h2 id='rspec_26'&gt;RSpec 2.6&lt;/h2&gt;

&lt;p&gt;RSpec 2.6 was released with these changes and we immediately began getting questions and complaints about this warning. People like &lt;a href='http://twitter.com/#!/garybernhardt'&gt;Gary Bernhardt&lt;/a&gt; and &lt;a href='http://twitter.com/#!/coreyhaines'&gt;Corey Haines&lt;/a&gt; have a technique of speeding up their tests by loading as little as possible&amp;#8211;and this usually involves not loading &lt;code&gt;spec_helper&lt;/code&gt; from each spec file. This can trigger the deprecation warning when one spec file (say, &lt;code&gt;spec/lib/my_class_spec.rb&lt;/code&gt;) does not require &lt;code&gt;spec_helper&lt;/code&gt;, but another file in the same suite (say &lt;code&gt;spec/models/user_spec.rb&lt;/code&gt;) does. If &lt;code&gt;spec/lib/my_class_spec.rb&lt;/code&gt; is loaded before &lt;code&gt;spec/models/user_spec.rb&lt;/code&gt; (which usually happens&amp;#8211;they tend to get loaded in alphabetical order), it will trigger the warning since examples are defined in &lt;code&gt;spec/lib/my_class_spec.rb&lt;/code&gt; before the configuration happens in &lt;code&gt;spec_helper.rb&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;I&amp;#8217;m a big fan of the &amp;#8220;don&amp;#8217;t load spec_helper&amp;#8221; approach now, but at the time I made the changes, I had never heard or thought of doing it that way.&lt;/p&gt;

&lt;p&gt;We had a conversation about this on an &lt;a href='https://github.com/rspec/rspec-rails/issues/371'&gt;rspec-rails issue&lt;/a&gt;. The best suggestion to come out of that (and one that no one argued against) was to remove the warning, and instead raise an error on the specific, problematic configs (&lt;code&gt;expect_with&lt;/code&gt; and &lt;code&gt;mock_with&lt;/code&gt;), if they get set after defining an example group.&lt;/p&gt;

&lt;p&gt;I made &lt;a href='https://github.com/rspec/rspec-core/commit/f46e00aff4c9aa028991ff57e71d54f3dcd5c307'&gt;this change&lt;/a&gt; and it was released in RSpec 2.7.&lt;/p&gt;

&lt;h2 id='rspec_27'&gt;RSpec 2.7&lt;/h2&gt;

&lt;p&gt;After RSpec 2.7 came out, there were yet more complaints about this change. Now some users were unable to run their specs because of the error. Effectively, this had made the problem worse&amp;#8211;the previous warning could be ignored, but not the error.&lt;/p&gt;

&lt;p&gt;I &lt;a href='https://github.com/rspec/rspec-core/commit/f2dc2f8954fc6663dc45f03375912dc58fc590f9'&gt;committed a change&lt;/a&gt; a few days ago that should improve things here: instead of raising an error anytime &lt;code&gt;expect_with&lt;/code&gt; or &lt;code&gt;mock_with&lt;/code&gt; are called after an example group is defined, the error is only raised if the method call is changing the setting. No error will be raised if you&amp;#8217;re simply explicitly setting the default (i.e. &lt;code&gt;mock_with :rspec&lt;/code&gt;) or re-setting the existing config value.&lt;/p&gt;

&lt;p&gt;This is certainly an important, needed change that I simply didn&amp;#8217;t consider when I made the previous changes. I apologize.&lt;/p&gt;

&lt;p&gt;Note that this does not remove the error entirely: if you are configuring RSpec to use a different expectation/assertion framework or mocking framework, this must still be done &lt;em&gt;before&lt;/em&gt; an example group is defined so that RSpec can include the appropriate module in &lt;code&gt;RSpec::Core::ExampleGroup&lt;/code&gt; &lt;em&gt;before&lt;/em&gt; it has been subclassed.&lt;/p&gt;

&lt;h2 id='avoiding_these_warningserrors'&gt;Avoiding these warnings/errors&lt;/h2&gt;

&lt;p&gt;If you&amp;#8217;re on RSpec 2.6 or 2.7 and have gotten these warnings or errors, there are some very simple changes you can make to avoid them.&lt;/p&gt;

&lt;p&gt;First, make sure all of your spec_helper requires are simply &lt;code&gt;require
&amp;#39;spec_helper&amp;#39;&lt;/code&gt;. If you use a path relative to &lt;code&gt;__FILE__&lt;/code&gt;, as people often do, spec_helper.rb can be loaded multiple times (since ruby will happily re-require a file if it is specified as a different file path). RSpec puts the spec directoy on the load path for you, so you can (and generally should) just require &lt;code&gt;spec_helper&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;Second, if you follow the &amp;#8220;don&amp;#8217;t load spec_helper&amp;#8221; approach, and you need to configure either &lt;code&gt;expect_with&lt;/code&gt; or &lt;code&gt;mock_with&lt;/code&gt;, you&amp;#8217;ll need to create a secondary helper file for your isolated, fast specs.&lt;/p&gt;

&lt;p&gt;Here&amp;#8217;s one way to do it:&lt;/p&gt;
&lt;div class='bogus-wrapper'&gt;&lt;notextile&gt;&lt;div class='code-wrap'&gt;&lt;figure class='code'&gt;&lt;figcaption&gt;&lt;span&gt;spec/fast_spec_helper.rb &lt;/span&gt;&lt;/figcaption&gt;
 &lt;div class='highlight'&gt;&lt;table&gt;&lt;tr&gt;&lt;td class='gutter'&gt;&lt;pre class='line-numbers'&gt;&lt;span class='line-number'&gt;1&lt;/span&gt;
&lt;span class='line-number'&gt;2&lt;/span&gt;
&lt;span class='line-number'&gt;3&lt;/span&gt;
&lt;span class='line-number'&gt;4&lt;/span&gt;
&lt;span class='line-number'&gt;5&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;td class='code'&gt;&lt;pre&gt;&lt;code class='rb'&gt;&lt;span class='line'&gt;&lt;span class='nb'&gt;require&lt;/span&gt; &lt;span class='s1'&gt;&amp;#39;rspec&amp;#39;&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;
&lt;/span&gt;&lt;span class='line'&gt;&lt;span class='no'&gt;RSpec&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;configure&lt;/span&gt; &lt;span class='k'&gt;do&lt;/span&gt; &lt;span class='o'&gt;|&lt;/span&gt;&lt;span class='n'&gt;c&lt;/span&gt;&lt;span class='o'&gt;|&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='n'&gt;c&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;mock_with&lt;/span&gt; &lt;span class='ss'&gt;:mocha&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;&lt;span class='k'&gt;end&lt;/span&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/figure&gt;&lt;/div&gt;&lt;/notextile&gt;&lt;/div&gt;&lt;div class='bogus-wrapper'&gt;&lt;notextile&gt;&lt;div class='code-wrap'&gt;&lt;figure class='code'&gt;&lt;figcaption&gt;&lt;span&gt;spec/spec_helper.rb &lt;/span&gt;&lt;/figcaption&gt;
 &lt;div class='highlight'&gt;&lt;table&gt;&lt;tr&gt;&lt;td class='gutter'&gt;&lt;pre class='line-numbers'&gt;&lt;span class='line-number'&gt;1&lt;/span&gt;
&lt;span class='line-number'&gt;2&lt;/span&gt;
&lt;span class='line-number'&gt;3&lt;/span&gt;
&lt;span class='line-number'&gt;4&lt;/span&gt;
&lt;span class='line-number'&gt;5&lt;/span&gt;
&lt;span class='line-number'&gt;6&lt;/span&gt;
&lt;span class='line-number'&gt;7&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;td class='code'&gt;&lt;pre&gt;&lt;code class='rb'&gt;&lt;span class='line'&gt;&lt;span class='nb'&gt;require&lt;/span&gt; &lt;span class='s1'&gt;&amp;#39;fast_spec_helper&amp;#39;&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;
&lt;/span&gt;&lt;span class='line'&gt;&lt;span class='c1'&gt;# load rails or whatever to get your full app environment booted&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;
&lt;/span&gt;&lt;span class='line'&gt;&lt;span class='no'&gt;RSpec&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;configure&lt;/span&gt; &lt;span class='k'&gt;do&lt;/span&gt; &lt;span class='o'&gt;|&lt;/span&gt;&lt;span class='n'&gt;c&lt;/span&gt;&lt;span class='o'&gt;|&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='c1'&gt;# other RSpec configuration&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;&lt;span class='k'&gt;end&lt;/span&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/figure&gt;&lt;/div&gt;&lt;/notextile&gt;&lt;/div&gt;&lt;div class='bogus-wrapper'&gt;&lt;notextile&gt;&lt;div class='code-wrap'&gt;&lt;figure class='code'&gt;&lt;figcaption&gt;&lt;span&gt;spec/lib/my_class_spec.rb &lt;/span&gt;&lt;/figcaption&gt;
 &lt;div class='highlight'&gt;&lt;table&gt;&lt;tr&gt;&lt;td class='gutter'&gt;&lt;pre class='line-numbers'&gt;&lt;span class='line-number'&gt;1&lt;/span&gt;
&lt;span class='line-number'&gt;2&lt;/span&gt;
&lt;span class='line-number'&gt;3&lt;/span&gt;
&lt;span class='line-number'&gt;4&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;td class='code'&gt;&lt;pre&gt;&lt;code class='rb'&gt;&lt;span class='line'&gt;&lt;span class='nb'&gt;require&lt;/span&gt; &lt;span class='s1'&gt;&amp;#39;fast_spec_helper&amp;#39;&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;
&lt;/span&gt;&lt;span class='line'&gt;&lt;span class='n'&gt;describe&lt;/span&gt; &lt;span class='no'&gt;MyClass&lt;/span&gt; &lt;span class='k'&gt;do&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;&lt;span class='k'&gt;end&lt;/span&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/figure&gt;&lt;/div&gt;&lt;/notextile&gt;&lt;/div&gt;&lt;div class='bogus-wrapper'&gt;&lt;notextile&gt;&lt;div class='code-wrap'&gt;&lt;figure class='code'&gt;&lt;figcaption&gt;&lt;span&gt;spec/controllers/my_controller_spec.rb &lt;/span&gt;&lt;/figcaption&gt;
 &lt;div class='highlight'&gt;&lt;table&gt;&lt;tr&gt;&lt;td class='gutter'&gt;&lt;pre class='line-numbers'&gt;&lt;span class='line-number'&gt;1&lt;/span&gt;
&lt;span class='line-number'&gt;2&lt;/span&gt;
&lt;span class='line-number'&gt;3&lt;/span&gt;
&lt;span class='line-number'&gt;4&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;td class='code'&gt;&lt;pre&gt;&lt;code class='rb'&gt;&lt;span class='line'&gt;&lt;span class='nb'&gt;require&lt;/span&gt; &lt;span class='s1'&gt;&amp;#39;spec_helper&amp;#39;&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;
&lt;/span&gt;&lt;span class='line'&gt;&lt;span class='n'&gt;describe&lt;/span&gt; &lt;span class='no'&gt;MyController&lt;/span&gt; &lt;span class='k'&gt;do&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;&lt;span class='k'&gt;end&lt;/span&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/figure&gt;&lt;/div&gt;&lt;/notextile&gt;&lt;/div&gt;
&lt;p&gt;I know this goes against the &amp;#8220;don&amp;#8217;t load spec_helper&amp;#8221; approach a bit, but the important thing is that the rails/sinatra/whatever environment is not fully loaded in the isolated specs. We&amp;#8217;re using fast_spec_helper.rb to only configure the bare minimum&amp;#8211;the specific &lt;code&gt;expect_with&lt;/code&gt; or &lt;code&gt;mock_with&lt;/code&gt; settings that must be set before an example group is defined. The one extra require isn&amp;#8217;t going to make a noticeable difference in the speed of your isolated tests.&lt;/p&gt;

&lt;p&gt;Of course, if you are just setting &lt;code&gt;mock_with&lt;/code&gt; or &lt;code&gt;expect_with&lt;/code&gt; to the default (&lt;code&gt;:rspec&lt;/code&gt;) then you should just remove that configuration entirely and the error should go away&amp;#8211;no need for a separate &lt;code&gt;fast_spec_helper.rb&lt;/code&gt; file.&lt;/p&gt;

&lt;p&gt;Alternatively, you could use ruby&amp;#8217;s &lt;code&gt;-r&lt;/code&gt; flag to force a helper file to be loaded before any isolated specs, rather than having to require a helper file from each.&lt;/p&gt;

&lt;h2 id='is_there_a_better_way_to_work_around_this_bug'&gt;Is There a Better Way to Work Around this Bug?&lt;/h2&gt;

&lt;p&gt;So there you have it&amp;#8230;the full story behind the recent configuration warnings and errors in RSpec. I apologize if this has caused upgrade pain for you. I solved the issues in the best way I could figure out.&lt;/p&gt;

&lt;p&gt;If you think I totally screwed up, or if you can think of a better way to deal with the ruby 1.9 bug, please let me know in the comments!&lt;/p&gt;

&lt;p&gt;Also, I &lt;a href='http://redmine.ruby-lang.org/issues/5236'&gt;filed a bug&lt;/a&gt; on the ruby issue tracker. Please comment there if you would like to see it fixed.&lt;/p&gt;</content>
  </entry>
  
  <entry>
    <title>Custom Request Matchers in VCR 2.0</title>
    <link href="http://myronmars.to/n/dev-blog/2011/10/custom-request-matchers-in-vcr-2-0"/>
    <updated>2011-10-10T00:00:00-07:00</updated>
    <id>http://myronmars.to/n/dev-blog/2011/10/custom-request-matchers-in-vcr-2-0</id>
    <content type="html">&lt;p&gt;Over the last six weeks, I&amp;#8217;ve been working extensively on VCR 2.0. I&amp;#8217;ve completely rewritten most of the internals and have finally been able to add a feature people have wanted in VCR for over a year: custom request matchers.&lt;/p&gt;

&lt;p&gt;I just released VCR 2.0 beta 1 a few days ago, so I figured it&amp;#8217;s time to blog a bit about what the feature is, why it&amp;#8217;s useful, and why it took me so long to add it to VCR.&lt;/p&gt;

&lt;h2 id='the_problem'&gt;The problem&lt;/h2&gt;

&lt;p&gt;VCR, at its core, is a very simple idea: you run your tests for the first time, and VCR records the HTTP requests and responses. Later, when you run them again, it will use the recorded responses rather than allowing real ones, which has many benefits (speed, test determinism and test accuracy being the main ones).&lt;/p&gt;

&lt;p&gt;It&amp;#8217;s important for VCR to replay the &lt;em&gt;right&lt;/em&gt; response, and it can&amp;#8217;t simply rely on the order of the recorded HTTP interactions. You might be using a single cassette for multiple tests, and those tests may not always run in the same order. Or you may change your implementation code so that it makes the HTTP requests in a different order. VCR needs a way to match a recorded HTTP interaction to a new one.&lt;/p&gt;

&lt;p&gt;Since VCR 1.1.0 (now over a year ago), VCR has allowed users to customize how it matches a previously recorded HTTP interaction to a new request, by using the &lt;a href='https://www.relishapp.com/myronmarston/vcr/v/1-11-3/docs/cassettes/request-matching'&gt;&lt;code&gt;:match_requests_on&lt;/code&gt; cassette option&lt;/a&gt;. By default, it matches on &lt;code&gt;:uri&lt;/code&gt; and &lt;code&gt;:method&lt;/code&gt;, which works great for most REST-ish APIs.&lt;/p&gt;

&lt;p&gt;This gave VCR some nice flexibility, but it never really worked well for the most common case where the &lt;code&gt;:uri&lt;/code&gt;/&lt;code&gt;:method&lt;/code&gt; matching didn&amp;#8217;t work: APIs that have non-deterministic URIs. Each time your tests run, the URI is different, and VCR would not match the new request to the old one, causing it to either re-record the HTTP interaction, or raise a &amp;#8220;real connections are not allowed&amp;#8221; error, depending on your configuration.&lt;/p&gt;

&lt;p&gt;The common example is an API that requires clients to sign requests by putting a token (typically generated by hashing several things, including a timestamp) as a query parameter in the URI. Amazon&amp;#8217;s APIs do this all over the place. It&amp;#8217;s a really bad idea to design your APIs this way &lt;sup id='fnref:1'&gt;&lt;a href='#fn:1' rel='footnote'&gt;1&lt;/a&gt;&lt;/sup&gt;, but it&amp;#8217;s a reality of the web and VCR needs to work well for users who are using these APIs.&lt;/p&gt;

&lt;h2 id='how_vcr_1x_worked'&gt;How VCR 1.x worked&lt;/h2&gt;

&lt;p&gt;I&amp;#8217;ve wanted to make VCR work well for these sorts of APIs for a long time, but the way VCR 1.x worked prevented a good solution. In VCR 1.x, it uses declaritive APIs provided by FakeWeb, WebMock and Typhoeus. When you insert a cassette, VCR makes calls to these libraries that are a bit like this:&lt;/p&gt;
&lt;div class='bogus-wrapper'&gt;&lt;notextile&gt;&lt;div class='code-wrap'&gt;&lt;figure class='code'&gt;&lt;figcaption&gt;&lt;span&gt;vcr_stubs.rb &lt;/span&gt;&lt;/figcaption&gt;
 &lt;div class='highlight'&gt;&lt;table&gt;&lt;tr&gt;&lt;td class='gutter'&gt;&lt;pre class='line-numbers'&gt;&lt;span class='line-number'&gt;1&lt;/span&gt;
&lt;span class='line-number'&gt;2&lt;/span&gt;
&lt;span class='line-number'&gt;3&lt;/span&gt;
&lt;span class='line-number'&gt;4&lt;/span&gt;
&lt;span class='line-number'&gt;5&lt;/span&gt;
&lt;span class='line-number'&gt;6&lt;/span&gt;
&lt;span class='line-number'&gt;7&lt;/span&gt;
&lt;span class='line-number'&gt;8&lt;/span&gt;
&lt;span class='line-number'&gt;9&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;td class='code'&gt;&lt;pre&gt;&lt;code class='rb'&gt;&lt;span class='line'&gt;&lt;span class='no'&gt;FakeWeb&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;register_uri&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;request&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;method&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='n'&gt;request&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;uri&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='n'&gt;response&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;to_fakeweb_hash&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;
&lt;/span&gt;&lt;span class='line'&gt;&lt;span class='no'&gt;WebMock&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;stub_request&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='n'&gt;request&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;method&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='n'&gt;request&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;uri&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;&lt;span class='p'&gt;)&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;to_return&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;response&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;to_webmock_hash&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;
&lt;/span&gt;&lt;span class='line'&gt;&lt;span class='no'&gt;Typhoeus&lt;/span&gt;&lt;span class='o'&gt;::&lt;/span&gt;&lt;span class='no'&gt;Hydra&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;stub&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='n'&gt;request&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;method&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='n'&gt;request&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;uri&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;&lt;span class='p'&gt;)&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;and_return&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;response&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;to_typhoeus_response&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/figure&gt;&lt;/div&gt;&lt;/notextile&gt;&lt;/div&gt;
&lt;p&gt;These libraries all allow you to register a stub using a regex rather than a full URI, and this is in fact what VCR 1.x did to support &lt;code&gt;:match_requests_on =&amp;gt; [:host, :path]&lt;/code&gt;. This works OK, but doesn&amp;#8217;t provide an easy way to solve the problem of URIs with non-deterministic query parameters. Building a regex that correctly matches all of a URI except a particular query parameter is not easy, and it would have been even more difficult to put code that does this generically in VCR so that users could easily match on a URI while ignoring particular query parameters.&lt;/p&gt;

&lt;h2 id='the_big_rewrite'&gt;The big rewrite&lt;/h2&gt;

&lt;p&gt;I realized about a year ago that if I was going to solve this problem in VCR, I needed to change the way VCR interacts with FakeWeb, WebMock, and Typhoeus: rather than using their declaritive stub registration APIs, VCR should use these libraries to hook into the HTTP request so that an appropriate response can be chosen &lt;em&gt;at request time&lt;/em&gt;.&lt;/p&gt;

&lt;p&gt;To get this to work I had to rewrite a large portion of VCR&amp;#8217;s internals. After about &lt;a href='https://github.com/myronmarston/vcr/compare/e36ed0e812b3a1650090d011d1bf972ae503ad79...221647b75d5aaa105472bd5c2f1d97a8c6b58a9a'&gt;70 commits&lt;/a&gt;, the refactoring, and the new features it enabled, was complete. It was, if nothing else, an intersting exercise in how to safely do a large refactoring. I kept the test suite passing all along the way. I don&amp;#8217;t think I can emphasize enough how important a good test suite was to making this possible.&lt;/p&gt;

&lt;p&gt;The great thing about this rewrite is that it de-couples VCR from the declarative APIs of the libraries it integrates with. When I want to add a new feature to VCR, I no longer have to try to get a supporting API added to FakeWeb, WebMock and Typhoeus&amp;#8211;I can just add it to VCR itself.&lt;/p&gt;

&lt;h2 id='request_matching_in_vcr_20'&gt;Request matching in VCR 2.0&lt;/h2&gt;

&lt;p&gt;In VCR 2.0, a request matcher is simply an object that responds to &lt;code&gt;#call&lt;/code&gt; with two arguments and returns &lt;code&gt;true&lt;/code&gt; if the given requests should be considered identical, or &lt;code&gt;false&lt;/code&gt; if they should not be considered identical.&lt;/p&gt;

&lt;p&gt;The simplest request matcher is probably a lambda:&lt;/p&gt;
&lt;div class='bogus-wrapper'&gt;&lt;notextile&gt;&lt;div class='code-wrap'&gt;&lt;figure class='code'&gt;&lt;figcaption&gt;&lt;span&gt;lambda_matcher.rb &lt;/span&gt;&lt;/figcaption&gt;
 &lt;div class='highlight'&gt;&lt;table&gt;&lt;tr&gt;&lt;td class='gutter'&gt;&lt;pre class='line-numbers'&gt;&lt;span class='line-number'&gt;1&lt;/span&gt;
&lt;span class='line-number'&gt;2&lt;/span&gt;
&lt;span class='line-number'&gt;3&lt;/span&gt;
&lt;span class='line-number'&gt;4&lt;/span&gt;
&lt;span class='line-number'&gt;5&lt;/span&gt;
&lt;span class='line-number'&gt;6&lt;/span&gt;
&lt;span class='line-number'&gt;7&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;td class='code'&gt;&lt;pre&gt;&lt;code class='rb'&gt;&lt;span class='line'&gt;&lt;span class='n'&gt;port_matcher&lt;/span&gt; &lt;span class='o'&gt;=&lt;/span&gt; &lt;span class='nb'&gt;lambda&lt;/span&gt; &lt;span class='k'&gt;do&lt;/span&gt; &lt;span class='o'&gt;|&lt;/span&gt;&lt;span class='n'&gt;request_1&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='n'&gt;request_2&lt;/span&gt;&lt;span class='o'&gt;|&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='no'&gt;URI&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;request_1&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;uri&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;port&lt;/span&gt; &lt;span class='o'&gt;==&lt;/span&gt; &lt;span class='no'&gt;URI&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;request_2&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;uri&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;port&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;&lt;span class='k'&gt;end&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;
&lt;/span&gt;&lt;span class='line'&gt;&lt;span class='no'&gt;VCR&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;use_cassette&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='s1'&gt;&amp;#39;example&amp;#39;&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='ss'&gt;:match_requests_on&lt;/span&gt; &lt;span class='o'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='o'&gt;[&lt;/span&gt;&lt;span class='ss'&gt;:method&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='n'&gt;port_matcher&lt;/span&gt;&lt;span class='o'&gt;]&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt; &lt;span class='k'&gt;do&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='c1'&gt;# make an HTTP request&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;&lt;span class='k'&gt;end&lt;/span&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/figure&gt;&lt;/div&gt;&lt;/notextile&gt;&lt;/div&gt;
&lt;p&gt;You can also register it as a named matcher and use the name in your &lt;code&gt;:match_requests_on&lt;/code&gt; option:&lt;/p&gt;
&lt;div class='bogus-wrapper'&gt;&lt;notextile&gt;&lt;div class='code-wrap'&gt;&lt;figure class='code'&gt;&lt;figcaption&gt;&lt;span&gt;register_matcher.rb &lt;/span&gt;&lt;/figcaption&gt;
 &lt;div class='highlight'&gt;&lt;table&gt;&lt;tr&gt;&lt;td class='gutter'&gt;&lt;pre class='line-numbers'&gt;&lt;span class='line-number'&gt;1&lt;/span&gt;
&lt;span class='line-number'&gt;2&lt;/span&gt;
&lt;span class='line-number'&gt;3&lt;/span&gt;
&lt;span class='line-number'&gt;4&lt;/span&gt;
&lt;span class='line-number'&gt;5&lt;/span&gt;
&lt;span class='line-number'&gt;6&lt;/span&gt;
&lt;span class='line-number'&gt;7&lt;/span&gt;
&lt;span class='line-number'&gt;8&lt;/span&gt;
&lt;span class='line-number'&gt;9&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;td class='code'&gt;&lt;pre&gt;&lt;code class='rb'&gt;&lt;span class='line'&gt;&lt;span class='no'&gt;VCR&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;configure&lt;/span&gt; &lt;span class='k'&gt;do&lt;/span&gt; &lt;span class='o'&gt;|&lt;/span&gt;&lt;span class='n'&gt;c&lt;/span&gt;&lt;span class='o'&gt;|&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='n'&gt;c&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;register_request_matcher&lt;/span&gt; &lt;span class='ss'&gt;:port&lt;/span&gt; &lt;span class='k'&gt;do&lt;/span&gt; &lt;span class='o'&gt;|&lt;/span&gt;&lt;span class='n'&gt;request_1&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='n'&gt;request_2&lt;/span&gt;&lt;span class='o'&gt;|&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;    &lt;span class='no'&gt;URI&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;request_1&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;uri&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;port&lt;/span&gt; &lt;span class='o'&gt;==&lt;/span&gt; &lt;span class='no'&gt;URI&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;request_2&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;uri&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;port&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='k'&gt;end&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;&lt;span class='k'&gt;end&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;
&lt;/span&gt;&lt;span class='line'&gt;&lt;span class='no'&gt;VCR&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;use_cassette&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='s1'&gt;&amp;#39;example&amp;#39;&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='ss'&gt;:match_requests_on&lt;/span&gt; &lt;span class='o'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='o'&gt;[&lt;/span&gt;&lt;span class='ss'&gt;:method&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='ss'&gt;:port&lt;/span&gt;&lt;span class='o'&gt;]&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt; &lt;span class='k'&gt;do&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='c1'&gt;# make an HTTP request&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;&lt;span class='k'&gt;end&lt;/span&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/figure&gt;&lt;/div&gt;&lt;/notextile&gt;&lt;/div&gt;
&lt;p&gt;In fact, this is exactly how the &lt;a href='https://github.com/myronmarston/vcr/blob/v2.0.0.beta1/lib/vcr/request_matcher_registry.rb#L64-71'&gt;built-in request matchers&lt;/a&gt; (&lt;code&gt;:method&lt;/code&gt;, &lt;code&gt;:uri&lt;/code&gt;, &lt;code&gt;:host&lt;/code&gt;, &lt;code&gt;:path&lt;/code&gt;, &lt;code&gt;:headers&lt;/code&gt; and &lt;code&gt;:body&lt;/code&gt;) work now.&lt;/p&gt;

&lt;p&gt;Finally, for the specific case of URIs with non-deterministic query parameters, VCR provides a simple way to create a request matcher:&lt;/p&gt;
&lt;div class='bogus-wrapper'&gt;&lt;notextile&gt;&lt;div class='code-wrap'&gt;&lt;figure class='code'&gt;&lt;figcaption&gt;&lt;span&gt;uri_without_timestamp.rb &lt;/span&gt;&lt;/figcaption&gt;
 &lt;div class='highlight'&gt;&lt;table&gt;&lt;tr&gt;&lt;td class='gutter'&gt;&lt;pre class='line-numbers'&gt;&lt;span class='line-number'&gt;1&lt;/span&gt;
&lt;span class='line-number'&gt;2&lt;/span&gt;
&lt;span class='line-number'&gt;3&lt;/span&gt;
&lt;span class='line-number'&gt;4&lt;/span&gt;
&lt;span class='line-number'&gt;5&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;td class='code'&gt;&lt;pre&gt;&lt;code class='rb'&gt;&lt;span class='line'&gt;&lt;span class='n'&gt;uri_without_timestamp&lt;/span&gt; &lt;span class='o'&gt;=&lt;/span&gt; &lt;span class='no'&gt;VCR&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;request_matchers&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;uri_without_param&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='ss'&gt;:timestamp&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;&lt;span class='no'&gt;VCR&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;use_cassette&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='s1'&gt;&amp;#39;example&amp;#39;&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='ss'&gt;:match_requests_on&lt;/span&gt; &lt;span class='o'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='o'&gt;[&lt;/span&gt;&lt;span class='ss'&gt;:method&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='n'&gt;uri_without_timestamp&lt;/span&gt;&lt;span class='o'&gt;]&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt; &lt;span class='k'&gt;do&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='c1'&gt;# make an HTTP request with a URI that has a non-determinstic&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='c1'&gt;# timestamp query parameter&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;&lt;span class='k'&gt;end&lt;/span&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/figure&gt;&lt;/div&gt;&lt;/notextile&gt;&lt;/div&gt;
&lt;p&gt;This is only the tip of the iceberg. You can match requests on specific portions of the request body or headers. I can imagine people using this to wrap up the specific set of matchers used for requests to a particular API into a single matcher that simply delegates to the desired matchers&amp;#8211;that way, you can write &lt;code&gt;:match_requests_on =&amp;gt; [:amazon]&lt;/code&gt; rather than &lt;code&gt;:match_requests_on =&amp;gt; [:method, :uri_without_signing, :body]&lt;/code&gt; (or whatever).&lt;/p&gt;

&lt;p&gt;Check out the &lt;a href='https://www.relishapp.com/myronmarston/vcr/v/2-0-0-beta1/docs/request-matching'&gt;relish docs&lt;/a&gt; for fuller examples.&lt;/p&gt;

&lt;p&gt;If you&amp;#8217;ve had problems with how VCR does request matching in the past, or if you think this sounds useful, please give this beta a try. There are a number of other changes, too&amp;#8211;check out the &lt;a href='https://www.relishapp.com/myronmarston/vcr/v/2-0-0-beta1/docs/changelog'&gt;changelog&lt;/a&gt; for the full story.&lt;/p&gt;
&lt;div class='footnotes'&gt;&lt;hr /&gt;&lt;ol&gt;&lt;li id='fn:1'&gt;
&lt;p&gt;Consider that URI stands for &lt;a href='http://en.wikipedia.org/wiki/Uniform_Resource_Identifier'&gt;Uniform Resource Identifier&lt;/a&gt;. Authentication and request signing have nothing to do with identifiying the requested resource. These are orthogonal concerns that should be expressed orthogonally in the HTTP request headers.&lt;/p&gt;
&lt;a href='#fnref:1' rev='footnote'&gt;&amp;#8617;&lt;/a&gt;&lt;/li&gt;&lt;/ol&gt;&lt;/div&gt;</content>
  </entry>
  
  <entry>
    <title>Deprecating Constants (and Classes) in Ruby</title>
    <link href="http://myronmars.to/n/dev-blog/2011/09/deprecating-constants-and-classes-in-ruby"/>
    <updated>2011-09-21T00:00:00-07:00</updated>
    <id>http://myronmars.to/n/dev-blog/2011/09/deprecating-constants-and-classes-in-ruby</id>
    <content type="html">&lt;p&gt;Ruby has great tools for deprecating obselete code. One of my favorite techniques is one I rarely see: using &lt;code&gt;const_missing&lt;/code&gt; to deprecate constants, and, by extension, classes and modules.&lt;/p&gt;

&lt;p&gt;Consider this code:&lt;/p&gt;
&lt;div class='bogus-wrapper'&gt;&lt;notextile&gt;&lt;div class='code-wrap'&gt;&lt;figure class='code'&gt;&lt;figcaption&gt;&lt;span&gt;my_gem/config.rb &lt;/span&gt;&lt;/figcaption&gt;
 &lt;div class='highlight'&gt;&lt;table&gt;&lt;tr&gt;&lt;td class='gutter'&gt;&lt;pre class='line-numbers'&gt;&lt;span class='line-number'&gt;1&lt;/span&gt;
&lt;span class='line-number'&gt;2&lt;/span&gt;
&lt;span class='line-number'&gt;3&lt;/span&gt;
&lt;span class='line-number'&gt;4&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;td class='code'&gt;&lt;pre&gt;&lt;code class='rb'&gt;&lt;span class='line'&gt;&lt;span class='k'&gt;module&lt;/span&gt; &lt;span class='nn'&gt;MyGem&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='k'&gt;class&lt;/span&gt; &lt;span class='nc'&gt;Config&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='k'&gt;end&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;&lt;span class='k'&gt;end&lt;/span&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/figure&gt;&lt;/div&gt;&lt;/notextile&gt;&lt;/div&gt;
&lt;p&gt;At a later time, you decide you would rather name this class &lt;code&gt;MyGem::Configuration&lt;/code&gt;. It&amp;#8217;s easy enough to change the name, but you may break backwards compatiblity with people who have references to &lt;code&gt;MyGem::Config&lt;/code&gt; in their code.&lt;/p&gt;

&lt;p&gt;&lt;code&gt;const_missing&lt;/code&gt; really comes in handy here:&lt;/p&gt;
&lt;div class='bogus-wrapper'&gt;&lt;notextile&gt;&lt;div class='code-wrap'&gt;&lt;figure class='code'&gt;&lt;figcaption&gt;&lt;span&gt;my_gem/configuration.rb &lt;/span&gt;&lt;/figcaption&gt;
 &lt;div class='highlight'&gt;&lt;table&gt;&lt;tr&gt;&lt;td class='gutter'&gt;&lt;pre class='line-numbers'&gt;&lt;span class='line-number'&gt;1&lt;/span&gt;
&lt;span class='line-number'&gt;2&lt;/span&gt;
&lt;span class='line-number'&gt;3&lt;/span&gt;
&lt;span class='line-number'&gt;4&lt;/span&gt;
&lt;span class='line-number'&gt;5&lt;/span&gt;
&lt;span class='line-number'&gt;6&lt;/span&gt;
&lt;span class='line-number'&gt;7&lt;/span&gt;
&lt;span class='line-number'&gt;8&lt;/span&gt;
&lt;span class='line-number'&gt;9&lt;/span&gt;
&lt;span class='line-number'&gt;10&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;td class='code'&gt;&lt;pre&gt;&lt;code class='rb'&gt;&lt;span class='line'&gt;&lt;span class='k'&gt;module&lt;/span&gt; &lt;span class='nn'&gt;MyGem&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='k'&gt;class&lt;/span&gt; &lt;span class='nc'&gt;Configuration&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='k'&gt;end&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='k'&gt;def&lt;/span&gt; &lt;span class='nc'&gt;self&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='nf'&gt;const_missing&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;const_name&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;    &lt;span class='k'&gt;super&lt;/span&gt; &lt;span class='k'&gt;unless&lt;/span&gt; &lt;span class='n'&gt;const_name&lt;/span&gt; &lt;span class='o'&gt;==&lt;/span&gt; &lt;span class='ss'&gt;:Config&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;    &lt;span class='nb'&gt;warn&lt;/span&gt; &lt;span class='s2'&gt;&amp;quot;`MyGem::Config` has been deprecated. Use `MyGem::Configuration` instead.&amp;quot;&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;    &lt;span class='no'&gt;Configuration&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='k'&gt;end&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;&lt;span class='k'&gt;end&lt;/span&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/figure&gt;&lt;/div&gt;&lt;/notextile&gt;&lt;/div&gt;
&lt;p&gt;This allows existing code that references &lt;code&gt;MyGem::Config&lt;/code&gt; to continue to work, and warns the user about their use of the deprecated constant.&lt;/p&gt;</content>
  </entry>
  
  <entry>
    <title>How to Contribute to an Open Source Project</title>
    <link href="http://myronmars.to/n/dev-blog/2011/09/how-to-contribute-to-an-open-source-project"/>
    <updated>2011-09-20T00:00:00-07:00</updated>
    <id>http://myronmars.to/n/dev-blog/2011/09/how-to-contribute-to-an-open-source-project</id>
    <content type="html">&lt;p&gt;&lt;em&gt;Note: I originally posted this on the &lt;a href='http://devblog.seomoz.org/2011/09/how-to-contribute-to-an-open-source-project/'&gt;SEOmoz Dev Blog&lt;/a&gt; yesterday. I&amp;#8217;m posting it here to keep all my writing in one place.&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;I contribute to open source on a fairly regular basis. Besides the fact that I enjoy giving back to the community, it also helps make our applications more maintainable: if I can get the bug fix or new feature I need back into an open source library, rather than maintaining a local modification, it makes future library upgrades far, far easier.&lt;/p&gt;

&lt;p&gt;I commonly hear from other developers that they want to contribute to open source projects but they are unsure how to get started. &lt;a href='http://twitter.com/katemats'&gt;Kate&lt;/a&gt; suggested I distill my experiences of working on open source projects into a bit of a &amp;#8220;how to&amp;#8221; guide for contributing to open source&amp;#8230;so here goes :).&lt;/p&gt;

&lt;p&gt;Virtually all of my open source experience has been with ruby projects on github, so that&amp;#8217;ll be the focus of this blog post. I&amp;#8217;m sure different code communities have different conventions/standards around how to contribute to open source, but these tips should prove useful regardless of what community you are a part of.&lt;/p&gt;

&lt;h2 id='look_for_opportunities_to_contribute'&gt;Look for opportunities to contribute&lt;/h2&gt;

&lt;p&gt;Most open source projects have some kind of bug/issue tracker, and you can certainly look there to find ways to contribute. I don&amp;#8217;t recommend it, though, especially if you&amp;#8217;re contributing to an open source project for the first time. Instead, be on the lookout for pain points with the open source libraries that you use. The next time you are dealing with a bug in some library that you use, consider it an opportunity to give back to the library, rather than working around it in your application. If there is a feature that your application needs that is generically useful, consider adding it directly to the library and contributing that back.&lt;/p&gt;

&lt;p&gt;In general, the best open source contributions come from people who are &lt;em&gt;solving their own problems&lt;/em&gt;. If you&amp;#8217;re not the one who is having the problem, you&amp;#8217;ll have difficulty adequately solving it.&lt;/p&gt;

&lt;p&gt;No contribution is too small. I once spent over an hour trying to figure out why &lt;a href='http://gembundler.com/'&gt;bundler&lt;/a&gt; wasn&amp;#8217;t working on a project. I had a simple Gemfile like this:&lt;/p&gt;
&lt;div class='bogus-wrapper'&gt;&lt;notextile&gt;&lt;div class='code-wrap'&gt;&lt;figure class='code'&gt;&lt;figcaption&gt;&lt;span&gt;Gemfile  &lt;/span&gt;&lt;/figcaption&gt;
 &lt;div class='highlight'&gt;&lt;table&gt;&lt;tr&gt;&lt;td class='gutter'&gt;&lt;pre class='line-numbers'&gt;&lt;span class='line-number'&gt;1&lt;/span&gt;
&lt;span class='line-number'&gt;2&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;td class='code'&gt;&lt;pre&gt;&lt;code class='ruby'&gt;&lt;span class='line'&gt;&lt;span class='n'&gt;source&lt;/span&gt; &lt;span class='ss'&gt;:rubygems&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;&lt;span class='n'&gt;gem&lt;/span&gt; &lt;span class='ss'&gt;:rspec&lt;/span&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/figure&gt;&lt;/div&gt;&lt;/notextile&gt;&lt;/div&gt;
&lt;p&gt;The bundler output confounded me:&lt;/p&gt;
&lt;div class='bogus-wrapper'&gt;&lt;notextile&gt;&lt;div class='code-wrap'&gt;&lt;figure class='code'&gt;&lt;figcaption&gt;&lt;span&gt;Output.sh &lt;/span&gt;&lt;/figcaption&gt;
 &lt;div class='highlight'&gt;&lt;table&gt;&lt;tr&gt;&lt;td class='gutter'&gt;&lt;pre class='line-numbers'&gt;&lt;span class='line-number'&gt;1&lt;/span&gt;
&lt;span class='line-number'&gt;2&lt;/span&gt;
&lt;span class='line-number'&gt;3&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;td class='code'&gt;&lt;pre&gt;&lt;code class='sh'&gt;&lt;span class='line'&gt;&lt;span class='nv'&gt;$ &lt;/span&gt;bundle install
&lt;/span&gt;&lt;span class='line'&gt;Fetching &lt;span class='nb'&gt;source &lt;/span&gt;index &lt;span class='k'&gt;for &lt;/span&gt;http://rubygems.org/
&lt;/span&gt;&lt;span class='line'&gt;Could not find gem &lt;span class='s1'&gt;&amp;#39;rspec (&amp;gt;= 0, runtime)&amp;#39;&lt;/span&gt; in any of the gem sources.
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/figure&gt;&lt;/div&gt;&lt;/notextile&gt;&lt;/div&gt;
&lt;p&gt;I &lt;em&gt;knew&lt;/em&gt; &lt;a href='http://rubygems.org'&gt;rubygems.org&lt;/a&gt; had RSpec in its source index&amp;#8230;and yet bundler was telling me otherwise. After troubleshooting this for an hour, I realized I had specified the gem name using a ruby symbol (i.e. &lt;code&gt;:rspec&lt;/code&gt;) rather than a string (i.e. &lt;code&gt;&amp;quot;rspec&amp;quot;&lt;/code&gt;). Sure enough, when I changed it to a string, it worked.&lt;/p&gt;

&lt;p&gt;My first contribution to bundler was &lt;a href='https://github.com/carlhuda/bundler/commit/5e6b09469afd16719cdc9a0856c6f0da0489f55f'&gt;a simple patch&lt;/a&gt; to provide a more useful error message when gems are specified using symbols. As I said, no contribution is too small.&lt;/p&gt;

&lt;h2 id='setup_your_dev_environment'&gt;Setup your dev environment&lt;/h2&gt;

&lt;p&gt;Now that you&amp;#8217;ve got a an idea of a patch you want to contribute to an open source project, you need to get a proper development environment setup. Most ruby projects have a &amp;#8220;contributing&amp;#8221; or &amp;#8220;hacking&amp;#8221; file that will help get you started. For example, Ryan Tomayko&amp;#8217;s replicate &lt;a href='https://github.com/rtomayko/replicate/blob/1.3/HACKING'&gt;lists instructions&lt;/a&gt; for getting started. For most ruby projects these days, you&amp;#8217;ll just need to fork the project to your github account, &lt;code&gt;git clone&lt;/code&gt; it, run &lt;code&gt;bundle install&lt;/code&gt; to get the dependencies intalled, and run a rake task to run the tests.&lt;/p&gt;

&lt;p&gt;The tests are particularly important on an open source project. They are the primary way the project maintainers communicate to you, the drive-by contributor, how the pieces are supposed to work. With a well-tested project, the tests give you confidence that your changes have not introduced a regression.&lt;/p&gt;

&lt;h2 id='make_your_changes'&gt;Make your changes&lt;/h2&gt;

&lt;p&gt;Now that you have a development environment setup, it&amp;#8217;s time to make your changes. In general, you should follow the conventions that are already present in the project. It&amp;#8217;s not your job as a first-time contributor to do a massive refactoring just because you prefer different conventions. If in doubt about your changes, try to get in touch with the maintainers, over IRC, a mailing list, the issue tracker, or over twitter.&lt;/p&gt;

&lt;p&gt;When I&amp;#8217;m working on fixing an issue in a project, and there are multiple viable solutions, I&amp;#8217;ll often open a ticket describing the issue and possible solutions, to solicit feedback before I make my changes. For example, before making the change to bundler I described above, I &lt;a href='https://github.com/carlhuda/bundler/issues/434'&gt;asked for feedback&lt;/a&gt; from the bundler team about how they wanted bundler to treat symbols.&lt;/p&gt;

&lt;h2 id='ensure_your_changes_are_tested'&gt;Ensure your changes are tested&lt;/h2&gt;

&lt;p&gt;Before submitting your patch, it&amp;#8217;s important that you include test coverage for your change. As I said previously, the tests on an open source project enable contributors to make changes with confidence they aren&amp;#8217;t introducing regressions. If your patch does not include tests, future contributors may inadvertently break your patch, and when they do so, it won&amp;#8217;t be their fault; it&amp;#8217;ll be yours.&lt;/p&gt;

&lt;p&gt;Many projects mention tests as a requirement for contributions, anyway, so your patch will likely not be accepted unless it includes tests.&lt;/p&gt;

&lt;h2 id='prepare_your_patch_to_be_merged'&gt;Prepare your patch to be merged&lt;/h2&gt;

&lt;p&gt;It&amp;#8217;s a good idea to get your patch into an easily mergable form. You want to make it as easy as possible for the project maintainers to merge your patch in. With git, this usually means rebasing commits against the latest commit on the master branch&amp;#8211;that way you have already dealt with any merge conflicts, and it&amp;#8217;s a simple, clean fast-forward for the project maintainers.&lt;/p&gt;

&lt;h2 id='submit_your_patch'&gt;Submit your patch&lt;/h2&gt;

&lt;p&gt;Finally, submit your patch to the project. On github, the preferred way these days is through a pull request. The project maintainer may have further suggestions before accepting your patch. Be sure to follow up on those.&lt;/p&gt;

&lt;p&gt;If you have any additional tips on contributing to open source projects, please let me know in the comments!&lt;/p&gt;</content>
  </entry>
  
  <entry>
    <title>Making your Gem Warning Free</title>
    <link href="http://myronmars.to/n/dev-blog/2011/08/making-your-gem-warning-free"/>
    <updated>2011-08-29T00:00:00-07:00</updated>
    <id>http://myronmars.to/n/dev-blog/2011/08/making-your-gem-warning-free</id>
    <content type="html">&lt;p&gt;There&amp;#8217;s been an &lt;a href='http://avdi.org/devblog/2011/06/23/how-ruby-helps-you-fix-your-broken-code/'&gt;on-going&lt;/a&gt; &lt;a href='http://mislav.uniqpath.com/2011/06/ruby-verbose-mode/'&gt;discussion&lt;/a&gt; in the ruby community recently about warnings. I&amp;#8217;ve never used ruby&amp;#8217;s &lt;code&gt;-w&lt;/code&gt; option much, but I&amp;#8217;m always in favor of more automated tools that can help improve my code. Furthermore, as a gem author, I strive to make my gems play nice with other ruby tools. Some rubyists will never run their code with &lt;code&gt;-w&lt;/code&gt;, but for those who do, I don&amp;#8217;t want my gems to generate warnings for them.&lt;/p&gt;

&lt;p&gt;The primary gem I work on is &lt;a href='http://relishapp.com/myronmarston/vcr'&gt;VCR&lt;/a&gt;, and I decided that it was time to make it warning free.&lt;/p&gt;

&lt;h2 id='initial_configuration'&gt;Initial configuration&lt;/h2&gt;

&lt;p&gt;The rake task included with RSpec provides all the configuration options we need:&lt;/p&gt;
&lt;div class='bogus-wrapper'&gt;&lt;notextile&gt;&lt;div class='code-wrap'&gt;&lt;figure class='code'&gt;&lt;figcaption&gt;&lt;span&gt;Rakefile  &lt;/span&gt;&lt;/figcaption&gt;
 &lt;div class='highlight'&gt;&lt;table&gt;&lt;tr&gt;&lt;td class='gutter'&gt;&lt;pre class='line-numbers'&gt;&lt;span class='line-number'&gt;1&lt;/span&gt;
&lt;span class='line-number'&gt;2&lt;/span&gt;
&lt;span class='line-number'&gt;3&lt;/span&gt;
&lt;span class='line-number'&gt;4&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;td class='code'&gt;&lt;pre&gt;&lt;code class='ruby'&gt;&lt;span class='line'&gt;&lt;span class='no'&gt;RSpec&lt;/span&gt;&lt;span class='o'&gt;::&lt;/span&gt;&lt;span class='no'&gt;Core&lt;/span&gt;&lt;span class='o'&gt;::&lt;/span&gt;&lt;span class='no'&gt;RakeTask&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;new&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='ss'&gt;:spec&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt; &lt;span class='k'&gt;do&lt;/span&gt; &lt;span class='o'&gt;|&lt;/span&gt;&lt;span class='n'&gt;t&lt;/span&gt;&lt;span class='o'&gt;|&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='n'&gt;t&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;ruby_opts&lt;/span&gt; &lt;span class='o'&gt;=&lt;/span&gt; &lt;span class='s2'&gt;&amp;quot;-w&amp;quot;&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='n'&gt;t&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;skip_bundler&lt;/span&gt; &lt;span class='o'&gt;=&lt;/span&gt; &lt;span class='kp'&gt;true&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;&lt;span class='k'&gt;end&lt;/span&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/figure&gt;&lt;/div&gt;&lt;/notextile&gt;&lt;/div&gt;
&lt;p&gt;You&amp;#8217;ll notice I set &lt;code&gt;skip_bundler = true&lt;/code&gt;; when the specs were run with &lt;code&gt;bundle exec&lt;/code&gt;, I discovered that the warnings were silenced. I&amp;#8217;m not sure why, but there&amp;#8217;s an &lt;a href='https://github.com/carlhuda/bundler/issues/969'&gt;open issue&lt;/a&gt; for it, so hopefully it&amp;#8217;ll be fixed at some point. In the meantime, running the specs without &lt;code&gt;bundle exec&lt;/code&gt; works fine since I setup bundler in my &lt;code&gt;spec_helper&lt;/code&gt; file and only have one version of RSpec installed.&lt;/p&gt;

&lt;h2 id='too_many_warnings'&gt;Too many warnings&lt;/h2&gt;

&lt;p&gt;After making this change, when I run my specs, I&amp;#8217;m greeted with over 6500 lines of warnings like these:&lt;/p&gt;
&lt;div class='bogus-wrapper'&gt;&lt;notextile&gt;&lt;div class='code-wrap'&gt;&lt;figure class='code'&gt;&lt;figcaption&gt;&lt;span&gt;warnings.txt  &lt;/span&gt;&lt;/figcaption&gt;
 &lt;div class='highlight'&gt;&lt;table&gt;&lt;tr&gt;&lt;td class='gutter'&gt;&lt;pre class='line-numbers'&gt;&lt;span class='line-number'&gt;1&lt;/span&gt;
&lt;span class='line-number'&gt;2&lt;/span&gt;
&lt;span class='line-number'&gt;3&lt;/span&gt;
&lt;span class='line-number'&gt;4&lt;/span&gt;
&lt;span class='line-number'&gt;5&lt;/span&gt;
&lt;span class='line-number'&gt;6&lt;/span&gt;
&lt;span class='line-number'&gt;7&lt;/span&gt;
&lt;span class='line-number'&gt;8&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;td class='code'&gt;&lt;pre&gt;&lt;code class='sh'&gt;&lt;span class='line'&gt;/Users/myron/code/vcr/lib/vcr.rb:146: warning: instance variable @turned_off not initialized
&lt;/span&gt;&lt;span class='line'&gt;/Users/myron/code/vcr/spec/support/sinatra_app.rb:36: warning: instance variable @_boot_failed not initialized
&lt;/span&gt;&lt;span class='line'&gt;/Users/myron/.rvm/gems/ruby-1.9.2-p290@vcr/gems/excon-0.6.5/lib/excon/connection.rb:46: warning: instance variable @proxy not initialized
&lt;/span&gt;&lt;span class='line'&gt;/Users/myron/.rvm/gems/ruby-1.9.2-p290@vcr/gems/excon-0.6.5/lib/excon/connection.rb:46: warning: instance variable @proxy not initialized
&lt;/span&gt;&lt;span class='line'&gt;/Users/myron/.rvm/gems/ruby-1.9.2-p290@vcr/gems/faraday-0.7.4/lib/faraday/connection.rb:142: warning: instance variable @proxy not initialized
&lt;/span&gt;&lt;span class='line'&gt;/Users/myron/.rvm/gems/ruby-1.9.2-p290@vcr/gems/faraday-0.7.4/lib/faraday/connection.rb:142: warning: instance variable @proxy not initialized
&lt;/span&gt;&lt;span class='line'&gt;/Users/myron/code/vcr/lib/vcr.rb:146: warning: instance variable @turned_off not initialized
&lt;/span&gt;&lt;span class='line'&gt;/Users/myron/.rvm/gems/ruby-1.9.2-p290@vcr/gems/typhoeus-0.2.4/lib/typhoeus/hydra.rb:124: warning: instance variable @cache_getter not initialized
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/figure&gt;&lt;/div&gt;&lt;/notextile&gt;&lt;/div&gt;
&lt;p&gt;&amp;#8230;not exactly the most useful output. It&amp;#8217;s a bit overwhelming, and beyond that, many of the warnings are coming from other libraries.&lt;/p&gt;

&lt;h2 id='my_solution'&gt;My solution&lt;/h2&gt;

&lt;p&gt;What I really wanted is a list of unique warnings coming from VCR. To that end, I came up with a way to filter and format the warnings:&lt;/p&gt;
&lt;div class='bogus-wrapper'&gt;&lt;notextile&gt;&lt;div class='code-wrap'&gt;&lt;figure class='code'&gt;&lt;figcaption&gt;&lt;span&gt;capture_warnings.rb &lt;/span&gt;&lt;/figcaption&gt;
 &lt;div class='highlight'&gt;&lt;table&gt;&lt;tr&gt;&lt;td class='gutter'&gt;&lt;pre class='line-numbers'&gt;&lt;span class='line-number'&gt;1&lt;/span&gt;
&lt;span class='line-number'&gt;2&lt;/span&gt;
&lt;span class='line-number'&gt;3&lt;/span&gt;
&lt;span class='line-number'&gt;4&lt;/span&gt;
&lt;span class='line-number'&gt;5&lt;/span&gt;
&lt;span class='line-number'&gt;6&lt;/span&gt;
&lt;span class='line-number'&gt;7&lt;/span&gt;
&lt;span class='line-number'&gt;8&lt;/span&gt;
&lt;span class='line-number'&gt;9&lt;/span&gt;
&lt;span class='line-number'&gt;10&lt;/span&gt;
&lt;span class='line-number'&gt;11&lt;/span&gt;
&lt;span class='line-number'&gt;12&lt;/span&gt;
&lt;span class='line-number'&gt;13&lt;/span&gt;
&lt;span class='line-number'&gt;14&lt;/span&gt;
&lt;span class='line-number'&gt;15&lt;/span&gt;
&lt;span class='line-number'&gt;16&lt;/span&gt;
&lt;span class='line-number'&gt;17&lt;/span&gt;
&lt;span class='line-number'&gt;18&lt;/span&gt;
&lt;span class='line-number'&gt;19&lt;/span&gt;
&lt;span class='line-number'&gt;20&lt;/span&gt;
&lt;span class='line-number'&gt;21&lt;/span&gt;
&lt;span class='line-number'&gt;22&lt;/span&gt;
&lt;span class='line-number'&gt;23&lt;/span&gt;
&lt;span class='line-number'&gt;24&lt;/span&gt;
&lt;span class='line-number'&gt;25&lt;/span&gt;
&lt;span class='line-number'&gt;26&lt;/span&gt;
&lt;span class='line-number'&gt;27&lt;/span&gt;
&lt;span class='line-number'&gt;28&lt;/span&gt;
&lt;span class='line-number'&gt;29&lt;/span&gt;
&lt;span class='line-number'&gt;30&lt;/span&gt;
&lt;span class='line-number'&gt;31&lt;/span&gt;
&lt;span class='line-number'&gt;32&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;td class='code'&gt;&lt;pre&gt;&lt;code class='rb'&gt;&lt;span class='line'&gt;&lt;span class='nb'&gt;require&lt;/span&gt; &lt;span class='s1'&gt;&amp;#39;tempfile&amp;#39;&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;&lt;span class='n'&gt;stderr_file&lt;/span&gt; &lt;span class='o'&gt;=&lt;/span&gt; &lt;span class='no'&gt;Tempfile&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;new&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='s2'&gt;&amp;quot;vcr.stderr&amp;quot;&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;&lt;span class='vg'&gt;$stderr&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;reopen&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;stderr_file&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;path&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;&lt;span class='n'&gt;current_dir&lt;/span&gt; &lt;span class='o'&gt;=&lt;/span&gt; &lt;span class='no'&gt;Dir&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;pwd&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;
&lt;/span&gt;&lt;span class='line'&gt;&lt;span class='nb'&gt;at_exit&lt;/span&gt; &lt;span class='k'&gt;do&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='n'&gt;stderr_file&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;rewind&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='n'&gt;lines&lt;/span&gt; &lt;span class='o'&gt;=&lt;/span&gt; &lt;span class='n'&gt;stderr_file&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;read&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;split&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='s2'&gt;&amp;quot;&lt;/span&gt;&lt;span class='se'&gt;\n&lt;/span&gt;&lt;span class='s2'&gt;&amp;quot;&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;uniq&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='n'&gt;stderr_file&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;close!&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='n'&gt;vcr_warnings&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='n'&gt;other_warnings&lt;/span&gt; &lt;span class='o'&gt;=&lt;/span&gt; &lt;span class='n'&gt;lines&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;partition&lt;/span&gt; &lt;span class='p'&gt;{&lt;/span&gt; &lt;span class='o'&gt;|&lt;/span&gt;&lt;span class='n'&gt;line&lt;/span&gt;&lt;span class='o'&gt;|&lt;/span&gt; &lt;span class='n'&gt;line&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;include?&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;current_dir&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt; &lt;span class='p'&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='k'&gt;if&lt;/span&gt; &lt;span class='n'&gt;vcr_warnings&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;any?&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;    &lt;span class='nb'&gt;puts&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;    &lt;span class='nb'&gt;puts&lt;/span&gt; &lt;span class='s2'&gt;&amp;quot;-&amp;quot;&lt;/span&gt; &lt;span class='o'&gt;*&lt;/span&gt; &lt;span class='mi'&gt;30&lt;/span&gt; &lt;span class='o'&gt;+&lt;/span&gt; &lt;span class='s2'&gt;&amp;quot; VCR Warnings: &amp;quot;&lt;/span&gt; &lt;span class='o'&gt;+&lt;/span&gt; &lt;span class='s2'&gt;&amp;quot;-&amp;quot;&lt;/span&gt; &lt;span class='o'&gt;*&lt;/span&gt; &lt;span class='mi'&gt;30&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;    &lt;span class='nb'&gt;puts&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;    &lt;span class='nb'&gt;puts&lt;/span&gt; &lt;span class='n'&gt;vcr_warnings&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;join&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='s2'&gt;&amp;quot;&lt;/span&gt;&lt;span class='se'&gt;\n&lt;/span&gt;&lt;span class='s2'&gt;&amp;quot;&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;    &lt;span class='nb'&gt;puts&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;    &lt;span class='nb'&gt;puts&lt;/span&gt; &lt;span class='s2'&gt;&amp;quot;-&amp;quot;&lt;/span&gt; &lt;span class='o'&gt;*&lt;/span&gt; &lt;span class='mi'&gt;75&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;    &lt;span class='nb'&gt;puts&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='k'&gt;end&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='k'&gt;if&lt;/span&gt; &lt;span class='n'&gt;other_warnings&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;any?&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;    &lt;span class='no'&gt;File&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;open&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='s1'&gt;&amp;#39;tmp/warnings.txt&amp;#39;&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='s1'&gt;&amp;#39;w&amp;#39;&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt; &lt;span class='p'&gt;{&lt;/span&gt; &lt;span class='o'&gt;|&lt;/span&gt;&lt;span class='n'&gt;f&lt;/span&gt;&lt;span class='o'&gt;|&lt;/span&gt; &lt;span class='n'&gt;f&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;write&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;other_warnings&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;join&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='s2'&gt;&amp;quot;&lt;/span&gt;&lt;span class='se'&gt;\n&lt;/span&gt;&lt;span class='s2'&gt;&amp;quot;&lt;/span&gt;&lt;span class='p'&gt;))&lt;/span&gt; &lt;span class='p'&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;    &lt;span class='nb'&gt;puts&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;    &lt;span class='nb'&gt;puts&lt;/span&gt; &lt;span class='s2'&gt;&amp;quot;Non-VCR warnings written to tmp/warnings.txt&amp;quot;&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;    &lt;span class='nb'&gt;puts&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='k'&gt;end&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='c1'&gt;# fail the build...&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;  &lt;span class='nb'&gt;exit&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='mi'&gt;1&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt; &lt;span class='k'&gt;if&lt;/span&gt; &lt;span class='n'&gt;vcr_warnings&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;any?&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;&lt;span class='k'&gt;end&lt;/span&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/figure&gt;&lt;/div&gt;&lt;/notextile&gt;&lt;/div&gt;&lt;div class='bogus-wrapper'&gt;&lt;notextile&gt;&lt;div class='code-wrap'&gt;&lt;figure class='code'&gt;&lt;figcaption&gt;&lt;span&gt;Rakefile &lt;/span&gt;&lt;/figcaption&gt;
&lt;div class='highlight'&gt;&lt;table&gt;&lt;tr&gt;&lt;td class='gutter'&gt;&lt;pre class='line-numbers'&gt;&lt;span class='line-number'&gt;1&lt;/span&gt;
&lt;span class='line-number'&gt;2&lt;/span&gt;
&lt;span class='line-number'&gt;3&lt;/span&gt;
&lt;span class='line-number'&gt;4&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;td class='code'&gt;&lt;pre&gt;&lt;code class=''&gt;&lt;span class='line'&gt;RSpec::Core::RakeTask.new(:spec) do |t|
&lt;/span&gt;&lt;span class='line'&gt;  t.ruby_opts = &quot;-w -r./capture_warnings&quot;
&lt;/span&gt;&lt;span class='line'&gt;  t.skip_bundler = true
&lt;/span&gt;&lt;span class='line'&gt;end&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/figure&gt;&lt;/div&gt;&lt;/notextile&gt;&lt;/div&gt;
&lt;p&gt;In a nutshell, here&amp;#8217;s how it works:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;I redirect stderr into a temporary file, since ruby prints warnings to stderr.&lt;/li&gt;

&lt;li&gt;I pass ruby a &lt;code&gt;-r ./capture_warnings.rb&lt;/code&gt; option so that this file gets loaded first and ensures &lt;em&gt;all&lt;/em&gt; warnings get captured.&lt;/li&gt;

&lt;li&gt;In the &lt;code&gt;at_exit&lt;/code&gt; hook, I reformat the output, printing only unique warnings that originate from files under the current directory (which is a good clue that VCR is responsible for them).&lt;/li&gt;

&lt;li&gt;Finally, I exit with a non-zero status if there are any warnings from VCR. This will help me keep VCR warning-free in the future by failing the build and forcing me to remove the warnings.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;This made the output much more useful:&lt;/p&gt;
&lt;div class='bogus-wrapper'&gt;&lt;notextile&gt;&lt;div class='code-wrap'&gt;&lt;figure class='code'&gt;&lt;figcaption&gt;&lt;span&gt;warnings_output.txt  &lt;/span&gt;&lt;/figcaption&gt;
 &lt;div class='highlight'&gt;&lt;table&gt;&lt;tr&gt;&lt;td class='gutter'&gt;&lt;pre class='line-numbers'&gt;&lt;span class='line-number'&gt;1&lt;/span&gt;
&lt;span class='line-number'&gt;2&lt;/span&gt;
&lt;span class='line-number'&gt;3&lt;/span&gt;
&lt;span class='line-number'&gt;4&lt;/span&gt;
&lt;span class='line-number'&gt;5&lt;/span&gt;
&lt;span class='line-number'&gt;6&lt;/span&gt;
&lt;span class='line-number'&gt;7&lt;/span&gt;
&lt;span class='line-number'&gt;8&lt;/span&gt;
&lt;span class='line-number'&gt;9&lt;/span&gt;
&lt;span class='line-number'&gt;10&lt;/span&gt;
&lt;span class='line-number'&gt;11&lt;/span&gt;
&lt;span class='line-number'&gt;12&lt;/span&gt;
&lt;span class='line-number'&gt;13&lt;/span&gt;
&lt;span class='line-number'&gt;14&lt;/span&gt;
&lt;span class='line-number'&gt;15&lt;/span&gt;
&lt;span class='line-number'&gt;16&lt;/span&gt;
&lt;span class='line-number'&gt;17&lt;/span&gt;
&lt;span class='line-number'&gt;18&lt;/span&gt;
&lt;span class='line-number'&gt;19&lt;/span&gt;
&lt;span class='line-number'&gt;20&lt;/span&gt;
&lt;span class='line-number'&gt;21&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;td class='code'&gt;&lt;pre&gt;&lt;code class='diff'&gt;&lt;span class='line'&gt;&lt;span class='gd'&gt;------------------------------ VCR Warnings: ------------------------------&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;
&lt;/span&gt;&lt;span class='line'&gt;/Users/myron/code/vcr/spec/vcr/cassette/reader_spec.rb:24: warning: useless use of == in void context
&lt;/span&gt;&lt;span class='line'&gt;/Users/myron/code/vcr/spec/support/shared_example_groups/ignore_localhost_deprecation.rb:15: warning: `*&amp;#39; interpreted as argument prefix
&lt;/span&gt;&lt;span class='line'&gt;/Users/myron/code/vcr/spec/support/shared_example_groups/normalizers.rb:1: warning: loading in progress, circular require considered harmful - /Users/myron/code/vcr/spec/spec_helper.rb
&lt;/span&gt;&lt;span class='line'&gt;	from /Users/myron/code/vcr/spec/vcr/cassette/reader_spec.rb:1:in `&amp;lt;top (required)&amp;gt;&amp;#39;
&lt;/span&gt;&lt;span class='line'&gt;	from /Users/myron/code/vcr/spec/vcr/cassette/reader_spec.rb:1:in `require&amp;#39;
&lt;/span&gt;&lt;span class='line'&gt;	from /Users/myron/code/vcr/spec/spec_helper.rb:14:in `&amp;lt;top (required)&amp;gt;&amp;#39;
&lt;/span&gt;&lt;span class='line'&gt;	from /Users/myron/code/vcr/spec/spec_helper.rb:14:in `each&amp;#39;
&lt;/span&gt;&lt;span class='line'&gt;	from /Users/myron/code/vcr/spec/spec_helper.rb:14:in `block in &amp;lt;top (required)&amp;gt;&amp;#39;
&lt;/span&gt;&lt;span class='line'&gt;	from /Users/myron/code/vcr/spec/spec_helper.rb:14:in `require&amp;#39;
&lt;/span&gt;&lt;span class='line'&gt;	from /Users/myron/code/vcr/spec/support/shared_example_groups/normalizers.rb:1:in `&amp;lt;top (required)&amp;gt;&amp;#39;
&lt;/span&gt;&lt;span class='line'&gt;	from /Users/myron/code/vcr/spec/support/shared_example_groups/normalizers.rb:1:in `require&amp;#39;
&lt;/span&gt;&lt;span class='line'&gt;/Users/myron/code/vcr/lib/vcr/config.rb:47: warning: `*&amp;#39; interpreted as argument prefix
&lt;/span&gt;&lt;span class='line'&gt;/Users/myron/code/vcr/lib/vcr.rb:146: warning: instance variable @turned_off not initialized
&lt;/span&gt;&lt;span class='line'&gt;/Users/myron/code/vcr/lib/vcr/http_stubbing_adapters/fakeweb.rb:70: warning: instance variable @http_connections_allowed not initialized
&lt;/span&gt;&lt;span class='line'&gt;
&lt;/span&gt;&lt;span class='line'&gt;&lt;span class='gd'&gt;---------------------------------------------------------------------------&lt;/span&gt;
&lt;/span&gt;&lt;span class='line'&gt;
&lt;/span&gt;&lt;span class='line'&gt;
&lt;/span&gt;&lt;span class='line'&gt;Non-VCR warnings written to tmp/warnings.txt
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/figure&gt;&lt;/div&gt;&lt;/notextile&gt;&lt;/div&gt;
&lt;h2 id='my_solution_may_not_be_your_solution'&gt;My solution may not be your solution&lt;/h2&gt;

&lt;p&gt;This is working really well for me, and I just released VCR 1.11.2 yesterday with all warnings fixed. That said, my solution definitely makes a couple assumptions that may not be true of every project:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;It uses a very simple heuristic (&lt;code&gt;line.include?(current_dir)&lt;/code&gt;) to figure out if VCR is responsible for the warning. Does ruby always include the current working directory in the output of every warning that originates from code in your current working directory? That seems to be the case so far but I have no idea if this is true. &lt;sup id='fnref:1'&gt;&lt;a href='#fn:1' rel='footnote'&gt;1&lt;/a&gt;&lt;/sup&gt;&lt;/li&gt;

&lt;li&gt;It assumes that all stderr output is from warnings. This is true for my project but may not be true for yours.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;I&amp;#8217;m curious if others have come up with better or alternate solutions to the problem of isolating the warnings output to just the ones your code is responsible for. Please let me know in the comments!&lt;/p&gt;
&lt;div class='footnotes'&gt;&lt;hr /&gt;&lt;ol&gt;&lt;li id='fn:1'&gt;
&lt;p&gt;Actually, on JRuby, I had the opposite problem: Excon &lt;a href='https://github.com/geemus/excon/blob/v0.6.5/lib/excon/connection.rb#L46'&gt;uses an instance variable before it has been defined&lt;/a&gt;, but JRuby &lt;a href='http://travis-ci.org/#!/myronmarston/vcr/builds/106602'&gt;reported the warning&lt;/a&gt; as originating from one of VCR&amp;#8217;s files. Weird.&lt;/p&gt;
&lt;a href='#fnref:1' rev='footnote'&gt;&amp;#8617;&lt;/a&gt;&lt;/li&gt;&lt;/ol&gt;&lt;/div&gt;</content>
  </entry>
  
  <entry>
    <title>Summer 2007 Travels Part 3: Chengdu</title>
    <link href="http://myronmars.to/n/china/2008/10/summer-2007-travels-part-3-chengdu"/>
    <updated>2008-10-19T00:00:00-07:00</updated>
    <id>http://myronmars.to/n/china/2008/10/summer-2007-travels-part-3-chengdu</id>
    <content type="html">&lt;a href=&quot;/n/china/2008/10/summer-2007-travels-part-2-tiger&quot;&gt;Last time&lt;/a&gt; I posted about our hike at Tiger Leaping Gorge, near &lt;a href=&quot;/n/china/2008/10/summer-2007-travels-part-1-lijiang&quot;&gt;Lijiang&lt;/a&gt;.  After the hike, we flew to Chengdu in Sichuan province.  If you've heard of Chengdu, it's probably because of the massive &lt;a href=&quot;http://en.wikipedia.org/wiki/2008_Sichuan_earthquake&quot;&gt;May 2008 earthquake&lt;/a&gt; that occurred near there and killed about 70,000 people.  &lt;a href=&quot;/n/china/2008/04/shenzhen-chengdu&quot;&gt;I also visited Chengdu again in January 2008&lt;/a&gt;, but I saw the main sites on my first visit to Chengdu during our Summer 2007 travels.&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;&lt;div&gt;
&lt;div style=&quot;text-align: center;&quot;&gt;
&lt;embed type=&quot;application/x-shockwave-flash&quot; src=&quot;http://picasaweb.google.com/s/c/bin/slideshow.swf&quot; width=&quot;400&quot; height=&quot;267&quot; flashvars=&quot;host=picasaweb.google.com&amp;amp;RGB=0x000000&amp;amp;feed=http%3A%2F%2Fpicasaweb.google.com%2Fdata%2Ffeed%2Fapi%2Fuser%2Fmyron.marston%2Falbumid%2F5258653212406235409%3Fkind%3Dphoto%26alt%3Drss&quot; pluginspage=&quot;http://www.macromedia.com/go/getflashplayer&quot;&gt;&lt;/embed&gt;&lt;br&gt;
&lt;/div&gt;
&lt;div&gt;&lt;br&gt;&lt;/div&gt;
&lt;div&gt;We spent our first day in Chengdu exploring town.  We also met up with my friend Dan Lewis, who spent the summer in Chengdu and who I know from his visits to my school as part of the &lt;a href=&quot;http://www.eltedge.org/&quot;&gt;ELT Edge&lt;/a&gt; English Week team.&lt;/div&gt;
&lt;div&gt;&lt;br&gt;&lt;/div&gt;
&lt;br&gt;&lt;br&gt;&lt;div style=&quot;text-align: center;&quot;&gt;&lt;br&gt;&lt;/div&gt;
&lt;div style=&quot;text-align: center;&quot;&gt;
&lt;a href=&quot;http://picasaweb.google.com/lh/photo/qSP0zyYzPD5FR_DvSIURPw&quot;&gt;&lt;img src=&quot;http://lh5.ggpht.com/myron.marston/SPp9P3xL1nI/AAAAAAAACWY/44upUylZG3w/s400/P1050753.JPG&quot;&gt;&lt;/a&gt;&lt;a href=&quot;http://picasaweb.google.com/lh/photo/qSP0zyYzPD5FR_DvSIURPw&quot;&gt;&lt;br&gt;&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;http://picasaweb.google.com/lh/photo/j105iOwGo1GmwBb_Cr0AeA&quot;&gt;&lt;img src=&quot;http://lh3.ggpht.com/myron.marston/SPp9QqUqmFI/AAAAAAAACWg/SDw9xeqDLR8/s400/P1050754.JPG&quot;&gt;&lt;/a&gt;&lt;br&gt;A temple complex near our hostel in Chengdu.  I've forgotten the name now :(.&lt;br&gt;
&lt;/div&gt;
&lt;div style=&quot;text-align: center;&quot;&gt;
&lt;br&gt;&lt;a href=&quot;http://picasaweb.google.com/lh/photo/6pr7SmkM-X0XvKj_sQQ0kQ&quot;&gt;&lt;img src=&quot;http://lh4.ggpht.com/myron.marston/SPp9RLstryI/AAAAAAAACWo/31n5x862hIE/s400/P1050779.JPG&quot;&gt;&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;http://picasaweb.google.com/lh/photo/h7vng3m_JZrJdiE7H0ZM1A&quot;&gt;&lt;img src=&quot;http://lh3.ggpht.com/myron.marston/SPp9SLw81cI/AAAAAAAACWw/MqwpOwkecm8/s400/P1050788.JPG&quot;&gt;&lt;/a&gt;&lt;br&gt;Some Chengdu-ites.   Or some Chengdu-ers.  Or whatever you call people from Chengdu.&lt;br&gt;
&lt;/div&gt;
&lt;div style=&quot;text-align: center;&quot;&gt;
&lt;br&gt;&lt;a href=&quot;http://picasaweb.google.com/lh/photo/HS-A1JWvrvWHkDg6_zEk1A&quot;&gt;&lt;img src=&quot;http://lh5.ggpht.com/myron.marston/SPp9Sl6cmeI/AAAAAAAACW4/9QjHOZxNbiU/s400/P1050790.JPG&quot;&gt;&lt;/a&gt;&lt;br&gt;Virtually every city in China has a big statue of Mao, but I think this one in Chengdu is one of the biggest.&lt;br&gt;
&lt;/div&gt;
&lt;div style=&quot;text-align: center;&quot;&gt;
&lt;br&gt;&lt;a href=&quot;http://picasaweb.google.com/lh/photo/p8rj5R1EL2yUxAwMsGxaHA&quot;&gt;&lt;img src=&quot;http://lh4.ggpht.com/myron.marston/SPp9TQAkyTI/AAAAAAAACXE/g10PpxWQLoI/s400/P1050791.JPG&quot;&gt;&lt;/a&gt;&lt;br&gt;By far the greatest toilet advertisement I've ever seen.&lt;br&gt;
&lt;/div&gt;
&lt;div style=&quot;text-align: center;&quot;&gt;
&lt;br&gt;&lt;a href=&quot;http://picasaweb.google.com/lh/photo/e-xwWxeME4bl2HDRG0XtSg&quot;&gt;&lt;img src=&quot;http://lh6.ggpht.com/myron.marston/SPp9UQuCSAI/AAAAAAAACXM/53DsZO7GN4I/s400/P1050793.JPG&quot;&gt;&lt;/a&gt;&lt;br&gt;This is Dan Lewis, the friend we met up with in Chengdu.  He performed at this restaurant on a regular basis.&lt;br&gt;
&lt;/div&gt;
&lt;div style=&quot;text-align: center;&quot;&gt;&lt;br&gt;&lt;/div&gt;
&lt;div style=&quot;text-align: left;&quot;&gt;Chengdu is famous for its pandas.  Pandas live in a very particular climate, and are probably the pickiest eaters found in the animal kingdom.  They eat a very particular variety of bamboo that primarily grows in Sichuan province, and the majority of wild pandas live in Sichuan.  Chengdu is home to a &lt;a href=&quot;http://en.wikipedia.org/wiki/Chengdu_Research_Base_of_Giant_Panda_Breeding&quot;&gt;panda breeding research center&lt;/a&gt;.  We visited the center on our 2nd day in Chengdu, and one of the things I most remember is this hilarious video talking about panda reproduction at the center.  As &lt;a href=&quot;http://en.wikipedia.org/wiki/Giant_panda#Reproduction&quot;&gt;the wikipedia panda article states&lt;/a&gt;, pandas apparently lose their desire to mate when they are in captivity.  The scientists at the breeding research center have tried things like viagra and panda pr0n (videos of other pandas mating) to get the pandas to mate.  The video talked about this in extremely clinical language...something to the effcct of &quot;the scientists show pandas a motion picture of other pandas displaying amorous behavior&quot;  (I specifically remember the phrase &quot;amorous behavior&quot;, which I thought was pretty awesome).  One of the other really interesting thing about Pandas is their diet.  They eat about 20 pounds of bamboo a day.  Bamboo has very low nutrition, so the panda is eating pretty much anytime its not sleeping (come to think of it, that sounds a bit like how some people live...).  &lt;br&gt;
&lt;/div&gt;
&lt;div style=&quot;text-align: center;&quot;&gt;&lt;br&gt;&lt;/div&gt;
&lt;div style=&quot;text-align: center;&quot;&gt;
&lt;br&gt;&lt;a href=&quot;http://picasaweb.google.com/lh/photo/RFelddJybJrCRIRmnmoiFA&quot;&gt;&lt;img src=&quot;http://lh3.ggpht.com/myron.marston/SPp9ZyA1YxI/AAAAAAAACX8/Q4J4E7JoH20/s400/P1050799.JPG&quot;&gt;&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;http://picasaweb.google.com/lh/photo/Eg6qjwgu68JPRJI6BtfA7Q&quot;&gt;&lt;img src=&quot;http://lh5.ggpht.com/myron.marston/SPp9bcNBi6I/AAAAAAAACYE/kM4q4W1pqAw/s400/P1050808.JPG&quot;&gt;&lt;/a&gt;&lt;br&gt;&quot;Mmmmm...this bamboo tastes good....&quot;&lt;br&gt;
&lt;/div&gt;
&lt;div style=&quot;text-align: center;&quot;&gt;
&lt;br&gt;&lt;a href=&quot;http://picasaweb.google.com/lh/photo/cS8Fxfb0RJvKvnBN9hQS2A&quot;&gt;&lt;img src=&quot;http://lh5.ggpht.com/myron.marston/SPp9cTwZu-I/AAAAAAAACYM/lzZUieUikoE/s400/P1050819.JPG&quot;&gt;&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;http://picasaweb.google.com/lh/photo/oSlDIRPIWR2kzw-Wc-BZUA&quot;&gt;&lt;img src=&quot;http://lh4.ggpht.com/myron.marston/SPp9c14O6II/AAAAAAAACYU/vpDfqR1azaA/s400/P1050814.JPG&quot;&gt;&lt;/a&gt;&lt;br&gt;Pandas apparently enjoy wrestling.  Which explains why the &lt;a href=&quot;http://www.worldwildlife.org/home.html?sc=AWY0900WCG00&amp;amp;searchen=google&amp;amp;gclid=CJeMgZuttJYCFQoHswod2QlvLw&quot;&gt;WWF&lt;/a&gt; symbol is a panda.&lt;br&gt;
&lt;/div&gt;
&lt;div style=&quot;text-align: center;&quot;&gt;
&lt;br&gt;&lt;a href=&quot;http://picasaweb.google.com/lh/photo/umZK2Urs9I86NfoPsCNFkg&quot;&gt;&lt;img src=&quot;http://lh4.ggpht.com/myron.marston/SPp9dniD8zI/AAAAAAAACYc/lHj9Ae2PCXM/s400/P1050811.JPG&quot;&gt;&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;http://picasaweb.google.com/lh/photo/9qeeqiCQm40bsZXjRn5rRg&quot;&gt;&lt;img src=&quot;http://lh3.ggpht.com/myron.marston/SPp9eo_mFPI/AAAAAAAACYk/H5PLnHj-Cr4/s400/P1050828.JPG&quot;&gt;&lt;/a&gt;&lt;br&gt;Red pandas.  They move really fast and were hard to capture on film.&lt;br&gt;
&lt;/div&gt;
&lt;div style=&quot;text-align: center;&quot;&gt;
&lt;br&gt;&lt;a href=&quot;http://picasaweb.google.com/lh/photo/4qNCnIVZpu8SvBDXY6yB3g&quot;&gt;&lt;img src=&quot;http://lh5.ggpht.com/myron.marston/SPp9fqNULPI/AAAAAAAACYw/ls2Fr5BWl-4/s400/P1050829.JPG&quot;&gt;&lt;/a&gt;&lt;br&gt;OK, the gown looks a little fruity, but they made you where it if you wanted to hold the red panda.  I think you can also hold the Giant Pandas at the breeding center, but it costs about ten times as much.&lt;br&gt;
&lt;/div&gt;
&lt;div&gt;
&lt;div&gt;&lt;br&gt;&lt;/div&gt;
&lt;div&gt;After visiting the Panda center in the morning, we visited the &lt;a href=&quot;http://en.wikipedia.org/wiki/Leshan_Giant_Buddha&quot;&gt;Leshan Grand Buddha&lt;/a&gt; in the afternoon.  I was under the impression that it was the biggest Buddha in the world, but after checking &lt;a href=&quot;http://en.wikipedia.org/wiki/List_of_statues_by_height&quot;&gt;the Wikipedia list&lt;/a&gt;, I just learned that it's the 6th biggest.  However, the oldest of the bigger Buddhas was built in 1995, and the Leshan Grand Buddha was completed in 803 AD after 90 years of work...so I still think it's more impressive :).  At 233 feet, it's almost twice as high as the Statue of Liberty.  It's carved directly out of a cliff face.  I wasn't able to get a good picture of the whole thing (you have to pay extra to go on a boat to where you can actually capture the whole thing in one photo), but here's a photo of the whole thing courtesy of Wikipedia:&lt;/div&gt;
&lt;div&gt;
&lt;a href=&quot;http://en.wikipedia.org/wiki/Image:Leshan_Buddha_Statue_View.JPG&quot;&gt;&lt;br&gt;&lt;/a&gt;&lt;div style=&quot;text-align: center;&quot;&gt;
&lt;a href=&quot;http://en.wikipedia.org/wiki/Image:Leshan_Buddha_Statue_View.JPG&quot;&gt;&lt;img src=&quot;http://upload.wikimedia.org/wikipedia/commons/3/38/Leshan_Buddha_Statue_View.JPG&quot; width=&quot;400px&quot; height=&quot;300px&quot;&gt;&lt;/a&gt;&lt;br&gt;
&lt;/div&gt;
&lt;div style=&quot;text-align: center;&quot;&gt;Look how small the people are!&lt;/div&gt;
&lt;div style=&quot;text-align: center;&quot;&gt;&lt;br&gt;&lt;/div&gt;
&lt;div style=&quot;text-align: left;&quot;&gt;Anyhow, here are the photos I took...&lt;/div&gt;
&lt;div style=&quot;text-align: center;&quot;&gt;
&lt;a href=&quot;http://picasaweb.google.com/lh/photo/ME8y05v4iw56xrJqwNWezg&quot;&gt;&lt;img src=&quot;http://lh5.ggpht.com/myron.marston/SPp9VHIi2MI/AAAAAAAACXU/rBZVG8efbVY/s400/P1050843.JPG&quot;&gt;&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;http://picasaweb.google.com/lh/photo/MREaiUfegXtNovJ6o36KBw&quot;&gt;&lt;img src=&quot;http://lh4.ggpht.com/myron.marston/SPp9WPptedI/AAAAAAAACXc/uQv4VHDOcko/s400/P1050849.JPG&quot;&gt;&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;http://picasaweb.google.com/lh/photo/G5XDEd0RR3YUI8vp8ndI4w&quot;&gt;&lt;img src=&quot;http://lh4.ggpht.com/myron.marston/SPp9Ws23eqI/AAAAAAAACXk/Gp9kr90XRmA/s400/P1050853.JPG&quot;&gt;&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;http://picasaweb.google.com/lh/photo/DcwYKkCeGjSxvdBSITzOIw&quot;&gt;&lt;img src=&quot;http://lh5.ggpht.com/myron.marston/SPp9Xwo7sKI/AAAAAAAACXs/O6-beYT-kfM/s400/P1050846.JPG&quot;&gt;&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;http://picasaweb.google.com/lh/photo/Dqw1jwwVRYAT16nI5yrZsw&quot;&gt;&lt;img src=&quot;http://lh3.ggpht.com/myron.marston/SPp9Ym9C8AI/AAAAAAAACX0/lG1ppT18V_I/s400/P1050842.JPG&quot;&gt;&lt;/a&gt;&lt;br&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;br&gt;&lt;br&gt;After our two days in Chengdu, we left in the evening on a sleeper train to Xi'an.  The landscape along the train route the next morning was amazing.  I was feeling particularly lazy and didn't feel like getting out of bed to take pictures, but my cousin Tim took a bunch, and posted them at his blog, so &lt;a href=&quot;http://inkandpaint.blogspot.com/2008/04/china-day-12.html&quot;&gt;check 'em out&lt;/a&gt; if you like awesome landscape photography.  &lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I've been two Xi'an &lt;a href=&quot;/n/china/2007/04/my-winter-travels-part-15-xian&quot;&gt;two&lt;/a&gt; &lt;a href=&quot;/n/china/2008/06/pucheng&quot;&gt;other&lt;/a&gt; times, so check out those posts if you want to read about it.  I won't be posting about it this time (I didn't really even take any photos).  After a day in Xi'an we took another sleeper train to Beijing so that Tim could catch his flight back to Japan, and then Mari flew out a couple days later, and I returned to Seattle for the summer a few days after that.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;That's it for my posts about my Summer 2007 Travels.  I've still got some more stuff to post about Summer 2008 (including the Olympics), so keep reading/subscribing if I haven't lost you yet.&lt;/div&gt;&lt;div class=&quot;blogger-post-footer&quot;&gt;&lt;img width=&quot;1&quot; height=&quot;1&quot; src=&quot;https://blogger.googleusercontent.com/tracker/6401909844167822225-228260918984631015?l=myronmarston.blogspot.com&quot; alt=&quot;&quot;&gt;&lt;/div&gt;</content>
  </entry>
  
  <entry>
    <title>Summer 2007 Travels Part 2: Tiger Leaping Gorge</title>
    <link href="http://myronmars.to/n/china/2008/10/summer-2007-travels-part-2-tiger"/>
    <updated>2008-10-15T00:00:00-07:00</updated>
    <id>http://myronmars.to/n/china/2008/10/summer-2007-travels-part-2-tiger</id>
    <content type="html">&lt;a href=&quot;/n/china/2008/10/summer-2007-travels-part-1-lijiang&quot;&gt;Last time&lt;/a&gt;, I posted about the time Mari, Tim and I spent in Lijiang.  After spending two days there, we went on to &lt;a href=&quot;http://en.wikipedia.org/wiki/Tiger_Leaping_Gorge&quot;&gt;Tiger Leaping Gorge&lt;/a&gt;, one of the deepest gorges in the world.  Wikipedia says it could be considered the world's deepest gorge, depending on the criteria used.  According to &lt;a href=&quot;http://www.tigerleapinggorge.com/where.html&quot;&gt;this site&lt;/a&gt;, the peaks on either side of the gorge are about 19,000 feet high, and the river at the bottom is at about 6,000 feet, so the gorge itself is 13,000 feet from the bottom all the way up to the peaks above it.  Just to give you an idea of high incredibly deep the gorge is, think of Mount Rainier.  It's 14,410 feet, so the gorge is more than 90% of the height of the tallest thing most of us have ever seen.  Or think of the Grand Canyon.  &lt;a href=&quot;http://en.wikipedia.org/wiki/Grand_canyon&quot;&gt;Wikipedia&lt;/a&gt; lists it as being about 6,000 feet at its deepest point, so TLG is more than twice the depth of the Grand Canyon.  I've run out of superlatives to describe the gorge.  And yet, for some reason, virtually no one has heard of TLG, outside of the Chinese and tourists who visit China.  I took tons of pictures (the folder on my computer has more than 160), but it's impossible to capture the grandeur of the gorge on film (or on SD card, as it were).   &lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;The gorge has two main paths.  There is a low road close to the river, where cars can drive, and a high trail, several thousand feet above the road, where you can hike.  We took the high trail and hiked the length of the gorge over the course of two days.  It's easily the most scenic hike I've ever taken in my entire life, and I highly recommend a visit if you ever go to China.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;br&gt;&lt;div style=&quot;text-align: center;&quot;&gt;
&lt;embed type=&quot;application/x-shockwave-flash&quot; src=&quot;http://picasaweb.google.com/s/c/bin/slideshow.swf&quot; width=&quot;400&quot; height=&quot;267&quot; flashvars=&quot;host=picasaweb.google.com&amp;amp;RGB=0x000000&amp;amp;feed=http%3A%2F%2Fpicasaweb.google.com%2Fdata%2Ffeed%2Fapi%2Fuser%2Fmyron.marston%2Falbumid%2F5256311357514957777%3Fkind%3Dphoto%26alt%3Drss&quot; pluginspage=&quot;http://www.macromedia.com/go/getflashplayer&quot;&gt;&lt;/embed&gt;&lt;br&gt;
&lt;/div&gt;&lt;div style=&quot;text-align: center;&quot;&gt;
&lt;br&gt;&lt;a href=&quot;http://picasaweb.google.com/lh/photo/eXdSkeflFk76rB3UZnWIoQ&quot;&gt;&lt;img src=&quot;http://lh4.ggpht.com/myron.marston/SPIraHD5HhI/AAAAAAAACRA/6h7VPRxXC1E/s400/P1050596.JPG&quot;&gt;&lt;/a&gt;
&lt;/div&gt;&lt;div style=&quot;text-align: center;&quot;&gt;The beginning of the gorge.&lt;/div&gt;&lt;div style=&quot;text-align: center;&quot;&gt;
&lt;br&gt;&lt;a href=&quot;http://picasaweb.google.com/lh/photo/bdAmh1DCkMsnzy3h4hoZBw&quot;&gt;&lt;img src=&quot;http://lh4.ggpht.com/myron.marston/SPIrV0QqoYI/AAAAAAAACQQ/sHIu9aGAwvg/s400/P1050581.JPG&quot;&gt;&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;http://picasaweb.google.com/lh/photo/FfOucHBE6KDYXUwDnWBI-Q&quot;&gt;&lt;img src=&quot;http://lh5.ggpht.com/myron.marston/SPIrWRRt-5I/AAAAAAAACQY/NkHg9On8Hjo/s400/P1050582.JPG&quot;&gt;&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;http://picasaweb.google.com/lh/photo/kJ7N_pulRf-oqgiqZM3hMg&quot;&gt;&lt;img src=&quot;http://lh6.ggpht.com/myron.marston/SPIrXvpJxtI/AAAAAAAACQg/0o2OF3lQAG4/s400/P1050583.JPG&quot;&gt;&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;http://picasaweb.google.com/lh/photo/xgJWQMD9dwq44IRMFRT5HA&quot;&gt;&lt;img src=&quot;http://lh4.ggpht.com/myron.marston/SPIrY4h-KaI/AAAAAAAACQw/SoIrGvumRqw/s400/P1050588.JPG&quot;&gt;&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;http://picasaweb.google.com/lh/photo/q5wXQ8QYs9lEXg52UluArw&quot;&gt;&lt;img src=&quot;http://lh3.ggpht.com/myron.marston/SPIrZbZLr0I/AAAAAAAACQ4/QX6DLZd0S3I/s400/P1050589.JPG&quot;&gt;&lt;/a&gt;
&lt;/div&gt;&lt;div style=&quot;text-align: center;&quot;&gt;Takes your breath away, doesn't it?&lt;br&gt;
&lt;/div&gt;&lt;div style=&quot;text-align: center;&quot;&gt;
&lt;br&gt;&lt;a href=&quot;http://picasaweb.google.com/lh/photo/3s2lORhLxSAc1wdcoeqGYQ&quot;&gt;&lt;img src=&quot;http://lh5.ggpht.com/myron.marston/SPIrYAzqN6I/AAAAAAAACQo/Q6FhuCi5lnA/s400/P1050586.JPG&quot;&gt;&lt;/a&gt;&lt;br&gt;There are many Naxi who live and work along the trail.  This woman was engraving a sign.&lt;br&gt;
&lt;/div&gt;&lt;div style=&quot;text-align: center;&quot;&gt;
&lt;br&gt;&lt;a href=&quot;http://picasaweb.google.com/lh/photo/Bzxm764PYoU5ZOizQZAjBQ&quot;&gt;&lt;img src=&quot;http://lh6.ggpht.com/myron.marston/SPIra4gwlwI/AAAAAAAACRI/cOWlxahN_0U/s400/P1050608.JPG&quot;&gt;&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;http://picasaweb.google.com/lh/photo/_cHGfWMGkiky-pFxS--UoQ&quot;&gt;&lt;img src=&quot;http://lh5.ggpht.com/myron.marston/SPIrbmw8OQI/AAAAAAAACRQ/JckuNtzC6rU/s400/P1050610.JPG&quot;&gt;&lt;/a&gt;&lt;br&gt;There are many guest houses along the trail.  This is the first one we passed, where we stopped for lunch the first day.&lt;br&gt;
&lt;/div&gt;&lt;div style=&quot;text-align: center;&quot;&gt;
&lt;br&gt;&lt;a href=&quot;http://picasaweb.google.com/lh/photo/xqRA2f0grEgT3IAjlSMWYA&quot;&gt;&lt;img src=&quot;http://lh4.ggpht.com/myron.marston/SPIrct6Lw5I/AAAAAAAACRY/qP3AHwZe89k/s400/P1050648.JPG&quot;&gt;&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;http://picasaweb.google.com/lh/photo/Af1IK3FuaxcKRFUyDVN8Iw&quot;&gt;&lt;img src=&quot;http://lh5.ggpht.com/myron.marston/SPIrdkTEdbI/AAAAAAAACRk/4r8XtSuyXYM/s400/P1050658.JPG&quot;&gt;&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;http://picasaweb.google.com/lh/photo/jOBOVcErYIWqLwtMqx0V9A&quot;&gt;&lt;img src=&quot;http://lh4.ggpht.com/myron.marston/SPIrelMHL4I/AAAAAAAACRs/KVrsodLtuc0/s400/P1050682.JPG&quot;&gt;&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;http://picasaweb.google.com/lh/photo/D9CNsIoNaP_9QX5EcWHroA&quot;&gt;&lt;img src=&quot;http://lh3.ggpht.com/myron.marston/SPIrgFYMwlI/AAAAAAAACR8/8B3cX-VAu8A/s400/P1050695.JPG&quot;&gt;&lt;/a&gt;&lt;br&gt;More gorge awesomeness.&lt;br&gt;
&lt;/div&gt;&lt;div style=&quot;text-align: center;&quot;&gt;
&lt;br&gt;&lt;a href=&quot;http://picasaweb.google.com/lh/photo/lq5L2lp4Tjih0LR9epVjOw&quot;&gt;&lt;img src=&quot;http://lh3.ggpht.com/myron.marston/SPIrfgKKXXI/AAAAAAAACR0/PDs7ph4zBiQ/s400/P1050690.JPG&quot;&gt;&lt;/a&gt;&lt;br&gt;Periodically along the trail, there would be these signs, letting you know how far to the next guest house.  We wound up staying a night at the Halfway Guest House.  They're not kidding when they advertise a &quot;Scenic Toilet View&quot;, as you'll see shortly.&lt;br&gt;
&lt;/div&gt;&lt;div style=&quot;text-align: center;&quot;&gt;
&lt;br&gt;&lt;a href=&quot;http://picasaweb.google.com/lh/photo/VXXhLJAtCqhTwMXSyUP-Dg&quot;&gt;&lt;img src=&quot;http://lh3.ggpht.com/myron.marston/SPIrgzApTZI/AAAAAAAACSE/1-tLXNYFOfc/s400/P1050702.JPG&quot;&gt;&lt;/a&gt;&lt;br&gt;Tim, sitting on the balcony of the Halfway Guest House as the sun was setting.&lt;br&gt;
&lt;/div&gt;&lt;div style=&quot;text-align: center;&quot;&gt;
&lt;br&gt;&lt;a href=&quot;http://picasaweb.google.com/lh/photo/IGMTD3T4x73tv9FATII2og&quot;&gt;&lt;img src=&quot;http://lh3.ggpht.com/myron.marston/SPIridOTqdI/AAAAAAAACSU/NFcBGNWVDGs/s400/P1050705.JPG&quot;&gt;&lt;/a&gt;&lt;br&gt;This picture didn't turn out so great because there was no way to backup with the wall behind me...but this is the toilet with the scenic view.  The wall only goes up to your waist, and you look right out at the 13,000 foot gorge while you relieve yourself :).&lt;br&gt;
&lt;/div&gt;&lt;div style=&quot;text-align: center;&quot;&gt;
&lt;br&gt;&lt;a href=&quot;http://picasaweb.google.com/lh/photo/LFyaaVTv943vqsVNSBMCtw&quot;&gt;&lt;img src=&quot;http://lh5.ggpht.com/myron.marston/SPIrh3wP4GI/AAAAAAAACSM/NuOL4egbU1Q/s400/P1050703.JPG&quot;&gt;&lt;/a&gt;&lt;br&gt;Sunset over the gorge.&lt;br&gt;
&lt;/div&gt;&lt;div style=&quot;text-align: center;&quot;&gt;
&lt;br&gt;&lt;a href=&quot;http://picasaweb.google.com/lh/photo/OIb8MFM2-i4GhyuiYbTH5g&quot;&gt;&lt;img src=&quot;http://lh5.ggpht.com/myron.marston/SPIri9uT3II/AAAAAAAACSc/PWUBopb59w8/s400/P1050707.JPG&quot;&gt;&lt;/a&gt;&lt;br&gt;Sunrise over the gorge, the next morning.&lt;br&gt;
&lt;/div&gt;&lt;div style=&quot;text-align: center;&quot;&gt;
&lt;br&gt;&lt;a href=&quot;http://picasaweb.google.com/lh/photo/BGHKpXnmmuUu49hJs7VMBA&quot;&gt;&lt;img src=&quot;http://lh5.ggpht.com/myron.marston/SPIrj7UnMgI/AAAAAAAACSk/AljNTRXhlAo/s400/P1050710.JPG&quot;&gt;&lt;/a&gt;&lt;br&gt;This is the Halfway Guest house from further down the trail.&lt;br&gt;
&lt;/div&gt;&lt;div style=&quot;text-align: center;&quot;&gt;
&lt;br&gt;&lt;a href=&quot;http://picasaweb.google.com/lh/photo/ku1YClv1vgMI6SSOv3AuAQ&quot;&gt;&lt;img src=&quot;http://lh4.ggpht.com/myron.marston/SPIrkaJUBWI/AAAAAAAACSs/QmTsE4WSH5I/s400/P1050711.JPG&quot;&gt;&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;http://picasaweb.google.com/lh/photo/M3UmWcvlFeo0TjLDM01fSA&quot;&gt;&lt;img src=&quot;http://lh4.ggpht.com/myron.marston/SPIrlVPc81I/AAAAAAAACS0/BVl27rAMgcM/s400/P1050718.JPG&quot;&gt;&lt;/a&gt;&lt;br&gt;It's not every day that you meet a herd of wild mountain goats on the trail of a 13,0000 foot gorge.&lt;br&gt;
&lt;/div&gt;&lt;div style=&quot;text-align: center;&quot;&gt;
&lt;br&gt;&lt;a href=&quot;http://picasaweb.google.com/lh/photo/vV1ocyNsdyWqbT8wltiQWQ&quot;&gt;&lt;img src=&quot;http://lh4.ggpht.com/myron.marston/SPIrmUxIOAI/AAAAAAAACS8/CDciZWS_-vE/s400/P1050719.JPG&quot;&gt;&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;http://picasaweb.google.com/lh/photo/PXrJ2ab0j4p4uOXCK31K5Q&quot;&gt;&lt;img src=&quot;http://lh3.ggpht.com/myron.marston/SPIrnVfzDAI/AAAAAAAACTE/XS-Sh8IlzYY/s400/P1050722.JPG&quot;&gt;&lt;/a&gt;&lt;br&gt;There were a few waterfalls on the trail.&lt;br&gt;
&lt;/div&gt;&lt;div style=&quot;text-align: center;&quot;&gt;
&lt;br&gt;&lt;a href=&quot;http://picasaweb.google.com/lh/photo/0RhBDVxyLIJb4wBbiFIZ9Q&quot;&gt;&lt;img src=&quot;http://lh4.ggpht.com/myron.marston/SPIroKUtM1I/AAAAAAAACTQ/T7DwUZ2rRNw/s400/P1050726.JPG&quot;&gt;&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;http://picasaweb.google.com/lh/photo/K2oeoc-QA0hIgj8RWNiwSQ&quot;&gt;&lt;img src=&quot;http://lh4.ggpht.com/myron.marston/SPIrov0b7qI/AAAAAAAACTY/VgR1F4ixNOg/s400/P1050730.JPG&quot;&gt;&lt;/a&gt;&lt;br&gt;You can see the road for cars on the right of this picture.&lt;br&gt;
&lt;/div&gt;&lt;div style=&quot;text-align: center;&quot;&gt;
&lt;br&gt;&lt;a href=&quot;http://picasaweb.google.com/lh/photo/c_I5ZuNdHWqAThfarwQ_rQ&quot;&gt;&lt;img src=&quot;http://lh6.ggpht.com/myron.marston/SPIrpupRToI/AAAAAAAACTg/OkALOF5Y2a4/s400/P1050737.JPG&quot;&gt;&lt;/a&gt;&lt;br&gt;Tiger Leaping Gorge is so named because, according to legend, a tiger once leaped across it.  This is the point where the tiger supposedly leaped.&lt;br&gt;
&lt;/div&gt;&lt;div style=&quot;text-align: center;&quot;&gt;
&lt;br&gt;&lt;a href=&quot;http://picasaweb.google.com/lh/photo/Kf1if2buLvOJB_pbR-sIxA&quot;&gt;&lt;img src=&quot;http://lh4.ggpht.com/myron.marston/SPIrqs1XzBI/AAAAAAAACTo/Kw4sN8sJSdo/s400/P1050738.JPG&quot;&gt;&lt;/a&gt;&lt;br&gt;
&lt;/div&gt;&lt;div style=&quot;text-align: center;&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;text-align: left;&quot;&gt;Once we reached the end of the gorge, we caught a taxi back to Lijiang.  From there we flew to Chengdu, which I'll tell you about in my next post.&lt;/div&gt;&lt;div style=&quot;text-align: center;&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div class=&quot;blogger-post-footer&quot;&gt;&lt;img width=&quot;1&quot; height=&quot;1&quot; src=&quot;https://blogger.googleusercontent.com/tracker/6401909844167822225-7332970833364094395?l=myronmarston.blogspot.com&quot; alt=&quot;&quot;&gt;&lt;/div&gt;</content>
  </entry>
  
  <entry>
    <title>Summer 2007 Travels Part 1: Lijiang</title>
    <link href="http://myronmars.to/n/china/2008/10/summer-2007-travels-part-1-lijiang"/>
    <updated>2008-10-12T00:00:00-07:00</updated>
    <id>http://myronmars.to/n/china/2008/10/summer-2007-travels-part-1-lijiang</id>
    <content type="html">When my classes ended after my first year in China (back in June 2007), I stuck around in China to do a bit of traveling before returning to Seattle for the summer.  Two great friends also came to visit and traveled with me--Tim Marston (my cousin) and Mari Becker.  I never got around to blogging about it before, and Tim's been on my case for a long time to post the pictures, so here you are, Tim :).&lt;br&gt;&lt;br&gt;We went to some of my favorite places in China on that trip.  There are so many great pictures to share that I'm going to split this in to multiple posts.  This first will be about our time in Lijiang.&lt;br&gt;&lt;br&gt;&lt;div style=&quot;text-align: center;&quot;&gt;&lt;span class=&quot;Apple-style-span&quot; style=&quot;font-size:x-large;&quot;&gt;Lijiang&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div style=&quot;text-align: center;&quot;&gt;
&lt;embed type=&quot;application/x-shockwave-flash&quot; src=&quot;http://picasaweb.google.com/s/c/bin/slideshow.swf&quot; width=&quot;400&quot; height=&quot;267&quot; flashvars=&quot;host=picasaweb.google.com&amp;amp;RGB=0x000000&amp;amp;feed=http%3A%2F%2Fpicasaweb.google.com%2Fdata%2Ffeed%2Fapi%2Fuser%2Fmyron.marston%2Falbumid%2F5256152932034631345%3Fkind%3Dphoto%26alt%3Drss&quot; pluginspage=&quot;http://www.macromedia.com/go/getflashplayer&quot;&gt;&lt;/embed&gt;&lt;br&gt;
&lt;/div&gt;&lt;br&gt;From Beijing, we flew to Kunming, the capital city of &lt;a href=&quot;http://en.wikipedia.org/wiki/Yunnan&quot;&gt;Yunnan province&lt;/a&gt;, in southwest China.  We stayed there one night and headed straight to Lijiang the next day.  Lijiang is probably my favorite place in all of China.  These pictures don't really adequately capture what was so great about it.  It's this really old city with amazing architecture, canals, bridges and cobbled streets.  It's home to one of China's minority groups, the &lt;a href=&quot;http://en.wikipedia.org/wiki/Naxi&quot;&gt;Naxi&lt;/a&gt; people.  One of the more interesting things about the Naxi is that they have the last surviving written language composed of pictographs (&lt;a href=&quot;http://www.ancientscripts.com/naxi.html&quot;&gt;check this out&lt;/a&gt; for examples).  It looks a bit like Egyptian Hieroglyphics.  &lt;div style=&quot;text-align: center&quot;&gt;
&lt;br&gt;&lt;a href=&quot;http://picasaweb.google.com/lh/photo/mtZRfoRrS8J7ATbE5UAF0w&quot;&gt;&lt;img src=&quot;http://lh4.ggpht.com/myron.marston/SPGbQjRoEII/AAAAAAAACNM/ydcCdwllWrY/s400/P1050483.JPG&quot;&gt;&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;http://picasaweb.google.com/lh/photo/ZFJm4pQmhrsI6o0Y6mP_hw&quot;&gt;&lt;img src=&quot;http://lh5.ggpht.com/myron.marston/SPGbRRHmwHI/AAAAAAAACNU/b2RqzuDuZAQ/s400/P1050485.JPG&quot;&gt;&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;http://picasaweb.google.com/lh/photo/i2N9Yu4j8V7Rl65LWwCZcA&quot;&gt;&lt;img src=&quot;http://lh4.ggpht.com/myron.marston/SPGbSqC4k_I/AAAAAAAACNc/E71t3L4QFwQ/s400/P1050566.JPG&quot;&gt;&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;http://picasaweb.google.com/lh/photo/debszLdp9vAkl8YJbimojg&quot;&gt;&lt;img src=&quot;http://lh5.ggpht.com/myron.marston/SPGbTcx2Z_I/AAAAAAAACNk/wy8Lt2GRt7s/s400/P1050578.JPG&quot;&gt;&lt;/a&gt;&lt;br&gt;
&lt;/div&gt;&lt;div style=&quot;text-align: center&quot;&gt;Lijiang at night&lt;/div&gt;&lt;div style=&quot;text-align: center&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;text-align: center&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;text-align: center&quot;&gt;
&lt;a href=&quot;http://picasaweb.google.com/lh/photo/ZaJaltSMJDUicL33on2Dug&quot;&gt;&lt;img src=&quot;http://lh5.ggpht.com/myron.marston/SPGbUeyyquI/AAAAAAAACNs/JNK4RubbOHI/s400/P1050475.JPG&quot;&gt;&lt;/a&gt;&lt;br&gt;The &lt;a href=&quot;http://en.wikipedia.org/wiki/Dongjing_(music)&quot;&gt;Naxi Orchestra&lt;/a&gt;.  Unfortunately, the picture looks more interesting than the music was :(.&lt;br&gt;
&lt;/div&gt;&lt;div style=&quot;text-align: center&quot;&gt;
&lt;br&gt;&lt;a href=&quot;http://picasaweb.google.com/lh/photo/D6ai-3FxvxsG-hiOtICtFw&quot;&gt;&lt;img src=&quot;http://lh3.ggpht.com/myron.marston/SPGbVXW8rxI/AAAAAAAACN4/PcKTtixPRpA/s400/P1050486.JPG&quot;&gt;&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;http://picasaweb.google.com/lh/photo/PAZshjklNhA7Rh7QG0CS2g&quot;&gt;&lt;img src=&quot;http://lh6.ggpht.com/myron.marston/SPGbWUpDFiI/AAAAAAAACOA/rT7Sx66Un-E/s400/P1050487.JPG&quot;&gt;&lt;/a&gt;&lt;br&gt;Naxi Writing.&lt;br&gt;
&lt;/div&gt;&lt;div style=&quot;text-align: center&quot;&gt;
&lt;br&gt;&lt;a href=&quot;http://picasaweb.google.com/lh/photo/Mg-Mf01wOlJbExEYx4CS2g&quot;&gt;&lt;img src=&quot;http://lh3.ggpht.com/myron.marston/SPGbXHRtWMI/AAAAAAAACOI/x4QFi7aRZI0/s400/P1050491.JPG&quot;&gt;&lt;/a&gt;&lt;br&gt;There were Naxi people everywhere in the city making arts and crafts like this.&lt;br&gt;
&lt;/div&gt;&lt;div style=&quot;text-align: center&quot;&gt;
&lt;br&gt;&lt;a href=&quot;http://picasaweb.google.com/lh/photo/XVB9E5ggRRsmFqSLOmXpaw&quot;&gt;&lt;img src=&quot;http://lh3.ggpht.com/myron.marston/SPGbiD9R5UI/AAAAAAAACPs/w3SaqX5teM0/s400/P1050544.JPG&quot;&gt;&lt;/a&gt;&lt;br&gt;The roof tops of Lijiang.&lt;br&gt;
&lt;/div&gt;&lt;div style=&quot;text-align: center&quot;&gt;
&lt;br&gt;&lt;a href=&quot;http://picasaweb.google.com/lh/photo/DSjXboziLxUn7tvKzrqDDg&quot;&gt;&lt;img src=&quot;http://lh3.ggpht.com/myron.marston/SPGbX-HOObI/AAAAAAAACOQ/lf7dimJWLRk/s400/P1050493.JPG&quot;&gt;&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;http://picasaweb.google.com/lh/photo/G7j0CHSAtrW0Npa3A5nJOg&quot;&gt;&lt;img src=&quot;http://lh5.ggpht.com/myron.marston/SPGbbf-OWlI/AAAAAAAACOo/aI8M8WhPbL8/s400/P1050497.JPG&quot;&gt;&lt;/a&gt;&lt;br&gt;The cobbled streets of Lijiang.&lt;br&gt;
&lt;/div&gt;&lt;div style=&quot;text-align: center&quot;&gt;
&lt;br&gt;&lt;a href=&quot;http://picasaweb.google.com/lh/photo/tyM0kU1v_xAMDcvHxOWU1g&quot;&gt;&lt;img src=&quot;http://lh3.ggpht.com/myron.marston/SPGbgqT_LzI/AAAAAAAACPc/ndCv2u06uqw/s400/P1050539.JPG&quot;&gt;&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;http://picasaweb.google.com/lh/photo/UXaSfbqEjA8-MVQi-OMWug&quot;&gt;&lt;img src=&quot;http://lh4.ggpht.com/myron.marston/SPGbhbS9n6I/AAAAAAAACPk/j5hVAqfuKEE/s400/P1050541.JPG&quot;&gt;&lt;/a&gt;&lt;br&gt;Locals dancing in the city square.&lt;br&gt;
&lt;/div&gt;&lt;div style=&quot;text-align: center&quot;&gt;
&lt;br&gt;&lt;a href=&quot;http://picasaweb.google.com/lh/photo/_fochPh-IknDxtMDNocmlw&quot;&gt;&lt;img src=&quot;http://lh3.ggpht.com/myron.marston/SPGbfmGfMkI/AAAAAAAACPQ/4Dhn_wUBTwI/s400/P1050538.JPG&quot;&gt;&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;http://picasaweb.google.com/lh/photo/TcUOeNNLG7fFn67P_pxDmw&quot;&gt;&lt;img src=&quot;http://lh3.ggpht.com/myron.marston/SPGbYxm6u0I/AAAAAAAACOY/YbFhYcRWPRc/s400/P1050494.JPG&quot;&gt;&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;http://picasaweb.google.com/lh/photo/7TEsj9Y5kYaFm9okJXBArA&quot;&gt;&lt;img src=&quot;http://lh3.ggpht.com/myron.marston/SPGbabeoVLI/AAAAAAAACOg/ThN89UYyPYQ/s400/P1050496.JPG&quot;&gt;&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;http://picasaweb.google.com/lh/photo/TNdEpmPLsI9UBvzQijGYAw&quot;&gt;&lt;img src=&quot;http://lh3.ggpht.com/myron.marston/SPGbi3LC2hI/AAAAAAAACP0/JTgqR_28nVA/s400/P1050563.JPG&quot;&gt;&lt;/a&gt;&lt;br&gt;A few of the canals and bridges in Lijiang.&lt;br&gt;&lt;br&gt;
&lt;/div&gt;&lt;div style=&quot;text-align: center&quot;&gt;
&lt;br&gt;&lt;a href=&quot;http://picasaweb.google.com/lh/photo/7e-OrprPy2nwaaWtf0Ug6A&quot;&gt;&lt;img src=&quot;http://lh6.ggpht.com/myron.marston/SPGbcveiiZI/AAAAAAAACOw/2yJj5Cwm8Ms/s400/P1050500.JPG&quot;&gt;&lt;/a&gt;&lt;br&gt;Tim, Mari and I.&lt;br&gt;
&lt;/div&gt;&lt;div style=&quot;text-align: center&quot;&gt;
&lt;br&gt;&lt;a href=&quot;http://picasaweb.google.com/lh/photo/acQNyR_5wUxuoGvyMH972g&quot;&gt;&lt;img src=&quot;http://lh6.ggpht.com/myron.marston/SPGbdWgrZbI/AAAAAAAACO4/pW_iRlS6TGw/s400/P1050521.JPG&quot;&gt;&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;http://picasaweb.google.com/lh/photo/Cjb8krVBtu2W2k766mfj9Q&quot;&gt;&lt;img src=&quot;http://lh5.ggpht.com/myron.marston/SPGbeDpfRjI/AAAAAAAACPA/5cHUsKiGD_w/s400/P1050525.JPG&quot;&gt;&lt;/a&gt;&lt;br&gt;A nearby park.&lt;br&gt;
&lt;/div&gt;&lt;div style=&quot;text-align: center&quot;&gt;
&lt;br&gt;&lt;a href=&quot;http://picasaweb.google.com/lh/photo/ZqL7vYfVwW_NTZxmh1mc3w&quot;&gt;&lt;img src=&quot;http://lh3.ggpht.com/myron.marston/SPGbe-piZ8I/AAAAAAAACPI/qna_Xo0JUwg/s400/P1050531.JPG&quot;&gt;&lt;/a&gt;&lt;br&gt;Holding a monkey is...more fun than a barrel of monkeys.  Or something.&lt;br&gt;
&lt;/div&gt;&lt;div style=&quot;text-align: center&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;br&gt;&lt;br&gt;After spending 2 days in Lijiang, we headed to the nearby &lt;a href=&quot;http://en.wikipedia.org/wiki/Tiger_Leaping_Gorge&quot;&gt;Tiger Leaping Gorge&lt;/a&gt;, which is one of the deepest gorges in the world.  I'll write about that in the next post.&lt;div class=&quot;blogger-post-footer&quot;&gt;&lt;img width=&quot;1&quot; height=&quot;1&quot; src=&quot;https://blogger.googleusercontent.com/tracker/6401909844167822225-5271433454474042634?l=myronmarston.blogspot.com&quot; alt=&quot;&quot;&gt;&lt;/div&gt;</content>
  </entry>
  
  <entry>
    <title>April 2007 Shandong Trip</title>
    <link href="http://myronmars.to/n/china/2008/09/april-2007-shandong-trip"/>
    <updated>2008-09-20T00:00:00-07:00</updated>
    <id>http://myronmars.to/n/china/2008/09/april-2007-shandong-trip</id>
    <content type="html">Now that I'm mostly settled back in Seattle, I'm going to revisit a couple of my trips in China that I never got around to posting before.  This post is the first of those.&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;One of the three main holidays in China is labor day, which takes place May 1st.  The government shortened it in 2008, but it was previously a full week off work/school.  As you can imagine, there are a lot of people using the transportation system during these holidays.  I had &lt;a href=&quot;/n/china/2006/10/my-national-day-holiday-travels&quot;&gt;previously traveled&lt;/a&gt; with some other teachers from my school during the National Day Holiday, and while we saw some cool stuff, there were huge travel frustrations because of how overcrowded the Chinese transportation system gets when a billion people are all trying to get somewhere.  So, this time we decided to go a week before the break and try to beat the crowds.  Josh (one of the other American teachers at my school) and I tweaked our teaching schedule a bit and headed to nearby &lt;a href=&quot;http://en.wikipedia.org/wiki/Shandong&quot;&gt;Shandong province&lt;/a&gt;.  We went to &lt;a href=&quot;http://en.wikipedia.org/wiki/Mount_Tai&quot;&gt;Tai Shan&lt;/a&gt; (one of China's sacred mountains) first, and then headed to nearby &lt;a href=&quot;http://en.wikipedia.org/wiki/Qufu&quot;&gt;Qufu&lt;/a&gt; (the birthplace of &lt;a href=&quot;http://en.wikipedia.org/wiki/Confucius&quot;&gt;Confucius&lt;/a&gt;).  &lt;/div&gt;&lt;br&gt;&lt;div style=&quot;text-align: center;&quot;&gt;
&lt;br&gt;&lt;span class=&quot;Apple-style-span&quot; style=&quot;font-weight: bold;&quot;&gt;&lt;span class=&quot;Apple-style-span&quot; style=&quot;font-size:x-large;&quot;&gt;Tai Shan&lt;/span&gt;&lt;/span&gt;
&lt;/div&gt;&lt;div style=&quot;text-align: center;&quot;&gt;&lt;span class=&quot;Apple-style-span&quot; style=&quot;font-weight: bold;&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;text-align: center;&quot;&gt;
&lt;embed type=&quot;application/x-shockwave-flash&quot; src=&quot;http://picasaweb.google.com/s/c/bin/slideshow.swf&quot; width=&quot;400&quot; height=&quot;267&quot; flashvars=&quot;host=picasaweb.google.com&amp;amp;RGB=0x000000&amp;amp;feed=http%3A%2F%2Fpicasaweb.google.com%2Fdata%2Ffeed%2Fapi%2Fuser%2Fmyron.marston%2Falbumid%2F5248225136205540353%3Fkind%3Dphoto%26alt%3Drss&quot; pluginspage=&quot;http://www.macromedia.com/go/getflashplayer&quot;&gt;&lt;/embed&gt;&lt;br&gt;
&lt;/div&gt;&lt;div style=&quot;text-align: center;&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;Tai Shan really wasn't anything special.  Of course, both Josh and I had been to &lt;a href=&quot;/n/china/2007/04/my-winter-travels-part-13-huang-shan&quot;&gt;Huang Shan&lt;/a&gt; and &lt;a href=&quot;/n/china/2006/10/my-national-day-holiday-travels&quot;&gt;Chiang Bai Shan&lt;/a&gt;, and it's a bit hard to be impressed after seeing mountains like that.  We didn't even make it all the way to the top.  &lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;
&lt;div style=&quot;text-align: center; &quot;&gt;
&lt;a href=&quot;http://picasaweb.google.com/lh/photo/tyagfdfq0JXi2ihcv6ORVg&quot;&gt;&lt;img src=&quot;http://lh3.ggpht.com/myron.marston/SNVw_IhxnXI/AAAAAAAACHI/1MKs4vDVwWc/s400/P1040501.JPG&quot;&gt;&lt;/a&gt;&lt;a href=&quot;http://picasaweb.google.com/lh/photo/tyagfdfq0JXi2ihcv6ORVg&quot;&gt;&lt;br&gt;&lt;/a&gt;
&lt;/div&gt;
&lt;div style=&quot;text-align: center; &quot;&gt;The streets of Tai'an, the city at the foot of Tai Shan.&lt;/div&gt;
&lt;div style=&quot;text-align: center;&quot;&gt;&lt;br&gt;&lt;/div&gt;
&lt;div&gt;
&lt;div style=&quot;text-align: center; &quot;&gt;
&lt;a href=&quot;http://picasaweb.google.com/lh/photo/a2M13WMwSDd06NOe8_7bHA&quot;&gt;&lt;img src=&quot;http://lh6.ggpht.com/myron.marston/SNVw_53tfkI/AAAAAAAACHQ/psy6GvI39E0/s400/P1040504.JPG&quot;&gt;&lt;/a&gt;&lt;a href=&quot;http://picasaweb.google.com/lh/photo/a2M13WMwSDd06NOe8_7bHA&quot;&gt;&lt;br&gt;&lt;/a&gt;
&lt;/div&gt;
&lt;div style=&quot;text-align: center;&quot;&gt;You've probably heard that everyone rides bikes in China.  Yep, it's true :).&lt;/div&gt;
&lt;div style=&quot;text-align: center;&quot;&gt;&lt;br&gt;&lt;/div&gt;
&lt;div style=&quot;text-align: center;&quot;&gt;&lt;div style=&quot;text-align: center; &quot;&gt;&lt;a href=&quot;http://picasaweb.google.com/lh/photo/bmaZsM4vzW82ymlv6QbaPA&quot;&gt;&lt;img src=&quot;http://lh4.ggpht.com/myron.marston/SNVw-SElBhI/AAAAAAAACHA/tqLO09QWGpI/s400/P1040491.JPG&quot;&gt;&lt;/a&gt;&lt;/div&gt;&lt;/div&gt;
&lt;div style=&quot;text-align: center;&quot;&gt;A registered church in Tai'an.&lt;/div&gt;
&lt;div style=&quot;text-align: center;&quot;&gt;&lt;br&gt;&lt;/div&gt;
&lt;div style=&quot;text-align: center;&quot;&gt;
&lt;a href=&quot;http://picasaweb.google.com/lh/photo/maMMhVMkK783jwQfuvVwZA&quot;&gt;&lt;img src=&quot;http://lh6.ggpht.com/myron.marston/SNVw92lli5I/AAAAAAAACG4/cvLGn7LU1vs/s400/P1040489.JPG&quot;&gt;&lt;/a&gt;&lt;a href=&quot;http://picasaweb.google.com/lh/photo/maMMhVMkK783jwQfuvVwZA&quot;&gt;&lt;br&gt;&lt;/a&gt;
&lt;/div&gt;
&lt;div style=&quot;text-align: center;&quot;&gt;Apartments in Tai'an.&lt;/div&gt;
&lt;div style=&quot;text-align: center;&quot;&gt;&lt;br&gt;&lt;/div&gt;
&lt;div style=&quot;text-align: center;&quot;&gt;
&lt;a href=&quot;http://picasaweb.google.com/lh/photo/fTlb49O2JXvf5GV--SKjug&quot;&gt;&lt;img src=&quot;http://lh3.ggpht.com/myron.marston/SNVxASzsJyI/AAAAAAAACHY/5ADcyfJ1C3A/s400/P1040509.JPG&quot;&gt;&lt;/a&gt;&lt;br&gt;
&lt;/div&gt;
&lt;div style=&quot;text-align: center;&quot;&gt;The bedside stand at the hotel I stayed at.  &quot;Don't smoke&quot;--but we'll give you an ash tray in case you do.  I don't get it...&lt;/div&gt;
&lt;div style=&quot;text-align: center;&quot;&gt;&lt;br&gt;&lt;/div&gt;
&lt;div style=&quot;text-align: center;&quot;&gt;
&lt;a href=&quot;http://picasaweb.google.com/lh/photo/O02Pg4E6yZ6I8lCN__VlOQ&quot;&gt;&lt;img src=&quot;http://lh5.ggpht.com/myron.marston/SNVxAoRt1YI/AAAAAAAACHg/WwH1NIWuzA8/s400/P1040527.JPG&quot;&gt;&lt;/a&gt;&lt;a href=&quot;http://picasaweb.google.com/lh/photo/O02Pg4E6yZ6I8lCN__VlOQ&quot;&gt;&lt;br&gt;&lt;/a&gt;
&lt;/div&gt;
&lt;div style=&quot;text-align: center;&quot;&gt;
&lt;a href=&quot;http://picasaweb.google.com/lh/photo/drQEY88yAueNt05DYeNH_w&quot;&gt;&lt;img src=&quot;http://lh4.ggpht.com/myron.marston/SNVxBskAkhI/AAAAAAAACHw/mdOHT8kYwx4/s400/P1040530.JPG&quot;&gt;&lt;/a&gt;&lt;a href=&quot;http://picasaweb.google.com/lh/photo/drQEY88yAueNt05DYeNH_w&quot;&gt;&lt;br&gt;&lt;/a&gt;
&lt;/div&gt;
&lt;div style=&quot;text-align: center;&quot;&gt;
&lt;a href=&quot;http://picasaweb.google.com/lh/photo/RBA4KmNJoDFqpXFPx_3Xcg&quot;&gt;&lt;img src=&quot;http://lh3.ggpht.com/myron.marston/SNVxCAEJ4CI/AAAAAAAACH4/jOvrG5MKV_8/s400/P1040536.JPG&quot;&gt;&lt;/a&gt;&lt;a href=&quot;http://picasaweb.google.com/lh/photo/RBA4KmNJoDFqpXFPx_3Xcg&quot;&gt;&lt;br&gt;&lt;/a&gt;
&lt;/div&gt;
&lt;div style=&quot;text-align: center;&quot;&gt;Tai Shan.&lt;/div&gt;
&lt;div style=&quot;text-align: center;&quot;&gt;&lt;br&gt;&lt;/div&gt;
&lt;div style=&quot;text-align: center;&quot;&gt;&lt;a href=&quot;http://picasaweb.google.com/lh/photo/STqK85ZkQecJeqc_FuBi0A&quot;&gt;&lt;img src=&quot;http://lh6.ggpht.com/myron.marston/SNVxC6PZv3I/AAAAAAAACIA/B-nKvMQrTxk/s400/P1040540.JPG&quot;&gt;&lt;/a&gt;&lt;/div&gt;
&lt;div style=&quot;text-align: center;&quot;&gt;I've seen rows of locks like this in many places in China, and I'm still not really sure what it means.  I think it's just something the Chinese do at a tourist site, kind of like how westerns throw a coin in a pool.&lt;/div&gt;
&lt;div style=&quot;text-align: center;&quot;&gt;&lt;br&gt;&lt;/div&gt;
&lt;div style=&quot;text-align: center;&quot;&gt;&lt;span class=&quot;Apple-style-span&quot; style=&quot;&quot;&gt;&lt;span class=&quot;Apple-style-span&quot; style=&quot;font-size:x-large;&quot;&gt;Qufu&lt;/span&gt;&lt;/span&gt;&lt;/div&gt;
&lt;div style=&quot;text-align: center;&quot;&gt;
&lt;embed type=&quot;application/x-shockwave-flash&quot; src=&quot;http://picasaweb.google.com/s/c/bin/slideshow.swf&quot; width=&quot;400&quot; height=&quot;267&quot; flashvars=&quot;host=picasaweb.google.com&amp;amp;RGB=0x000000&amp;amp;feed=http%3A%2F%2Fpicasaweb.google.com%2Fdata%2Ffeed%2Fapi%2Fuser%2Fmyron.marston%2Falbumid%2F5248228673579601329%3Fkind%3Dphoto%26alt%3Drss&quot; pluginspage=&quot;http://www.macromedia.com/go/getflashplayer&quot;&gt;&lt;/embed&gt;&lt;br&gt;
&lt;/div&gt;
&lt;div style=&quot;text-align: center;&quot;&gt;&lt;span class=&quot;Apple-style-span&quot; style=&quot; font-weight: bold;font-size:24px;&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;
&lt;div style=&quot;text-align: left;&quot;&gt;&lt;span class=&quot;Apple-style-span&quot; style=&quot;font-size:medium;&quot;&gt;Qufu is the hometown of Confucius, and unlike Tai Shan, it's way cool.  Virtually all of the residents claim to be descendants of Confucius, but 2500 years later, it's probably impossible to trace it back anyway.  The coolest part of Qufu was the cemetary, where Confucius and many of his relatives and descendants are buried.  Josh and I rented bikes to in the cemetary and pedaled around it.  &lt;/span&gt;&lt;/div&gt;
&lt;div style=&quot;text-align: left;&quot;&gt;&lt;br&gt;&lt;/div&gt;
&lt;div style=&quot;text-align: center;&quot;&gt;
&lt;a href=&quot;http://picasaweb.google.com/lh/photo/awxt9JgUO8VP6ZSTMdT3Lg&quot;&gt;&lt;img src=&quot;http://lh5.ggpht.com/myron.marston/SNV0LpExBMI/AAAAAAAACJM/mO6Wf_L__-I/s400/IMG_6998.JPG&quot;&gt;&lt;/a&gt;&lt;br&gt;
&lt;/div&gt;
&lt;div style=&quot;text-align: center;&quot;&gt;The Qufu city wall.&lt;/div&gt;
&lt;div style=&quot;text-align: center;&quot;&gt;&lt;br&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;div style=&quot;text-align: center;&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;text-align: center;&quot;&gt;
&lt;a href=&quot;http://picasaweb.google.com/lh/photo/Qd2vRF10u1jwUBQ-iS51Ow&quot;&gt;&lt;img src=&quot;http://lh5.ggpht.com/myron.marston/SNV0R-WE5QI/AAAAAAAACKM/qfmuNoHcJSA/s400/P1040574.JPG&quot;&gt;&lt;/a&gt;&lt;a href=&quot;http://picasaweb.google.com/lh/photo/Qd2vRF10u1jwUBQ-iS51Ow&quot;&gt;&lt;br&gt;&lt;/a&gt;
&lt;/div&gt;&lt;div style=&quot;text-align: center;&quot;&gt;The cemetary was covered in a carpet of these flowers.  Absolutely gorgeous.&lt;/div&gt;&lt;div style=&quot;text-align: center;&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;text-align: center;&quot;&gt;
&lt;a href=&quot;http://picasaweb.google.com/lh/photo/Ja2PBFUSIgm_EopFzgqvyA&quot;&gt;&lt;img src=&quot;http://lh3.ggpht.com/myron.marston/SNV0NJ4R39I/AAAAAAAACJc/EIMRb_djNRs/s400/IMG_7010.JPG&quot;&gt;&lt;/a&gt;&lt;a href=&quot;http://picasaweb.google.com/lh/photo/Ja2PBFUSIgm_EopFzgqvyA&quot;&gt;&lt;br&gt;&lt;/a&gt;
&lt;/div&gt;&lt;div style=&quot;text-align: center;&quot;&gt;
&lt;a href=&quot;http://picasaweb.google.com/lh/photo/-RMSBzTRuxT5wNX9NhufjQ&quot;&gt;&lt;img src=&quot;http://lh5.ggpht.com/myron.marston/SNV0PETfLRI/AAAAAAAACJs/J9Ko_fP2qVA/s400/IMG_7013.JPG&quot;&gt;&lt;/a&gt;&lt;a href=&quot;http://picasaweb.google.com/lh/photo/-RMSBzTRuxT5wNX9NhufjQ&quot;&gt;&lt;br&gt;&lt;/a&gt;
&lt;/div&gt;&lt;div style=&quot;text-align: center;&quot;&gt;There were stone sculptures throughout the cemetary.&lt;/div&gt;&lt;div style=&quot;text-align: center;&quot;&gt;
&lt;a href=&quot;http://picasaweb.google.com/lh/photo/o4YnreZw2yZRu_5GGnbBWQ&quot;&gt;&lt;img src=&quot;http://lh5.ggpht.com/myron.marston/SNV0N1LQjLI/AAAAAAAACJk/mgpDz0CQ3Ck/s400/IMG_7012.JPG&quot;&gt;&lt;/a&gt;&lt;a href=&quot;http://picasaweb.google.com/lh/photo/o4YnreZw2yZRu_5GGnbBWQ&quot;&gt;&lt;br&gt;&lt;/a&gt;
&lt;/div&gt;&lt;div style=&quot;text-align: center;&quot;&gt;I'm not sure that this was allowed, but no one was around to stop me :).&lt;/div&gt;&lt;div style=&quot;text-align: center;&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;text-align: center;&quot;&gt;
&lt;a href=&quot;http://picasaweb.google.com/lh/photo/YpZHko1sA6sr9XBtHRSdtw&quot;&gt;&lt;img src=&quot;http://lh6.ggpht.com/myron.marston/SNV0PyWx-NI/AAAAAAAACJ0/hhoUXe0jyD0/s400/IMG_7026.JPG&quot;&gt;&lt;/a&gt;&lt;a href=&quot;http://picasaweb.google.com/lh/photo/YpZHko1sA6sr9XBtHRSdtw&quot;&gt;&lt;br&gt;&lt;/a&gt;
&lt;/div&gt;&lt;div style=&quot;text-align: center;&quot;&gt;
&lt;a href=&quot;http://picasaweb.google.com/lh/photo/6fkAkPvMAweUUeNYqYhadg&quot;&gt;&lt;img src=&quot;http://lh5.ggpht.com/myron.marston/SNV0QfNiSnI/AAAAAAAACJ8/bNNsRcA1Vj0/s400/IMG_7028.JPG&quot;&gt;&lt;/a&gt;&lt;a href=&quot;http://picasaweb.google.com/lh/photo/6fkAkPvMAweUUeNYqYhadg&quot;&gt;&lt;br&gt;&lt;/a&gt;
&lt;/div&gt;&lt;div style=&quot;text-align: center;&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;text-align: center;&quot;&gt;
&lt;a href=&quot;http://picasaweb.google.com/lh/photo/nAoYn2_91j4aiObERJuoLA&quot;&gt;&lt;img src=&quot;http://lh4.ggpht.com/myron.marston/SNV0TecN3kI/AAAAAAAACKg/nP9EQQLAi6k/s400/P1040628.JPG&quot;&gt;&lt;/a&gt;&lt;a href=&quot;http://picasaweb.google.com/lh/photo/nAoYn2_91j4aiObERJuoLA&quot;&gt;&lt;br&gt;&lt;/a&gt;
&lt;/div&gt;&lt;div style=&quot;text-align: center;&quot;&gt;The picture didn't come out so well, but this is Confucius' Tomb.  It's 2,500 years old!&lt;/div&gt;&lt;div style=&quot;text-align: center;&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;text-align: center;&quot;&gt;
&lt;a href=&quot;http://picasaweb.google.com/lh/photo/WrySp-8pp5AdlPQZ3HbF4Q&quot;&gt;&lt;img src=&quot;http://lh5.ggpht.com/myron.marston/SNV0UORvAbI/AAAAAAAACKo/NzH7LyOraxA/s400/P1040632.JPG&quot;&gt;&lt;/a&gt;&lt;a href=&quot;http://picasaweb.google.com/lh/photo/WrySp-8pp5AdlPQZ3HbF4Q&quot;&gt;&lt;br&gt;&lt;/a&gt;
&lt;/div&gt;&lt;div style=&quot;text-align: center;&quot;&gt;This is the monument next to the grave that says something like &quot;Confucius is buried here&quot;.&lt;/div&gt;&lt;div style=&quot;text-align: center;&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;text-align: center;&quot;&gt;
&lt;a href=&quot;http://picasaweb.google.com/lh/photo/YV_tN7rJ-ErJX12pfvOGYA&quot;&gt;&lt;img src=&quot;http://lh4.ggpht.com/myron.marston/SNV0U9Ev1yI/AAAAAAAACKw/wRMT87BXW8w/s400/P1040649.JPG&quot;&gt;&lt;/a&gt;&lt;a href=&quot;http://picasaweb.google.com/lh/photo/YV_tN7rJ-ErJX12pfvOGYA&quot;&gt;&lt;br&gt;&lt;/a&gt;
&lt;/div&gt;&lt;div style=&quot;text-align: center;&quot;&gt;
&lt;a href=&quot;http://picasaweb.google.com/lh/photo/ik5mKd4mwxNp6MMN7cAkLw&quot;&gt;&lt;img src=&quot;http://lh6.ggpht.com/myron.marston/SNV0VdOXw9I/AAAAAAAACK4/IRsdRZlnpj4/s400/P1040650.JPG&quot;&gt;&lt;/a&gt;&lt;a href=&quot;http://picasaweb.google.com/lh/photo/ik5mKd4mwxNp6MMN7cAkLw&quot;&gt;&lt;br&gt;&lt;/a&gt;
&lt;/div&gt;&lt;div style=&quot;text-align: center;&quot;&gt;I also went to the Confucius mansion in Qufu.  This is from the gardens there.&lt;/div&gt;&lt;div style=&quot;text-align: center;&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;text-align: center;&quot;&gt;
&lt;a href=&quot;http://picasaweb.google.com/lh/photo/vHNKiW6l8bEgbQQraJ52cg&quot;&gt;&lt;span class=&quot;Apple-style-span&quot; style=&quot;color: rgb(0, 0, 0); &quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;a href=&quot;http://picasaweb.google.com/lh/photo/vHNKiW6l8bEgbQQraJ52cg&quot;&gt;&lt;img src=&quot;http://lh4.ggpht.com/myron.marston/SNV0WB5yUFI/AAAAAAAACLA/X2CU9LKmBXI/s400/P1040651.JPG&quot;&gt;&lt;/a&gt;&lt;br&gt;
&lt;/div&gt;&lt;div style=&quot;text-align: center;&quot;&gt;&lt;span class=&quot;Apple-style-span&quot; style=&quot;text-decoration: underline;&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;text-align: center;&quot;&gt;&lt;span class=&quot;Apple-style-span&quot; style=&quot;text-decoration: underline;&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;blogger-post-footer&quot;&gt;&lt;img width=&quot;1&quot; height=&quot;1&quot; src=&quot;https://blogger.googleusercontent.com/tracker/6401909844167822225-6888878914179966291?l=myronmarston.blogspot.com&quot; alt=&quot;&quot;&gt;&lt;/div&gt;</content>
  </entry>
  
  <entry>
    <title>Life Update</title>
    <link href="http://myronmars.to/n/china/2008/09/life-update"/>
    <updated>2008-09-17T00:00:00-07:00</updated>
    <id>http://myronmars.to/n/china/2008/09/life-update</id>
    <content type="html">I'm back in Seattle, and have been for about a month.  Needless to say, posting on my blog has not been at the top of my list of priorities, amid everything else I've had to do (buy a car, get car insurance, file my taxes, find an apartment, move into the apartment, find a job, etc...).  But, I do intend to post a bit more about China, particularly to post some pictures and stories from a couple trips that I never got around to posting. &lt;br&gt;&lt;br&gt;I started a new job two weeks ago at &lt;a href=&quot;http://www.jobster.com/&quot;&gt;jobster.com&lt;/a&gt;.  So far it's been a great place to work.  Besides the cool people I work with and the great location, I'm a big fan of the Jobster development process.  For the sake of the few of you who will know what I'm talking about, Jobster uses a fairly agile development process (including &lt;a href=&quot;http://en.wikipedia.org/wiki/Test_Driven_Development&quot;&gt;TDD&lt;/a&gt;, which I'm a huge fan of) while not rigidly sticking to it for the sake of the buzzword.  We're a &lt;a href=&quot;http://rubyonrails.com/&quot;&gt;Ruby on Rails&lt;/a&gt; shop, which is a huge contrast from my old job at Consona/Intuitive (where I helped develop a .NET desktop ERP app).  I like using so many open source tools.  And I'm loving the fact that Jobster lets developers use any operating system or tools that they want...so I'm taking the opportunity to switch over to Mac, and I plan on buying a Mac in the not-too-distant future.&lt;br&gt;&lt;br&gt;That's enough for now.  Encourage me to write up and post the rest of the China stuff if you want to read it, as I'm sure that will help motivate me to get it done :).&lt;div class=&quot;blogger-post-footer&quot;&gt;&lt;img width=&quot;1&quot; height=&quot;1&quot; src=&quot;https://blogger.googleusercontent.com/tracker/6401909844167822225-5225532694244300995?l=myronmarston.blogspot.com&quot; alt=&quot;&quot;&gt;&lt;/div&gt;</content>
  </entry>
  
  <entry>
    <title>The Olympics!</title>
    <link href="http://myronmars.to/n/china/2008/08/olympics"/>
    <updated>2008-08-07T00:00:00-07:00</updated>
    <id>http://myronmars.to/n/china/2008/08/olympics</id>
    <content type="html">Well, I'm back in Qinhuangdao from Hong Kong and Taiwan.  My time in Hong Kong and Taiwan was enjoyable, but not very eventful.  I've got more about my time in China that I plan to blog about, but recently I've focused all my computer time on finishing a project that I'll be putting on my resume for when I apply for jobs.  So blogging just isn't a priority right now.&lt;br&gt;&lt;br&gt;The Olympics don't officially start until tomorrow night, but some of the events have already began.  I went to the USA vs. Norway women's soccer game last night.  Unfortunately, we lost 2-0, but it was fun to go.  I'll be going to 3 different events in Beijing before flying home in 6 days!&lt;div class=&quot;blogger-post-footer&quot;&gt;&lt;img width=&quot;1&quot; height=&quot;1&quot; src=&quot;https://blogger.googleusercontent.com/tracker/6401909844167822225-2300520823382743596?l=myronmarston.blogspot.com&quot; alt=&quot;&quot;&gt;&lt;/div&gt;</content>
  </entry>
  
  <entry>
    <title>What's Next?</title>
    <link href="http://myronmars.to/n/china/2008/06/whats-next"/>
    <updated>2008-06-25T00:00:00-07:00</updated>
    <id>http://myronmars.to/n/china/2008/06/whats-next</id>
    <content type="html">Finals just finished last week, and many people are asking me, &quot;what's next?&quot;  I'm not totally sure, but I do know some of what I'll be doing in the near future...&lt;br&gt;&lt;ul&gt;
&lt;li&gt;On July 5th, I head to Hong Kong.  I'll be there about a week.  The main reason I'm going is to get a tourist visa so I can come back to China in August (since my residence permit expires July 15th).&lt;/li&gt;
&lt;li&gt;On July 12th, I fly to Taiwan.  I'm going there to help out with an English camp.&lt;/li&gt;
&lt;li&gt;I'll return to mainland China on August 3rd, just in time for the start of the Olympics.&lt;/li&gt;
&lt;li&gt;I'll be attending several different events during the Olympics: soccer (in Qinhuangdao) and rowing, hockey and handball (in Beijing).&lt;/li&gt;
&lt;li&gt;On August 13th, I fly back to Seattle.&lt;/li&gt;
&lt;/ul&gt;After that, I really have no idea...&lt;br&gt;&lt;br&gt;One cool bit of news I found out today: the tickets I have for the August 6th soccer game is USA vs. Norway.  I bought the tickets several months ago, so I'm lucky I get to see the USA in the one soccer game I'm going to :).&lt;br&gt;&lt;br&gt;Also, there are a few other trips I took the last two years that I haven't had time to blog about yet, but I still intend to, just for the sake of completeness and so that I don't forget.  So check back here in the future for those updates.&lt;div class=&quot;blogger-post-footer&quot;&gt;&lt;img width=&quot;1&quot; height=&quot;1&quot; src=&quot;https://blogger.googleusercontent.com/tracker/6401909844167822225-5562716077142620979?l=myronmarston.blogspot.com&quot; alt=&quot;&quot;&gt;&lt;/div&gt;</content>
  </entry>
  
</feed>

